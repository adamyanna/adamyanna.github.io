<!DOCTYPE html><html lang="en" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Python实现动态生成类的http接口-monitor动态监控项 | TeddyGoodman</title><meta name="generator" content="Jekyll v4.3.1" /><meta property="og:title" content="Python实现动态生成类的http接口-monitor动态监控项" /><meta name="author" content="Teddy" /><meta property="og:locale" content="en_US" /><meta name="description" content="项目背景 采集厂商网络硬件设备基础指标，封装OpenFalcon数据结构 参与开发人数：1人" /><meta property="og:description" content="项目背景 采集厂商网络硬件设备基础指标，封装OpenFalcon数据结构 参与开发人数：1人" /><link rel="canonical" href="http://localhost:4000/posts/Python-dynamic-map/" /><meta property="og:url" content="http://localhost:4000/posts/Python-dynamic-map/" /><meta property="og:site_name" content="TeddyGoodman" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-03-24T10:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Python实现动态生成类的http接口-monitor动态监控项" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@Teddy" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/Python-dynamic-map/"},"url":"http://localhost:4000/posts/Python-dynamic-map/","author":{"@type":"Person","name":"Teddy"},"headline":"Python实现动态生成类的http接口-monitor动态监控项","dateModified":"2020-03-24T10:00:00+08:00","datePublished":"2020-03-24T10:00:00+08:00","description":"项目背景 采集厂商网络硬件设备基础指标，封装OpenFalcon数据结构 参与开发人数：1人","@type":"BlogPosting","@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/main.css"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script> window.jQuery || document.write('<script src="/assets/lib/jquery-3.4.1.min.js"><\/script>'); </script> <script src="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha256-5+02zu5UULQkO7w1GIr6vftCgMfFdZcAHeDtFnKZsBs=" crossorigin="anonymous" async></script> <script src="/assets/js/dist/commons.js" async></script> <script src="/assets/js/dist/timeago.min.js" async></script><link rel="preload" as="style" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/syntax.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/syntax.css"><link rel="preload" as="style" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css"><link rel="preload" as="script" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js"><link rel="stylesheet" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css" /> <script src="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js" async></script> <script src="/assets/js/dist/toc.min.js" async></script> <script src="/assets/js/dist/tooltip-loader.min.js" async></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/avatar/avatar.jpg" alt="avatar"> </a></div><div class="profile-text mt-3"><div id="site-title"> <a href="/">TeddyGoodman</a></div><div id="site-subtitle" class="font-italic">-- Cloud Computing Enginer --</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-3 mr-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-3 mr-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-3 mr-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-3 mr-3 unloaded"></i> <span>ARCHIVES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-3 mr-3 unloaded"></i> <span>ABOUT</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <!-- Switch the mode between dark and light. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/TeddyGoodman" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="javascript:window.open('mailto:' + ['teddyynagoodman','gmail.com'].join('@'))"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" target="_blank"> <i class="fas fa-rss"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Python实现动态生成类的http接口-monitor动态监控项</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Python实现动态生成类的http接口-monitor动态监控项</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago" data-toggle="tooltip" data-placement="bottom" title="Tue, Mar 24, 2020, 10:00 AM +0800"> Mar 24, 2020 <i class="unloaded">2020-03-24T10:00:00+08:00</i> </span> by <span class="author"> Teddy </span></div></div><div class="post-content"><h1 id="项目背景">项目背景</h1><ul><li>采集厂商网络硬件设备基础指标，封装OpenFalcon数据结构</li><li>参与开发人数：1人</li></ul><h1 id="监控系统动态监控">监控系统动态监控</h1><ul><li>需要实现的目标：<ul><li>数据库监控表项动态管理监控项数据处理、封装接口</li><li>新增监控项由对于处理规则处理，项目的新监控项开发只需要编写规则函数和录入监控项字段即可</li></ul></li></ul><h2 id="1-api-处理和报文解析">1. API 处理和报文解析</h2><ul><li>项目启动，导入文件后，解释器会执行 RouteRegister.registerAPI()</li><li>文件路经 <code class="language-plaintext highlighter-rouge">monitor/monitor-server/monitor/api/metric_api/dynamic_router_api.py</code></li></ul><ol><li>从数据库获取动态监控表项的字段</li><li>根据获取回来的字段生成对于HTTP接口和类</li></ol><ul><li>此文件的执行入口是<code class="language-plaintext highlighter-rouge">RouteRegister.registerAPI()</code>，需要关注<ol><li>使用了项目统一实现的 <code class="language-plaintext highlighter-rouge">@get_mapping</code> 装饰器，实现了RESTfulAPI的路经(路由)注册</li><li>因为python的type底层为c结构体，此处使用type函数，实现type的new，call，init方法，返回一个类的引用，且该引用会在装饰器中存储在全局的变量中，内存地址在可分配地址段，“堆”；</li><li>从数据库获取回来的数据保存在每个类的静态变量中</li><li>tornado API 接收socket调用后，会执行process函数</li><li>process函数实现原始数据处理的对象，并将从数据库表项获取的字段做初始化</li><li>调用DynamicMetricDataHandler的对象报文处理函数（此处http接收报文的载荷部分为json format）</li></ol></li><li>cpython source _typeobject <code class="language-plaintext highlighter-rouge">https://github.com/python/cpython/blob/master/Objects/typeobject.c</code><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_typeobject</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">ob_refcnt</span><span class="p">;</span>                        <span class="c1">//引用计数</span>
  <span class="k">struct</span> <span class="n">_typeobject</span> <span class="o">*</span><span class="n">ob_type</span><span class="p">;</span>         <span class="c1">// 类型对象</span>
  <span class="kt">int</span> <span class="n">ob_size</span><span class="p">;</span>                          <span class="c1">//变长对象的长度，如len（list）， len(str), len(dict)，int类型没有该属性</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tp_name</span><span class="p">;</span> <span class="cm">/* For printing, in format "&lt;module&gt;.&lt;name&gt;" */</span>   <span class="c1">// 变量的类型名字 如&lt;class 'int'&gt;    &lt;class 'type'&gt;</span>
  <span class="n">Py_ssize_t</span> <span class="n">tp_basicsize</span><span class="p">,</span> <span class="n">tp_itemsize</span><span class="p">;</span> <span class="cm">/* For allocation */</span>

  <span class="c1">// .......</span>
<span class="p">}</span>
</pre></table></code></div></div></li></ul><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Time     : 2019-10-30 15:32
# @Author   : NAYAN
# @Site     : 
# @File     : snmp_metric_api_v2.py
# @Software : PyCharm
</span>
<span class="s">"""
DES:
    监控项目数据处理入口

    @API
    1. 从数据库t_snmp_task中全量拉取监控项
    2. 根据拉取得数据生成对应的数据上报API
    3. API关联到相应的数据处理函数
"""</span>

<span class="n">MONITOR_ITEM_TB</span> <span class="o">=</span> <span class="s">"t_monitor_item"</span>


<span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">escape</span>
<span class="kn">from</span> <span class="nn">monitor.core.handlers</span> <span class="kn">import</span> <span class="n">get_mapping</span><span class="p">,</span> <span class="n">BaseHandler</span>
<span class="kn">from</span> <span class="nn">monitor.pkg.utils.logger</span> <span class="kn">import</span> <span class="n">LOG</span>
<span class="kn">from</span> <span class="nn">monitor.core.metric.dynamic.dynamic</span> <span class="kn">import</span> <span class="n">DynamicMetricDataHandler</span>
<span class="kn">from</span> <span class="nn">monitor.core.handlers.agent_error_handler</span> <span class="kn">import</span> <span class="n">MetricErrorHandler</span>
<span class="kn">from</span> <span class="nn">monitor.db</span> <span class="kn">import</span> <span class="n">api</span>


<span class="k">class</span> <span class="nc">RouteRegister</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">metric_taks</span> <span class="o">=</span> <span class="p">{</span>

    <span class="p">}</span>

    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">bindRouteToMetircDataHandler</span><span class="p">(</span><span class="n">__route</span><span class="p">,</span> <span class="n">__des</span><span class="p">,</span> <span class="n">monitor_item</span><span class="p">):</span>
        <span class="s">"""

        :param __route:
        :param __des:
        :param monitor_item:
        :return:
        """</span>
        <span class="o">@</span><span class="n">get_mapping</span><span class="p">(</span><span class="n">__route</span><span class="p">,</span> <span class="n">__des</span><span class="p">)</span>
        <span class="k">class</span> <span class="nc">MonitorMetricAPI</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>

            <span class="n">_metric</span> <span class="o">=</span> <span class="s">""</span>

            <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="s">"""

                :return:
                """</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">body</span>
                    <span class="n">content_type</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">content_type</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'application/json'</span><span class="p">):</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">escape</span><span class="p">.</span><span class="n">json_decode</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dynamic</span><span class="o">=</span> <span class="n">DynamicMetricDataHandler</span><span class="p">(</span><span class="n">monitor_item</span><span class="o">=</span><span class="n">MonitorMetricAPI</span><span class="p">.</span><span class="n">_metric</span><span class="p">)</span>
                            <span class="n">did_send_metric</span> <span class="o">=</span> <span class="n">dynamic</span><span class="p">.</span><span class="n">handler_distributor</span><span class="p">(</span><span class="n">metric_raw</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">did_send_metric</span><span class="p">:</span>
                                <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'success'</span><span class="p">,</span> <span class="p">{}</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'failed'</span><span class="p">,</span> <span class="p">{}</span>
                        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">"Dynamic metric data handler bind filed! error=%s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">))</span>
                            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'failed'</span><span class="p">,</span> <span class="p">{}</span>
                <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'failed'</span><span class="p">,</span> <span class="p">{</span><span class="s">"Message"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">monitor_item</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">MonitorMetricAPI</span><span class="p">.</span><span class="n">_metric</span> <span class="o">=</span> <span class="n">monitor_item</span>
        <span class="n">new_class_name</span> <span class="o">=</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">__route</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"/"</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">"_"</span><span class="p">)])</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_class_name</span><span class="p">,</span> <span class="p">(</span><span class="n">MonitorMetricAPI</span><span class="p">,),</span> <span class="p">{})</span>

    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">registerAPI</span><span class="p">():</span>
        <span class="n">raw_tasks</span> <span class="o">=</span> <span class="n">RouteRegister</span><span class="p">.</span><span class="n">loadAllAPIFromInventory</span><span class="p">()</span>
        <span class="n">LOG</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"[Register Monitor Item API From DB...]"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">raw</span> <span class="ow">in</span> <span class="n">raw_tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">raw</span> <span class="ow">and</span> <span class="n">raw</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'OpenFalcon_upload'</span><span class="p">):</span> <span class="c1">#
</span>                <span class="n">__route</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="s">"upload_api"</span><span class="p">])</span>
                <span class="n">__des</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="s">"desc"</span><span class="p">])</span>
                <span class="n">LOG</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"[Upload API]: %s"</span> <span class="o">%</span> <span class="n">__route</span><span class="p">)</span>
                <span class="n">RouteRegister</span><span class="p">.</span><span class="n">bindRouteToMetircDataHandler</span><span class="p">(</span><span class="n">__route</span><span class="p">,</span> <span class="n">__des</span><span class="p">,</span> <span class="n">raw</span><span class="p">)</span>

    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">loadAllAPIFromInventory</span><span class="p">():</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">api</span><span class="p">.</span><span class="n">pg_query</span><span class="p">(</span><span class="n">MONITOR_ITEM_TB</span><span class="p">)</span>
        <span class="n">LOG</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"[ITEM DATA] %s"</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>


<span class="o">@</span><span class="n">get_mapping</span><span class="p">(</span><span class="s">'/monitor_upload/metric_error_handler.do'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ErrorHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">body</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">content_type</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'application/json'</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">escape</span><span class="p">.</span><span class="n">json_decode</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">MetricErrorHandler</span><span class="p">.</span><span class="n">process_metric_error</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'success'</span><span class="p">,</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="s">'failed'</span><span class="p">,</span> <span class="p">{</span><span class="s">"Message"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

<span class="n">RouteRegister</span><span class="p">.</span><span class="n">registerAPI</span><span class="p">()</span>

</pre></table></code></div></div><h2 id="2-规则映射数据处理">2. 规则映射数据处理</h2><ul><li>实现了对不同类型规则的处理逻辑；<ol><li>单OID处理：一个OID为采集对象，采集结果为单一类型数据，例如整型、浮点类型、字符、字符串、数组</li><li>多OID处理：一个OID为采集对象，采集结果为多行数据，数据类型一致，例如带索引的分组交换机接口或硬件端口</li><li>多OID多处理：多个OID为采集对象，采集结果可能为每个OID一个单一结果，或者每个OID多个结果，具体规则函数会对这样的报文做处理；</li></ol></li></ul><h3 id="动态监控项表的字段结构">动态监控项表的字段结构</h3>><code class="language-pgsql">+-------------+---------------------+------+-----+---------+---------------------------------+ | Field | Type | Null | Key | description | +-------------+---------------------+------+-----+---------+---------------------------------+ | id | varchar | NO | PRI | 主键，唯一监控项名称，包含小写字母和下划线 | | vendor | varchar | NO | | 厂商 | | type | varchar | NO | | 设备类型 （链路交换机，路由器，防火墙） | | model | jsonb | YES | | 设备型号 厂商定义 | | series | jsonb | YES | | 设备系列 厂商定义 | | metric | varchar | NO | | 采集数据名称，元数据描述 | | metric_type | int4 | NO | | 采集数据类型（处理） 0表示普通数据，1表示增量数据 | | upload_api | varchar | NO | | 原始数据上报RESTful接口 | | task | jsonb | NO | | agent端执行的采集任务定义 | | desc | varchar | YES | | 描述 | | OpenFalcon_upload| bool | NO | | 是否将数据发送到 OpenFalcon 平台 | | update_time | timestamp | NO | | 记录更新时间 | | interval | int4 | YES | | agent执行采集的时间间隔 | +-------------+---------------------+------+-----+---------+---------------------------------+ </code><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Time     : 2019-10-31 14:57
# @Author   : NAYAN
# @Site     : 
# @File     : dynamic.py
# @Software : PyCharm
</span>
<span class="s">"""
动态监控项处理
    1. 从数据库t_monitor_item表拉取监控项
    2. 由监控项生成API和监控处理对象(class)
    3. 监控处理对象将调用相应的动态处理函数
    4. 动态处理函数会根据 task_operation 判断数据处理函数的类型，包括单数据处理，批量数据处理，表达式处理三种
    5. 监控数据部分会有两个处理函数，第一个是tags的配置，第二个是value的处理


"""</span>

<span class="kn">from</span> <span class="nn">monitor.core.handlers.device_info_handler</span> <span class="kn">import</span> <span class="n">DeviceInfo</span>
<span class="kn">from</span> <span class="nn">monitor.pkg.utils.import_util</span> <span class="kn">import</span> <span class="n">LOG</span>
<span class="kn">from</span> <span class="nn">monitor.core.model.monitor_data_model</span> <span class="kn">import</span> <span class="n">MonitorItemDataModel</span>
<span class="kn">from</span> <span class="nn">monitor.core.model</span> <span class="kn">import</span> <span class="n">monitor_data_model</span> <span class="k">as</span> <span class="n">DModle</span>
<span class="kn">from</span> <span class="nn">monitor.core.metric.dynamic.dynamic_rules</span> <span class="kn">import</span> <span class="n">ValueRules</span>
<span class="kn">from</span> <span class="nn">monitor.core.metric.dynamic.dynamic_rules</span> <span class="kn">import</span> <span class="n">TagRules</span>
<span class="kn">from</span> <span class="nn">monitor.core.metric.dynamic.dynamic_rules</span> <span class="kn">import</span> <span class="n">OperationRules</span>
<span class="kn">from</span> <span class="nn">monitor.core.metric.publisher</span> <span class="kn">import</span> <span class="n">Falcon</span>

<span class="n">LogPrefix</span> <span class="o">=</span> <span class="s">"[Dynamic Monitor]"</span>
<span class="n">DefaultValue</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<span class="n">Metric_Value_Type</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s">"int"</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">:</span> <span class="s">"float"</span><span class="p">,</span>
    <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="s">"counter"</span>
<span class="p">}</span>

<span class="n">Metric_Type</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s">"GAUGE"</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">:</span> <span class="s">"GAUGE"</span><span class="p">,</span>
    <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="s">"COUNTER"</span>
<span class="p">}</span>


<span class="k">class</span> <span class="nc">DynamicMetricDataHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s">"""
    @metric_item
        监控项数据结构，用来生成监控项上报API和处理函数

    @metric_raw
        Agent上报的原始监控数据
    """</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monitor_item</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""

        :param monitor_item:
        """</span>

        <span class="n">mon_object</span> <span class="o">=</span> <span class="n">MonitorItemDataModel</span><span class="p">(</span><span class="o">**</span><span class="n">monitor_item</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">_mon_object</span> <span class="o">=</span> <span class="n">mon_object</span>  <span class="c1"># @监控对象
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_vendor</span> <span class="o">=</span> <span class="n">mon_object</span><span class="p">.</span><span class="n">vendor</span>  <span class="c1"># @设备厂商
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">mon_object</span><span class="p">.</span><span class="nb">type</span>  <span class="c1"># @设备类型
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">mon_object</span><span class="p">.</span><span class="n">model</span>  <span class="c1"># @设备型号
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_series</span> <span class="o">=</span> <span class="n">mon_object</span><span class="p">.</span><span class="n">series</span>  <span class="c1"># @设备型号所属系列
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_metric</span> <span class="o">=</span> <span class="n">mon_object</span><span class="p">.</span><span class="n">metric</span>  <span class="c1"># @监控项名称m
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_metric_type</span> <span class="o">=</span> <span class="n">mon_object</span><span class="p">.</span><span class="n">metric_type</span>  <span class="c1"># @是否计数器
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_upload_api</span> <span class="o">=</span> <span class="n">mon_object</span><span class="p">.</span><span class="n">upload_api</span>  <span class="c1"># @上报接口
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_OpenFalcon_upload</span> <span class="o">=</span> <span class="n">mon_object</span><span class="p">.</span><span class="n">OpenFalcon_upload</span>  <span class="c1"># @是否上报OpenFalcon
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_des</span> <span class="o">=</span> <span class="n">mon_object</span><span class="p">.</span><span class="n">description</span>  <span class="c1"># @监控项描述
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_task</span> <span class="o">=</span> <span class="n">mon_object</span><span class="p">.</span><span class="n">task</span>  <span class="c1"># @监控项对应监控任务
</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">manage_ip</span> <span class="o">=</span> <span class="n">DModle</span><span class="p">.</span><span class="n">DEFAULT_STRING</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">DModle</span><span class="p">.</span><span class="n">DEFAULT_JSON_DIC</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">DModle</span><span class="p">.</span><span class="n">DEFAULT_INTEGER</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">sysname</span> <span class="o">=</span> <span class="n">DModle</span><span class="p">.</span><span class="n">DEFAULT_STRING</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">DModle</span><span class="p">.</span><span class="n">DEFAULT_INTEGER</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">oid_data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_parse_metric_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_raw</span><span class="p">):</span>
        <span class="s">"""
        @@@ Handle Agent upload original DATA
        :param metric_raw:
        @example:
        {
            "content": null,
            "host": null,
            "protocol": null,
            "scheduler": null,
            "timestamp": 1572574430,
            "company": null,
            "interval": null,
            "id": null,
            "response": {
                "get": {
                    "1.3.6.1.4.1.2636.3.1.13.1.8.9.1.0.0": {
                        "oid_index": "",
                        "oid": "enterprises.2636.3.1.13.1.8.9.1.0.0",
                        "snmp_type": "GAUGE",
                        "value": "1"
                    }
                }
            }
        }

        @@ Agent采集数据结构
            "content":  @采集job内容
            "host":     @采集对象管理ip
            "protocol": @采集使用的网络协议
            "scheduler": @采集是否为周期interval || once
            "timestamp": @采集数据的时间戳
            "company":   @采集设备的厂商
            "interval":  @采集的时间间隔
            "id":        @采集任务的唯一ID
        :return:
        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">_metric</span><span class="p">:</span>  <span class="c1">##TODO Value Check and LOG IT!!!!!!!!!!!!!!!!!!!!!!!!
</span>                <span class="n">LOG</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">"%s metric item data parse failed, error="</span> <span class="o">%</span> <span class="n">LogPrefix</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_raw</span><span class="p">:</span>
                <span class="n">LOG</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">"%s metric raw parse failed, error="</span> <span class="o">%</span> <span class="n">LogPrefix</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="p">.</span><span class="n">manage_ip</span> <span class="o">=</span> <span class="n">metric_raw</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"host"</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">metric_raw</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"response"</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">metric_raw</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"timestamp"</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">metric_raw</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"interval"</span><span class="p">))</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">sysname</span> <span class="o">=</span> <span class="n">DeviceInfo</span><span class="p">.</span><span class="n">devs</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">manage_ip</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="s">'sysname'</span><span class="p">)</span>
            <span class="c1"># self.sysname = "abcd"
</span>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">sysname</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">"get sysname failed!"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOG</span><span class="p">.</span><span class="n">exception</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_error_handler</span><span class="p">(</span><span class="n">err_des</span><span class="o">=</span><span class="s">"parse raw metric error"</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_error_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_des</span><span class="o">=</span><span class="s">""</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""
        @@@ Error handler
        :param e:
        :return: Error msg
        # LOG.error(self._error_handler(err_des="", exp=e))
        """</span>
        <span class="n">e_msg</span> <span class="o">=</span> <span class="s">'%s monitor item data process error, device=[ip=%s, sysname=%s, vendor=%s, type=%s, model=%s, series=%s, metric=%s], err_msg=%s, exp=%s'</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">LogPrefix</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">manage_ip</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">sysname</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">_vendor</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">_type</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">_model</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">_series</span><span class="p">,</span>
                   <span class="bp">self</span><span class="p">.</span><span class="n">_metric</span><span class="p">,</span> <span class="n">err_des</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">e_msg</span>

    <span class="k">def</span> <span class="nf">_is_value_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="s">"""
        @@@ SNMP error handler
            @TIMEOUT
            @UNKNOWN
            @NO_SUCH_INSTANCE
            @UNDETERMINED_TYPE_ERROR
            @Connection_Error
            @Undetermined_Type_Error
        :param value:
        :return:
        """</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">True</span>
            <span class="c1"># TODO check snmp error value   TIMEOUT   UNKNOWN OBJECTID  NO_SUCH_INSTANCE   NO_SUCH_OBJECTID
</span>            <span class="c1"># except EasySNMPTimeoutError:
</span>            <span class="c1"># LOG.error("%s request snmp error TIMEOUT.oid=%s" % (self.hostname, oids))
</span>            <span class="c1"># except EasySNMPUnknownObjectIDError:
</span>            <span class="c1"># LOG.error("%s request snmp error UNKNOWN OBJECTID.oid=%s" % (self.hostname, oids))
</span>            <span class="c1">#
</span>            <span class="c1"># except (EasySNMPNoSuchObjectError, EasySNMPNoSuchInstanceError):
</span>            <span class="c1"># LOG.error("%s request snmp error NO_SUCH_INSTANCE OR NO_SUCH_OBJECTID.oid=%s" % (self.hostname, oids))
</span>            <span class="c1">#
</span>            <span class="c1"># except EasySNMPUndeterminedTypeError:
</span>            <span class="c1"># LOG.error("%s request snmp error UNDETERMINED_TYPE_ERROR.oid=%s" % (self.hostname, oids))
</span>            <span class="c1"># except EasySNMPConnectionError:
</span>            <span class="c1"># LOG.error("%s request snmp error Connection_Error.oid=%s" % (self.hostname, oids))
</span>            <span class="c1"># except EasySNMPUndeterminedTypeError:
</span>            <span class="c1"># LOG.error("%s request snmp error Undetermined_Type_Error.oid=%s" % (self.hostname, oids))
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_process_value_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s">"""
        @@@ Matching the value process rule
        :param rule_name:
        :param kwargs:
        :return:
        """</span>
        <span class="c1">## ToDO NO SUCN rule
</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">ValueRules</span><span class="p">()</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rule_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">manage_ip</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">manage_ip</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_tag_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s">"""
        @@@ Tags handler
            @ Tags get attr from raw content
        :param tags:
        :return:
        """</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">TagRules</span><span class="p">()</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rule_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">manage_ip</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">manage_ip</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_opera_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s">"""
        @@@ Matching the operation process rule
        :param rule_name:
        :param kwargs:
        :return:
        """</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">OperationRules</span><span class="p">()</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rule_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">manage_ip</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">manage_ip</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_raw_data_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        :wrapper: wrap raw data to a dic, oid as key
        :return:
        {
            "1.3.6.1.4.1.2636.3.1.13.1.8.9.1.0.0": [
                {
                    "oid_index": "",
                    "oid": "enterprises.2636.3.1.13.1.8.9.1.0.0",
                    "snmp_type": "GAUGE",
                    "value": "1"
                }...
            ],
            ""1.3.6.1.4.1.2636.3.1.13.1.8.9.1.0.1": [
                {
                    "oid_index": "",
                    "oid": "enterprises.2636.3.1.13.1.8.9.1.0.1",
                    "snmp_type": "GAUGE",
                    "value": "1"
                }...
            ]...
        }
        """</span>
        <span class="n">oid_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">oid_dic</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">raw_data</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">oid</span><span class="p">,</span> <span class="n">oid_value</span> <span class="ow">in</span> <span class="n">oid_dic</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oid_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">)):</span>
                    <span class="n">oid_value</span> <span class="o">=</span> <span class="p">[</span><span class="n">oid_value</span><span class="p">]</span>
                <span class="n">oid_data</span><span class="p">.</span><span class="n">update</span><span class="p">({</span><span class="n">oid</span><span class="p">:</span> <span class="n">oid_value</span><span class="p">})</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">oid_data</span> <span class="o">=</span> <span class="n">oid_data</span>

    <span class="k">def</span> <span class="nf">handler_distributor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_raw</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""
        @self._task
        {
            "snmp_task":{
                "oid": {
                    'get': [],
                    'bulk': [],
                    'walk': [],
                    'getnext': []
                },
                "value_rule": "",
                "tag_rule": "",
                "opera_rule": ""
            }
        }
        @@@ Rules
        :rule:三种采集数据处理规则，规则都在task_content中
        1. value_rule           值处理规则，对上报数值进行处理，比如从字符串中截取监控指标
        2. tag_rule             标签处理规则，如对根据接口索引获取接口速率和名称并添加到上报tags中
        3. opera_rule           运算操作规则，对多个oid取回值进行运算处理获取监控指标，比如对metric_raw中的值进行加减乘除

        @@@ Handlers
        :handler: 三种OID处理规则
        1. snmp_single          单值处理，task中只有一个操作方法和一个oid，采集结果也只有单一值(例如：get操作单一oid)
        2. snmp_batch           批量处理，task中只有一个操作方法和一个oid，采集结果会有索引(例如：walk操作单一oid)
        3. snmp_multi           多值处理，task中有多个操作方法或多个oid，采集结果会有多种值或多种索引(例如：风别walk操作三个oid)

        :param metric_raw:
        :return:
            @@True      数据处理成功发送OpenFalcon
            @@False     数据处理失败写入日志
        """</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">did_parse_data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_parse_metric_raw</span><span class="p">(</span><span class="n">metric_raw</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">did_parse_data</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">_task</span><span class="p">:</span>
                <span class="n">LOG</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_error_handler</span><span class="p">(</span><span class="n">err_des</span><span class="o">=</span><span class="s">"monitor item task empty"</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="c1"># @ task handler caller
</span>            <span class="k">for</span> <span class="n">task_type</span><span class="p">,</span> <span class="n">task_content</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">_task</span><span class="p">.</span><span class="n">iteritems</span><span class="p">():</span>

                <span class="c1"># @SNMP task
</span>                <span class="k">if</span> <span class="n">task_type</span> <span class="o">==</span> <span class="s">"snmp_task"</span><span class="p">:</span>

                    <span class="bp">self</span><span class="p">.</span><span class="n">_raw_data_wrapper</span><span class="p">()</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">oid_data</span><span class="p">.</span><span class="n">values</span><span class="p">()):</span>
                        <span class="c1"># 多oid多值
</span>                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">oid_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">snmp_multi_monitor_item_handler</span><span class="p">(</span><span class="n">task_content</span><span class="p">)</span>
                        <span class="c1"># 单oid多值
</span>                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">oid_data</span><span class="p">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">snmp_batch_monitor_item_handler</span><span class="p">(</span><span class="n">task_content</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">snmp_single_monitor_item_handler</span><span class="p">(</span><span class="n">task_content</span><span class="p">)</span>

                <span class="c1"># @Netconf task
</span>                <span class="k">elif</span> <span class="n">task_type</span> <span class="o">==</span> <span class="s">"netconf_task"</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">"%s monitor task type not supported!"</span> <span class="o">%</span> <span class="n">LogPrefix</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOG</span><span class="p">.</span><span class="n">exception</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_error_handler</span><span class="p">(</span><span class="n">exp</span><span class="o">=</span><span class="n">e</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">snmp_single_monitor_item_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_content</span><span class="p">):</span>
        <span class="s">"""

        :param metric_raw:
        @metric_raw["response"]
        "response": {
                "get": {
                    "1.3.6.1.4.1.2636.3.1.13.1.8.9.1.0.0": {
                        "oid_index": "",
                        "oid": "enterprises.2636.3.1.13.1.8.9.1.0.0",
                        "snmp_type": "GAUGE",
                        "value": "1"
                    }
                }
            }
        :return: Bool
        """</span>
        <span class="n">task_value_rule</span> <span class="o">=</span> <span class="n">task_content</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"value_rule"</span><span class="p">)</span>
        <span class="n">task_tag_rule</span> <span class="o">=</span> <span class="n">task_content</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"tag_rule"</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">raw_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">raw_data</span><span class="p">.</span><span class="n">values</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">"upload data is not single value"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">oid_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">raw_data</span><span class="p">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">oid_content_dic</span> <span class="o">=</span> <span class="n">oid_dic</span><span class="p">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oid_content_dic</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">oid_content_dic</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"value"</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oid_content_dic</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">oid_content_dic</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">oid_content_dic</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">get</span><span class="p">(</span><span class="s">"value"</span><span class="p">)</span>
                    <span class="n">oid_content_dic</span> <span class="o">=</span> <span class="n">oid_content_dic</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="bp">None</span>

                <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">_is_value_valid</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>

                    <span class="c1"># process rules
</span>                    <span class="c1"># 1. value rule
</span>                    <span class="k">if</span> <span class="n">task_value_rule</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_process_value_rule</span><span class="p">(</span><span class="n">task_value_rule</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">sysname</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">sysname</span><span class="p">)</span>

                    <span class="c1"># 2. tag rule
</span>                    <span class="k">if</span> <span class="n">task_tag_rule</span><span class="p">:</span>
                        <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_process_tag_rule</span><span class="p">(</span><span class="n">task_tag_rule</span><span class="p">,</span> <span class="n">oid_content</span><span class="o">=</span><span class="n">oid_content_dic</span><span class="p">)</span>

                    <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">metrics_sender</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOG</span><span class="p">.</span><span class="n">exception</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_error_handler</span><span class="p">(</span><span class="n">err_des</span><span class="o">=</span><span class="s">"single value process failed"</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="n">e</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">snmp_batch_monitor_item_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_content</span><span class="p">):</span>
        <span class="s">"""
        :rule:三个处理规则，规则都在task_content中
        1. value_rule           值处理规则，对上报数值进行处理，比如从字符串中截取监控指标
        2. tag_rule             标签处理规则，如对根据接口索引获取接口速率和名称并添加到上报tags中
        3. operation_rule       运算操作规则，对多个oid取回值进行运算处理获取监控指标，比如对metric_raw中的值进行加减乘除

        @@ 基于metric索引批量处理监控数据
        :param metric_raw:
        @example
        @metric_raw["response"]
        "response": {
            "walk": {
                "1.3.6.1.2.1.2.2.1.14": [
                    {
                        "oid_index": "1",
                        "oid": "ifInErrors",
                        "value": "0",
                        "snmp_type": "COUNTER"
                    },
                    {
                        "oid_index": "4",
                        "oid": "ifInErrors",
                        "value": "0",
                        "snmp_type": "COUNTER"
                    },
                    {
                        "oid_index": "5",
                        "oid": "ifInErrors",
                        "value": "0",
                        "snmp_type": "COUNTER"
                    }
                ]
            }
        }
        :param task_content:
        :return:
        """</span>

        <span class="n">task_value_rule</span> <span class="o">=</span> <span class="n">task_content</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"value_rule"</span><span class="p">)</span>
        <span class="n">task_tag_rule</span> <span class="o">=</span> <span class="n">task_content</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"tag_rule"</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">raw_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">"upload data format error"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">oid_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">raw_data</span><span class="p">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">oid_content_list</span> <span class="o">=</span> <span class="n">oid_dic</span><span class="p">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">ret_res</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">oid_content_dic</span> <span class="ow">in</span> <span class="n">oid_content_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">oid_content_dic</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">oid_content_dic</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"value"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s">"2147483647"</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="s">"0"</span>
                        <span class="n">tags</span> <span class="o">=</span> <span class="s">"index={}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">oid_content_dic</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"oid_index"</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="bp">self</span><span class="p">.</span><span class="n">_is_value_valid</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                            <span class="c1"># process rules
</span>                            <span class="c1"># 1. value rule
</span>                            <span class="k">if</span> <span class="n">task_value_rule</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_process_value_rule</span><span class="p">(</span><span class="n">task_value_rule</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">sysname</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">sysname</span><span class="p">)</span>
                            <span class="c1"># 2. tag rule
</span>                            <span class="k">if</span> <span class="n">task_tag_rule</span><span class="p">:</span>
                                <span class="n">tags</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_process_tag_rule</span><span class="p">(</span><span class="n">task_tag_rule</span><span class="p">,</span> <span class="n">oid_content</span><span class="o">=</span><span class="n">oid_content_dic</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">tags</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">metrics_sender</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
                            <span class="n">ret_res</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                  
                <span class="k">if</span> <span class="bp">False</span> <span class="ow">in</span> <span class="n">ret_res</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret_res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOG</span><span class="p">.</span><span class="n">exception</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_error_handler</span><span class="p">(</span><span class="n">err_des</span><span class="o">=</span><span class="s">"batch value process failed"</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="n">e</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">snmp_multi_monitor_item_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_content</span><span class="p">):</span>
        <span class="s">"""

        :param metric_raw:
        @example
        @metric_raw["response"]
        "response": {
            "walk": {
                "1.3.6.1.2.1.2.2.1.14": [
                    {
                        "oid_index": "1",
                        "oid": "ifInErrors",
                        "value": "0",
                        "snmp_type": "COUNTER"
                    }...
                ],
                ""1.3.6.1.2.1.2.2.1.15": [
                    {
                        "oid_index": "1",
                        "oid": "",
                        "value": "0",
                        "snmp_type": "COUNTER"
                    }...
                ], ...
            }
        }
        :param task_content:
        :return:
            [{"value": "", "tags": ""}, {"value": "", "tags": ""}, ...]
        """</span>

        <span class="n">task_opera_rule</span> <span class="o">=</span> <span class="n">task_content</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"opera_rule"</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task_opera_rule</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_process_opera_rule</span><span class="p">(</span><span class="n">task_opera_rule</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">raw_data</span><span class="p">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1">#LOG.debug("multi task name=" + task_opera_rule + ",result metric length=" + str(len(result)))
</span>                <span class="n">did_send</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">did_send</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">metrics_sender</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s">"value"</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="s">"tags"</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">did_send</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOG</span><span class="p">.</span><span class="n">exception</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_error_handler</span><span class="p">(</span><span class="n">err_des</span><span class="o">=</span><span class="s">"get multi value process failed"</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="n">e</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">metrics_sender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
        <span class="s">"""

        @@Tags
            1. 检查tag字段，如果有值则调用 _match_tags_handler
            2. 如果为空，侧检查index_tag是否有值
            3. 如果有值，侧使用tags="%s/%s" %(index_tag, index)
            4. 如果为空，侧无tags

        :param metric:
        :param title:
        :return:
        """</span>
        <span class="n">__OpenFalcon_metric_type</span> <span class="o">=</span> <span class="n">Metric_Type</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">_metric_type</span><span class="p">]</span>
        <span class="n">__v_type</span> <span class="o">=</span> <span class="n">Metric_Value_Type</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">_metric_type</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">__v_type</span> <span class="o">==</span> <span class="s">"float"</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">"endpoint"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">sysname</span><span class="p">,</span>
                <span class="s">"metric"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">_metric</span><span class="p">,</span>
                <span class="s">"timestamp"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span>
                <span class="s">"step"</span><span class="p">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">step</span><span class="p">,</span>
                <span class="s">"value"</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                <span class="s">"counterType"</span><span class="p">:</span> <span class="n">__OpenFalcon_metric_type</span><span class="p">,</span>
                <span class="s">"tags"</span><span class="p">:</span> <span class="n">tags</span>
            <span class="p">}</span>
            <span class="c1"># LOG.info("[DEBUG Send] %s" % m)
</span>            <span class="n">Falcon</span><span class="p">.</span><span class="n">send</span><span class="p">([</span><span class="n">m</span><span class="p">])</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOG</span><span class="p">.</span><span class="n">exception</span><span class="p">(</span><span class="s">"parser OpenFalcon metric failed, e=%s"</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">common_data_handler</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="s">"""

        :param func:
        :return:
        """</span>

        <span class="k">def</span> <span class="nf">monitor_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="s">"""

            :param args:
            :param kwargs:
            :return:
            """</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">data_dic</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">data_dic</span><span class="p">[</span><span class="s">"type"</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">data_dic</span><span class="p">[</span><span class="s">"val"</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data_dic</span>
            <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">LOG</span><span class="p">.</span><span class="n">exception</span><span class="p">(</span><span class="s">'get error, e=%s'</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>

        <span class="k">return</span> <span class="n">monitor_wrapper</span>

</pre></table></code></div></div><h2 id="3-执行任务和处理规则">3. 执行任务和处理规则</h2><ul><li>agent所要执行的任务定义和处理规则定义</li></ul><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre> <span class="n">MonitorTaskJsonDic</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"snmp_task"</span><span class="p">:</span> <span class="p">{</span>              <span class="c1">#@SNMP采集任务
</span>            <span class="s">"oid"</span><span class="p">:</span> <span class="p">{</span>                <span class="c1">#@采集OID和执行方式-同步到job.content中并关联设备
</span>                <span class="s">'get'</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s">'bulk'</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s">'walk'</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s">'getnext'</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">},</span>
            <span class="s">"tag_rule"</span><span class="p">:</span> <span class="s">""</span><span class="p">,</span>        <span class="c1">#@数标签处理规则
</span>            <span class="s">"opera_rule"</span><span class="p">:</span> <span class="s">""</span><span class="p">,</span>       <span class="c1">#@多数据处理规则
</span>            <span class="s">"value_rule"</span><span class="p">:</span> <span class="s">""</span>        <span class="c1">#@采集值处理规则-如：从字符串中匹配整形并转为百分比
</span>        <span class="p">}</span>
    <span class="p">}</span>
</pre></table></code></div></div><ul><li>此处定义一个snmp_task，agent根据此task来执行采集和上报数据</li><li>规则处理函数会接收 agent采集返回报文的json对象的 response 部分<div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="nl">"response"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"walk"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"1.3.6.1.2.1.2.2.1.14"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                  </span><span class="p">{</span><span class="w">
                      </span><span class="nl">"oid_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
                      </span><span class="nl">"oid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ifInErrors"</span><span class="p">,</span><span class="w">
                      </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w">
                      </span><span class="nl">"snmp_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"COUNTER"</span><span class="w">
                  </span><span class="p">},</span><span class="w">
                  </span><span class="p">{</span><span class="w">
                      </span><span class="nl">"oid_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"4"</span><span class="p">,</span><span class="w">
                      </span><span class="nl">"oid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ifInErrors"</span><span class="p">,</span><span class="w">
                      </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w">
                      </span><span class="nl">"snmp_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"COUNTER"</span><span class="w">
                  </span><span class="p">},</span><span class="w">
                  </span><span class="p">{</span><span class="w">
                      </span><span class="nl">"oid_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5"</span><span class="p">,</span><span class="w">
                      </span><span class="nl">"oid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ifInErrors"</span><span class="p">,</span><span class="w">
                      </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0"</span><span class="p">,</span><span class="w">
                      </span><span class="nl">"snmp_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"COUNTER"</span><span class="w">
                  </span><span class="p">}</span><span class="w">
              </span><span class="p">]</span><span class="w">
          </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div></li><li>规则定义<ol><li>在task中定义tag_rule, value_rule, opera_rule，处理函数会自动将数据和处理规则进行动态匹配，当有新报文段交付后，会触发对应的规则函数；</li><li>规则匹配顺序为：ValueRules， TagRules， OperationRules</li><li>规则选用建议</li></ol><ol><li>如果采集结果为单一结果，例如”value”: “35”，使用ValueRules，将该字符串进行处理，比如”35%”,或0.35；</li><li>如果采集结果携带索引，对其值的处理结果可以参考1，对索引值可以使用TagRules，将索引处理为特定的标签，标识一条唯一的数据，并且该标签还可以携带其他和数据相关的属性；</li><li>对于多种采集OID对象和多种结果的类型，只使用自定义的OperationRules<blockquote><p>部分ValueRules，TagRules可以对数据做通用处理</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">ValueRules</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="k">class</span> <span class="nc">TagRules</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="k">class</span> <span class="nc">OperationRules</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</pre></table></code></div></div></blockquote></li></ol></li></ul><h2 id="4-新监控项开发">4. 新监控项开发</h2><ul><li>如何添加一个新的监控项 （测试环境）<ol><li>添加数据记录到动态监控表，根据每个字段名称定义相应的字段；</li></ol><ul><li>vendor，type，model，series 设备相关，用来定义那些厂商哪些类型哪些型号的设备要”被agent执行新增的监控项任务“</li><li>id，metric，metric_type，upload_api，用来定义一个唯一的监控项，和监控项在dashboard和rrd数据库中的名称，且包含唯一一个为此监控项创建的上传RESTful接口</li><li>task 定义采集任务，agent执行什么样的任务；定义处理规则，采集回来的数据要被映射到哪些自定义的规则函数上</li><li>interval agent对设备多久进行一次采集，”UDP“报文段交互</li></ul></li></ul><ol><li>数据都定义完成后，编写你的规则函数<ul><li>函数名称要和task中定义的函数名称一致</li><li>函数所属要的类，要和task中给定的一致</li><li>函数入参固定<ul><li>ValueRules manage_ip=None, value=None, sysname=None</li><li>TagRules manage_ip=None, oid_content=None</li><li>OperationRules manage_ip=None, raw_data=None</li></ul></li><li>处理逻辑，manage_ip为设备在各自AS的子网中的管理IP地址，采集回来的数据为其他参数<ul><li>value 采集唯一值</li><li>sysname 设备名称</li><li>oidcontent python列表类型，列表中包含多个采集结果字典，例如<div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre>  <span class="p">[</span>
          <span class="p">{</span>
              <span class="s">"oid_index"</span><span class="p">:</span> <span class="s">"1"</span><span class="p">,</span>
              <span class="s">"oid"</span><span class="p">:</span> <span class="s">"ifInErrors"</span><span class="p">,</span>
              <span class="s">"value"</span><span class="p">:</span> <span class="s">"0"</span><span class="p">,</span>
              <span class="s">"snmp_type"</span><span class="p">:</span> <span class="s">"COUNTER"</span>
          <span class="p">},</span>
          <span class="p">{</span>
              <span class="s">"oid_index"</span><span class="p">:</span> <span class="s">"4"</span><span class="p">,</span>
              <span class="s">"oid"</span><span class="p">:</span> <span class="s">"ifInErrors"</span><span class="p">,</span>
              <span class="s">"value"</span><span class="p">:</span> <span class="s">"0"</span><span class="p">,</span>
              <span class="s">"snmp_type"</span><span class="p">:</span> <span class="s">"COUNTER"</span>
          <span class="p">},</span>
          <span class="p">{</span>
              <span class="s">"oid_index"</span><span class="p">:</span> <span class="s">"5"</span><span class="p">,</span>
              <span class="s">"oid"</span><span class="p">:</span> <span class="s">"ifInErrors"</span><span class="p">,</span>
              <span class="s">"value"</span><span class="p">:</span> <span class="s">"0"</span><span class="p">,</span>
              <span class="s">"snmp_type"</span><span class="p">:</span> <span class="s">"COUNTER"</span>
          <span class="p">}</span>
      <span class="p">]</span>
</pre></table></code></div></div></li><li>raw_data 报文中json对象的response部分的全部数据</li></ul></li><li>处理规则的返回值<ul><li>ValueRules 返回处理后的value</li><li>TagsRules 返回固定格式的Tags字符串，字符串中的标签字符用”=”和”,”分隔</li><li>OperationRules 返回处理完成后的所有数据的列表，列表中为相同结构的字典 包含”value”和”tags”，例如<div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>  <span class="p">[{</span><span class="s">"value"</span><span class="p">:</span> <span class="p">,</span> <span class="s">"tags"</span><span class="p">},{</span><span class="s">"value"</span><span class="p">:</span> <span class="p">,</span> <span class="s">"tags"</span><span class="p">},{</span><span class="s">"value"</span><span class="p">:</span> <span class="p">,</span> <span class="s">"tags"</span><span class="p">}]</span>
</pre></table></code></div></div><blockquote><p>其中tags格式依然固定，value可以是整型或者浮点类型</p></blockquote></li></ul></li></ul></li><li>完成规则函数编写后，数据上报部分有独立线程来自动完成，无需关注；</li></ol><h2 id="5-调试">5. 调试</h2><ul><li>agent和server的调试，请移步单元测试文档</li></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E5%AE%9E%E8%B7%B5/'>实践</a>, <a href='/categories/%E9%9C%80%E6%B1%82%E5%AE%9E%E7%8E%B0/'>需求实现</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/python/" class="post-tag no-text-decoration" >Python</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Python实现动态生成类的http接口-monitor动态监控项 - TeddyGoodman&url=http://localhost:4000/posts/Python-dynamic-map/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Python实现动态生成类的http接口-monitor动态监控项 - TeddyGoodman&u=http://localhost:4000/posts/Python-dynamic-map/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Python实现动态生成类的http接口-monitor动态监控项 - TeddyGoodman&url=http://localhost:4000/posts/Python-dynamic-map/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <!-- The trending tags list v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT Licensed --> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/go/">Go</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/sumof2019/">SumOf2019</a> <a class="post-tag" href="/tags/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/">体系结构</a> <a class="post-tag" href="/tags/rabbitmq/">RabbitMQ</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/cpython/">CPython</a> <a class="post-tag" href="/tags/c%26c%2B%2B/">C&C++</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-3">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="post-extend-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/linux-networking/" class="btn btn-outline-primary"><p>Linux网络基础</p></a> <a href="/posts/understanding-of-tornado/" class="btn btn-outline-primary"><p>tornado框架学习及源码分析</p></a></div><!-- The related posts of current post. Placed in the bottom of every single post. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-4 mb-2 mb-sm-4 pb-2"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/redhat-6.5-python-dependency/"><div class="card-body"> <span class="timeago small"> May 14, 2020 <i class="unloaded">2020-05-14T14:56:51+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Red Hat Enterprise Linux Kernel Version 2.6.32 3.8.13 python依赖环境手动部署</h3><div class="text-muted small"><p>Red Hat Enterprise Linux Kernel Version 2.6.32 3.8.13 步骤 Download pkg files from test code Install needed pkg for redhat linux Upgrade Python interpreter to Version 2.7.5 Install pip and ...</p></div></div></a></div><div class="card"> <a href="/posts/python-service-deployment/"><div class="card-body"> <span class="timeago small"> May 14, 2020 <i class="unloaded">2020-05-14T15:03:28+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Python服务容器化部署</h3><div class="text-muted small"><p>监控容器微服务部署 新增节点初始化操作 下载Docker环境部署文件，上传到物理机 将以上文件上传至同一目录下，执行如下： 准备日志 准备应用文件 Step0：获取监控物理机信息 Step1：初始化配置监控主机 Step2：部署+验证 ...</p></div></div></a></div><div class="card"> <a href="/posts/understanding-of-tornado/"><div class="card-body"> <span class="timeago small"> Mar 24, 2020 <i class="unloaded">2020-03-24T10:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>tornado框架学习及源码分析</h3><div class="text-muted small"><p></p></div></div></a></div></div></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const el = document.querySelectorAll('#post-wrapper img'); const observer = lozad(el); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/TeddyGoodman">TeddyGoodman</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://github.com" target="_blank">Github.</a></p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted">Trending Tags</h4><!-- The trending tags list v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT Licensed --> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/go/">Go</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/sumof2019/">SumOf2019</a> <a class="post-tag" href="/tags/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/">体系结构</a> <a class="post-tag" href="/tags/rabbitmq/">RabbitMQ</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/cpython/">CPython</a> <a class="post-tag" href="/tags/c%26c%2B%2B/">C&C++</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js" integrity="sha256-qcLR00zq6pJk4je3MLgAri8Nn+ZumUlXgTKR2H/xCY0=" crossorigin="anonymous"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://localhost:4000{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script> <script src="/assets/live2d-widget/autoload.js"></script>
