<!DOCTYPE html><html lang="en" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Python进程内存分析&大量内存占用的优化方案 | TeddyGoodman</title><meta name="generator" content="Jekyll v4.3.1" /><meta property="og:title" content="Python进程内存分析&amp;大量内存占用的优化方案" /><meta name="author" content="Teddy" /><meta property="og:locale" content="en_US" /><meta name="description" content="Python进程内存分析&amp;大量内存占用的优化方案" /><meta property="og:description" content="Python进程内存分析&amp;大量内存占用的优化方案" /><link rel="canonical" href="http://localhost:4000/posts/CPython-malloc-python-gc/" /><meta property="og:url" content="http://localhost:4000/posts/CPython-malloc-python-gc/" /><meta property="og:site_name" content="TeddyGoodman" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-03-29T10:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Python进程内存分析&amp;大量内存占用的优化方案" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@Teddy" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/CPython-malloc-python-gc/"},"url":"http://localhost:4000/posts/CPython-malloc-python-gc/","author":{"@type":"Person","name":"Teddy"},"headline":"Python进程内存分析&amp;大量内存占用的优化方案","dateModified":"2020-03-29T10:00:00+08:00","datePublished":"2020-03-29T10:00:00+08:00","description":"Python进程内存分析&amp;大量内存占用的优化方案","@type":"BlogPosting","@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/main.css"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script> window.jQuery || document.write('<script src="/assets/lib/jquery-3.4.1.min.js"><\/script>'); </script> <script src="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha256-5+02zu5UULQkO7w1GIr6vftCgMfFdZcAHeDtFnKZsBs=" crossorigin="anonymous" async></script> <script src="/assets/js/dist/commons.js" async></script> <script src="/assets/js/dist/timeago.min.js" async></script><link rel="preload" as="style" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/syntax.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/syntax.css"><link rel="preload" as="style" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css"><link rel="preload" as="script" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js"><link rel="stylesheet" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css" /> <script src="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js" async></script> <script src="/assets/js/dist/toc.min.js" async></script> <script src="/assets/js/dist/tooltip-loader.min.js" async></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/avatar/avatar.jpg" alt="avatar"> </a></div><div class="profile-text mt-3"><div id="site-title"> <a href="/">TeddyGoodman</a></div><div id="site-subtitle" class="font-italic">-- Cloud Computing Enginer --</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-3 mr-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-3 mr-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-3 mr-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-3 mr-3 unloaded"></i> <span>ARCHIVES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-3 mr-3 unloaded"></i> <span>ABOUT</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <!-- Switch the mode between dark and light. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/TeddyGoodman" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="javascript:window.open('mailto:' + ['teddyynagoodman','gmail.com'].join('@'))"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" target="_blank"> <i class="fas fa-rss"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Python进程内存分析&大量内存占用的优化方案</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Python进程内存分析&大量内存占用的优化方案</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago" data-toggle="tooltip" data-placement="bottom" title="Sun, Mar 29, 2020, 10:00 AM +0800"> Mar 29, 2020 <i class="unloaded">2020-03-29T10:00:00+08:00</i> </span> by <span class="author"> Teddy </span></div></div><div class="post-content"><h1 id="python进程内存分析大量内存占用的优化方案">Python进程内存分析&amp;大量内存占用的优化方案</h1><h2 id="cpython预编译运行库">CPython预编译运行库</h2><blockquote><ul><li>python-debuginfo-2.7.5-86.el7.x86_64</li><li>glibc-debuginfo-common-2.17-292.el7.x86_64</li><li>python-debuginfo-2.7.5-86.el7.x86_64</li></ul></blockquote><h1 id="monitor-server-内存分析大量内存占用的优化方案">monitor-server 内存分析，大量内存占用的优化方案</h1><h1 id="1-当前程序状态">1. 当前程序状态</h1><ul><li>物理机<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>417593 root      20   0 4325700 1.946g   6724 S   8.9  0.8 891:53.36 python
641599 root      20   0 4322988 1.922g   6748 S   3.0  0.8   1219:54 python
641904 root      20   0 4328792 1.968g   6748 S   3.0  0.8   1359:53 python
641963 root      20   0 4327696 1.930g   6748 S   2.0  0.8   1263:28 python
</pre></table></code></div></div></li><li>虚拟机<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>609083 root      20   0 4123852   1.5g   1660 S   2.3  9.5 109:47.85 python
643875 root      20   0 4262180   1.7g   1284 S   1.3 11.0  89:58.01 python
643877 root      20   0 4192588   1.6g   1440 S   1.3 10.6  86:33.74 python
671562 root      20   0 4253364   1.7g   1704 S   1.0 10.8  69:23.61 python   
</pre></table></code></div></div></li><li>运行时间在1000小时左右的进程</li><li>在裸金属中占用物理内存比例为0.8%，主机内存总大小为256GB，每个python进程占用大小为2GB左右</li><li>在虚拟机中占用的物理内存大小9%~ 11%，主机内存总大小16GB，每个python进程占用内存大小为2GB左右</li><li>同一LISTEN端口，TCP服务保持的TCP长链接对应Socket数量<ul><li>虚拟机：80左右</li><li>物理机：120 - 140左右</li></ul></li><li>因为在LVS转发配置<ul><li>虚拟机 权重 20 单个进程的权重 20/10</li><li>物理机 权重 100 单个进程的权重 100/30</li></ul></li></ul><h1 id="2-server对交付报文的处理">2. server对交付报文的处理</h1><ul><li><p>server处理HTTP报文的有效载荷数据大小为数bk到数百kb，服务器使用I/O多路复用，借助select(此处使用了linux的epoll)函数检查事件输入，进程通过监听描述符创建了80到140个连接描述符，并将数据交付给multiprocessing线程池中25个线程中空闲的线程，在文件的读写过程中，server的动态监控及接口监控等数据处理有一定复杂度的函数，会产生大量的数据拷贝和引用，并会创建很多对象（datamodel等）；</p></li><li>python的垃圾回收发生的条件<blockquote><p>https://docs.python.org/2/library/gc.html 官方文档：The GC classifies objects into three generations depending on how many collection sweeps they have survived. New objects are placed in the youngest generation (generation 0). If an object survives a collection it is moved into the next older generation. Since generation 2 is the oldest generation, objects in that generation remain there after a collection. In order to decide when to run, the collector keeps track of the number object allocations and deallocations since the last collection. When the number of allocations minus the number of deallocations exceeds threshold0, collection starts. Initially only generation 0 is examined. If generation 0 has been examined more than threshold1 times since generation 1 has been examined, then generation 1 is examined as well. Similarly, threshold2 controls the number of collections of generation 1 before collecting generation 2.</p></blockquote></li><li>python内存管理的三层结构<ul><li>generation 0：新建的对象</li><li>generation 1：垃圾回收后，任然存在引用，则归入1</li><li>generation 2：最老的无法被collection函数回收的对象</li></ul></li><li>回收机制会在内存分配数量和取消分配数量的差值超过 一个特定的阈值 才会触发</li><li>通过gc模块，可以查看默认的阈值，且可以通过调用set_threshold函数，配置定制的阈值<div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">gc</span>
<span class="n">gc</span><span class="p">.</span><span class="n">get_threshold</span><span class="p">()</span><span class="err">　　</span><span class="c1">#gc模块中查看阈值的方法
</span><span class="p">(</span><span class="mi">700</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></table></code></div></div></li><li>这里的解释是：阈值超过700时才会对g0的对象进行回收，每10次回收g0会发生1次回收g1，每10次回收g1会发生1次回收g2；</li><li>gc模块提供主动触发垃圾回收的函数<div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="n">generation</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="n">collect</span><span class="p">([</span><span class="n">generation</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">n</span>
</pre></table></code></div></div></li></ul><blockquote><p>With no arguments, run a full collection. The optional argument may be an integer specifying which generation to collect. A ValueError is raised if the generation number is invalid.</p></blockquote><ul><li>对于不传入参数的调用来说，会发起g0 g1 g2三代的全部的回收；</li><li>CPython对C运行库提供的free函数的调用，也存在一定的条件<ul><li>第3层：最上层，用户对Python对象的直接操作</li><li>第1层和第2层：内存池，有Python的接口函数PyMem_Malloc实现-----若请求分配的内存在1~256字节之间就使用内存池管理系统进行分配，调用malloc函数分配内存，但是每次只会分配一块大小为256K的大块内存，不会调用free函数释放内存，将该内存块留在内存池中以便下次使用。</li><li>第0层：大内存-----若请求分配的内存大于256K，malloc函数分配内存，free函数释放内存；</li></ul></li></ul><h1 id="3-动手操作问题定位">3. 动手操作，问题定位</h1><h2 id="中断运行的程序输出无法回收的对象">中断运行的程序，输出无法回收的对象</h2><blockquote><p>A list of objects which the collector found to be unreachable but could not be freed (uncollectable objects). By default, this list contains only objects with <strong>del</strong>() methods. 1 Objects that have <strong>del</strong>() methods and are part of a reference cycle cause the entire reference cycle to be uncollectable, including objects not necessarily in the cycle but reachable only from it. Python doesn’t collect such cycles automatically because, in general, it isn’t possible for Python to guess a safe order in which to run the <strong>del</strong>() methods. If you know a safe order, you can force the issue by examining the garbage list, and explicitly breaking cycles due to your objects within the list. Note that these objects are kept alive even so by virtue of being in the garbage list, so they should be removed from garbage too. For example, after breaking cycles, do del gc.garbage[:] to empty the list. It’s generally better to avoid the issue by not creating cycles containing objects with <strong>del</strong>() methods, and garbage can be examined in that case to verify that no such cycles are being created.</p></blockquote><ul><li>pip install pyrasite</li><li>pip show pyrasite</li></ul><blockquote><p>Name: pyrasite Version: 2.0 Summary: Inject code into a running Python process Home-page: http://pyrasite.com Author: Luke Macken</p></blockquote><ul><li>安装pyrasite工具，该工具可以中断正在运行的进程，并对进程进行注入和检查</li><li><p>pyrasite-shell<pid>， 接下来就可以在<pid>的进程里调用任意的python代码, 来查看进程的状态.</pid></pid></p></li><li>guppy 取得内存使用的各种对象占用情况，guppy 可以用来打印出各种对象各占用多少空间, 如果python进程中有没有释放的对象, 造成内存占用升高, 通过guppy可以查看出来:</li><li>pip install guppy<div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">pyrasite</span><span class="o">-</span><span class="n">shell</span> <span class="o">&lt;</span><span class="n">pid</span><span class="o">&gt;</span>
<span class="kn">from</span> <span class="nn">guppy</span> <span class="kn">import</span> <span class="n">hpy</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">hpy</span><span class="p">()</span>
<span class="n">h</span><span class="p">.</span><span class="n">heap</span><span class="p">()</span>
</pre></table></code></div></div></li><li>运行此命令报错，暂时未定位原因，h.heap可以查看当前进程堆的内存分配情况，例如各种类型的对象占用的内存长度；<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre># Partition of a set of 48477 objects. Total size = 3265516 bytes.
#  Index  Count   %     Size   % Cumulative  % Kind (class / dict of class)
#      0  25773  53  1612820  49   1612820  49 str
#      1  11699  24   483960  15   2096780  64 tuple
#      2    174   0   241584   7   2338364  72 dict of module
#      3   3478   7   222592   7   2560956  78 types.CodeType
#      4   3296   7   184576   6   2745532  84 function
#      5    401   1   175112   5   2920644  89 dict of class
#      6    108   0    81888   3   3002532  92 dict (no owner)
#      7    114   0    79632   2   3082164  94 dict of type
#      8    117   0    51336   2   3133500  96 type
#      9    667   1    24012   1   3157512  97 __builtin__.wrapper_descriptor
# &lt;76 more rows. Type e.g. '_.more' to view.&gt;
h.iso(1,[],{})
# Partition of a set of 3 objects. Total size = 176 bytes.
#  Index  Count   %     Size   % Cumulative  % Kind (class / dict of class)
#      0      1  33      136  77       136  77 dict (no owner)
#      1      1  33       28  16       164  93 list
#      2      1  33       12   7       176 100 int
</pre></table></code></div></div></li><li>无法回收的对象</li><li>python垃圾回收, 对象无法被垃圾回收(uncollectable object), 满足2个条件:<ol><li>循环引用</li><li>循环引用的链上某个对象定义了__del__方法, 循环引用的一组对象被gc模块识别为可回收的, 但需要先调用每个对象上的__del__方法, 才能回收. 但用户自定义了__del__的对象, gc系统不知道应该先调用环上的哪个__del__. 因此无法回收这类对象.</li></ol></li><li>不能回收的python对象会持续占据内存</li><li>查找uncollectable的对象:<div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">pyrasite</span><span class="o">-</span><span class="n">shell</span> <span class="p">{</span><span class="n">PID</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">gc</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">gc</span><span class="p">.</span><span class="n">collect</span><span class="p">()</span> <span class="c1"># first run gc, find out uncollectable object and put them in gc.garbage
</span>           <span class="c1"># output number of object collected
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">gc</span><span class="p">.</span><span class="n">garbage</span>   <span class="c1"># print all uncollectable objects
</span><span class="o">&gt;&gt;&gt;</span> <span class="p">[]</span>               <span class="c1"># empty
</span></pre></table></code></div></div><blockquote><p>如果在上面最后一步打印出了任何不能回收的对象, 则需要进一步查找循环引用链上在哪个对象上包含__del__方法.</p></blockquote></li><li><p>gdb查看python线程执行上下文及调用栈</p></li><li>安装python的debuginfo及gcc的debuginfo</li><li>gdb python {PID}<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> info threads
Id   Target Id         Frame 
 36   Thread 0x7f4b2bbad740 <span class="o">(</span>LWP 404510<span class="o">)</span> 0x00007f4b2a9e1e63 <span class="k">in </span>epoll_wait <span class="o">()</span> at ../sysdeps/unix/syscall-template.S:81
 35   Thread 0x7f4a7bb7a700 <span class="o">(</span>LWP 412337<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a58000910<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 34   Thread 0x7f4a7c37b700 <span class="o">(</span>LWP 412248<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a54000b30<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 33   Thread 0x7f4a7cb7c700 <span class="o">(</span>LWP 410227<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a5c000b30<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 32   Thread 0x7f4a7d37d700 <span class="o">(</span>LWP 409187<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a6826fa50<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 31   Thread 0x7f4a7dc3e700 <span class="o">(</span>LWP 408137<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a70003470<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 30   Thread 0x7f4a7e43f700 <span class="o">(</span>LWP 406936<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a6c33ccc0<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 29   Thread 0x7f4a8effd700 <span class="o">(</span>LWP 405827<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a74811da0<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 28   Thread 0x7f4a8f7fe700 <span class="o">(</span>LWP 404586<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a80001b90<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 27   Thread 0x7f4a8ffff700 <span class="o">(</span>LWP 404585<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a88002620<span class="o">)</span>
 ...
<span class="o">(</span>gdb<span class="o">)</span> thread 24
<span class="o">[</span>Switching to thread 24 <span class="o">(</span>Thread 0x7f4aadffb700 <span class="o">(</span>LWP 404582<span class="o">))]</span>
<span class="c">#0  0x00007f4b2b3c7afb in futex_abstimed_wait (cancel=true, private=&lt;optimized out&gt;, abstime=0x0, expected=0, futex=0x7f4a9c002050)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
43            err <span class="o">=</span> lll_futex_wait <span class="o">(</span>futex, expected, private<span class="o">)</span><span class="p">;</span>
<span class="o">(</span>gdb<span class="o">)</span> py-list
334            waiter.acquire<span class="o">()</span>
335            self.__waiters.append<span class="o">(</span>waiter<span class="o">)</span>
336            saved_state <span class="o">=</span> self._release_save<span class="o">()</span>
337            try:    <span class="c"># restore state no matter what (e.g., KeyboardInterrupt)</span>
338                <span class="k">if </span><span class="nb">timeout </span>is None:
<span class="o">&gt;</span>339                    waiter.acquire<span class="o">()</span>
340                    <span class="k">if </span>__debug__:
341                        self._note<span class="o">(</span><span class="s2">"%s.wait(): got it"</span>, self<span class="o">)</span>
342                <span class="k">else</span>:
343                    <span class="c"># Balancing act:  We can't afford a pure busy loop, so we</span>
344                    <span class="c"># have to sleep; but if we sleep the whole timeout time,</span>
<span class="o">(</span>gdb<span class="o">)</span> 
</pre></table></code></div></div></li><li><p>看到大量的线程处于 futex_abstimed_wait 状态，使用py-list查看代码后，发现当前该线程的ioloop处于等待状态，结合htop或者top命令，可以看到当前进程的25个线程大多数线程处于等待调度状态（饥饿状态），分析为server扩容后，单个进程的负载很大程度下降，导致对80~140个范围内的已连接FD不需要频繁的线程上下文切换即可完成处理；</p></li><li>使用gcc debug 可以查看当前CPython的调用栈<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a9c002050<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
<span class="c">#1  do_futex_wait (sem=sem@entry=0x7f4a9c002050, abstime=0x0) at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:223</span>
<span class="c">#2  0x00007f4b2b3c7b8f in __new_sem_wait_slow (sem=0x7f4a9c002050, abstime=0x0) at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:292</span>
<span class="c">#3  0x00007f4b2b3c7c2b in __new_sem_wait (sem=&lt;optimized out&gt;) at ../nptl/sysdeps/unix/sysv/linux/sem_wait.c:28</span>
<span class="c">#4  0x00007f4b2b6e7795 in PyThread_acquire_lock (lock=0x7f4a9c002050, waitflag=1) at /usr/src/debug/Python-2.7.5/Python/thread_pthread.h:323</span>
<span class="c">#5  0x00007f4b2b6eb482 in lock_PyThread_acquire_lock (self=0x7f4b1862a930, args=&lt;optimized out&gt;) at /usr/src/debug/Python-2.7.5/Modules/threadmodule.c:52</span>
<span class="c">#6  0x00007f4b2b6bad40 in call_function (oparg=&lt;optimized out&gt;, pp_stack=0x7f4aadffa060) at /usr/src/debug/Python-2.7.5/Python/ceval.c:4408</span>
<span class="c">#7  PyEval_EvalFrameEx (</span>
 <span class="nv">f</span><span class="o">=</span>f@entry<span class="o">=</span>Frame 0x7f4af4026420, <span class="k">for </span>file /usr/lib64/python2.7/threading.py, line 339, <span class="k">in </span><span class="nb">wait</span> <span class="o">(</span><span class="nv">self</span><span class="o">=</span>&lt;_Condition<span class="o">(</span><span class="nv">_Verbose__verbose</span><span class="o">=</span>False, <span class="nv">_Condition__lock</span><span class="o">=</span>&lt;thread.lock at remote 0x7f4b18756f30&gt;, <span class="nv">acquire</span><span class="o">=</span>&lt;built-in method acquire of thread.lock object at remote 0x7f4b18756f30&gt;, <span class="nv">_Condition__waiters</span><span class="o">=[</span>&lt;thread.lock at remote 0x7f4b1862a3f0&gt;, &lt;thread.lock at remote 0x7f4b10aab750&gt;, &lt;thread.lock at remote 0x7f4b1862adb0&gt;, &lt;thread.lock at remote 0x7f4b1862ab10&gt;, &lt;thread.lock at remote 0x7f4b1862ae50&gt;, &lt;thread.lock at remote 0x7f4b1862abd0&gt;, &lt;thread.lock at remote 0x7f4b1862a4d0&gt;, &lt;thread.lock at remote 0x7f4b1862a930&gt;, &lt;thread.lock at remote 0x7f4b1862a8b0&gt;, &lt;thread.lock at remote 0x7f4b1862ae70&gt;, &lt;thread.lock at remote 0x7f4b1862a530&gt;, &lt;thread.lock at remote 0x7f4b1862ab90&gt;, &lt;thread.lock at remote 0x7f4b1862a8d0&gt;, &lt;thread.lock at remote 0x7f4b1862a9d0&gt;, &lt;thread.lock at remote 0x7f4b1862a150&gt;, &lt;thread.lock at remote 0x7f4b1862a290&gt;, &lt;thread.lock at remote 0x7f4b1862aad0&gt;, &lt;thread.lock at remote 0x7f4b1862ad30&gt;, &lt;thread.lock at r...<span class="o">(</span>truncated<span class="o">)</span>, <span class="nv">throwflag</span><span class="o">=</span>throwflag@entry<span class="o">=</span>0<span class="o">)</span>
 at /usr/src/debug/Python-2.7.5/Python/ceval.c:3040
<span class="c">#8  0x00007f4b2b6bd08d in PyEval_EvalCodeEx (co=&lt;optimized out&gt;, globals=&lt;optimized out&gt;, locals=locals@entry=0x0, args=&lt;optimized out&gt;, argcount=1, kws=0x7f4aa800cd30, kwcount=0, </span>
 <span class="nv">defs</span><span class="o">=</span>0x7f4b1fe30188, <span class="nv">defcount</span><span class="o">=</span>2, <span class="nv">closure</span><span class="o">=</span>closure@entry<span class="o">=</span>0x0<span class="o">)</span> at /usr/src/debug/Python-2.7.5/Python/ceval.c:3640
<span class="c">#9  0x00007f4b2b6ba58c in fast_function (nk=&lt;optimized out&gt;, na=&lt;optimized out&gt;, n=&lt;optimized out&gt;, pp_stack=0x7f4aadffa270, func=&lt;optimized out&gt;)</span>
 at /usr/src/debug/Python-2.7.5/Python/ceval.c:4504
<span class="c">#10 call_function (oparg=&lt;optimized out&gt;, pp_stack=0x7f4aadffa270) at /usr/src/debug/Python-2.7.5/Python/ceval.c:4429</span>
<span class="c">#11 PyEval_EvalFrameEx (</span>
 <span class="nv">f</span><span class="o">=</span>f@entry<span class="o">=</span>Frame 0x7f4aa800cb80, <span class="k">for </span>file /usr/lib64/python2.7/Queue.py, line 168, <span class="k">in </span>get <span class="o">(</span><span class="nv">self</span><span class="o">=</span>&lt;Queue<span class="o">(</span><span class="nv">unfinished_tasks</span><span class="o">=</span>47882, <span class="nv">queue</span><span class="o">=</span>&lt;collections.deque at remote 0x7f4b0fed62f0&gt;, <span class="nv">maxsize</span><span class="o">=</span>0, <span class="nv">all_tasks_done</span><span class="o">=</span>&lt;_Condition<span class="o">(</span><span class="nv">_Verbose__verbose</span><span class="o">=</span>False, <span class="nv">_Condition__lock</span><span class="o">=</span>&lt;thread.lock at remote 0x7f4b18756f30&gt;, <span class="nv">acquire</span><span class="o">=</span>&lt;built-in method acquire of thread.lock object at remote 0x7f4b18756f30&gt;, <span class="nv">_Condition__waiters</span><span class="o">=[]</span>, <span class="nv">release</span><span class="o">=</span>&lt;built-in method release of thread.lock object at remote 0x7f4b18756f30&gt;<span class="o">)</span> at remote 0x7f4b177ab710&gt;, <span class="nv">mutex</span><span class="o">=</span>&lt;thread.lock at remote 0x7f4b18756f30&gt;, <span class="nv">not_full</span><span class="o">=</span>&lt;_Condition<span class="o">(</span><span class="nv">_Verbose__verbose</span><span class="o">=</span>False, <span class="nv">_Condition__lock</span><span class="o">=</span>&lt;thread.lock at remote 0x7f4b18756f30&gt;, <span class="nv">acquire</span><span class="o">=</span>&lt;built-in method acquire of thread.lock object at remote 0x7f4b18756f30&gt;, <span class="nv">_Condition__waiters</span><span class="o">=[]</span>, <span class="nv">release</span><span class="o">=</span>&lt;built-in method release of thread.lock object at remote 0x7f4b18756f30&gt;<span class="o">)</span> at remote 0x7f4b177ab790&gt;, <span class="nv">not_empty</span><span class="o">=</span>&lt;_Condition<span class="o">(</span><span class="nv">_Verbose__verbose</span><span class="o">=</span>False, <span class="nv">_Condition__lock</span><span class="o">=</span>&lt;thread.lock at remote 0x7f4b18756f30&gt;, <span class="nv">acquire</span><span class="o">=</span>&lt;built-in method acquire of thread.lock objec...<span class="o">(</span>truncated<span class="o">)</span>, <span class="nv">throwflag</span><span class="o">=</span>throwflag@entry<span class="o">=</span>0<span class="o">)</span>
 at /usr/src/debug/Python-2.7.5/Python/ceval.c:3040
<span class="c">#12 0x00007f4b2b6bd08d in PyEval_EvalCodeEx (co=&lt;optimized out&gt;, globals=&lt;optimized out&gt;, locals=locals@entry=0x0, args=&lt;optimized out&gt;, argcount=1, kws=0x7f4a9c000d58, kwcount=0, </span>
 <span class="nv">defs</span><span class="o">=</span>0x7f4b1f725800, <span class="nv">defcount</span><span class="o">=</span>2, <span class="nv">closure</span><span class="o">=</span>closure@entry<span class="o">=</span>0x0<span class="o">)</span> at /usr/src/debug/Python-2.7.5/Python/ceval.c:3640
<span class="c">#13 0x00007f4b2b6ba58c in fast_function (nk=&lt;optimized out&gt;, na=&lt;optimized out&gt;, n=&lt;optimized out&gt;, pp_stack=0x7f4aadffa480, func=&lt;optimized out&gt;)</span>
 at /usr/src/debug/Python-2.7.5/Python/ceval.c:4504
<span class="c">#14 call_function (oparg=&lt;optimized out&gt;, pp_stack=0x7f4aadffa480) at /usr/src/debug/Python-2.7.5/Python/ceval.c:4429</span>
</pre></table></code></div></div></li><li>通过调用栈可以看到，频繁出现的线程等待的信号量<code class="language-plaintext highlighter-rouge">/linux/sem_waitcommon.c</code></li><li>如果发现某个线程有问题, 切换到那个线程上, 查看调用栈确定具体的执行步骤, 使用bt 命令:</li><li>py-bt显示出python源码的调用栈, 调用参数, 以及所在行的代码.<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c">#4 Waiting for a lock (e.g. GIL)</span>
<span class="c">#5 Waiting for a lock (e.g. GIL)</span>
<span class="c">#7 Frame 0x7f4af4026420, for file /usr/lib64/python2.7/threading.py, line 339, in wait (self=&lt;_Condition(_Verbose__verbose=False, _Condition__lock=&lt;thread.lock at remote 0x7f4b18756f30&gt;, acquire=&lt;built-in method acquire of thread.lock object at remote 0x7f4b18756f30&gt;, _Condition__waiters=[&lt;thread.lock at remote 0x7f4b1862a3f0&gt;, &lt;thread.lock at remote 0x7f4b10aab750&gt;, &lt;thread.lock at remote 0x7f4b1862adb0&gt;, &lt;thread.lock at remote 0x7f4b1862ab10&gt;, &lt;thread.lock at remote 0x7f4b1862ae50&gt;, &lt;thread.lock at remote 0x7f4b1862abd0&gt;, &lt;thread.lock at remote 0x7f4b1862a4d0&gt;, &lt;thread.lock at remote 0x7f4b1862a930&gt;, &lt;thread.lock at remote 0x7f4b1862a8b0&gt;, &lt;thread.lock at remote 0x7f4b1862ae70&gt;, &lt;thread.lock at remote 0x7f4b1862a530&gt;, &lt;thread.lock at remote 0x7f4b1862ab90&gt;, &lt;thread.lock at remote 0x7f4b1862a8d0&gt;, &lt;thread.lock at remote 0x7f4b1862a9d0&gt;, &lt;thread.lock at remote 0x7f4b1862a150&gt;, &lt;thread.lock at remote 0x7f4b1862a290&gt;, &lt;thread.lock at remote 0x7f4b1862aad0&gt;, &lt;thread.lock at remote 0x7f4b1862ad30&gt;, &lt;thread.lock at r...(truncated)</span>
</pre></table></code></div></div></li></ul><blockquote><p>coredump 如果要进行比较长时间的跟踪, 最好将python程序的进程信息全部coredump出来, 之后对core文件进行分析, 避免影响正在运行的程序. (gdb) generate-core-file 这条命令将当前gdb attach的程序dump到它的运行目录, 名字为core.<pid>, 然后再用gdb 加载这个core文件, 进行打印堆栈, 查看变量等分析, 无需attach到正在运行的程序:</pid></p><p>gdb python core.<pid></pid></p></blockquote><blockquote><p>其他命令 其他命令可以在gdb输入py<TAB><TAB> 看到, 和gdb的命令对应, 例如: (gdb) py py-bt py-list py-print python py-down py-locals py-up python-interactive py-up, py-down 可以用来移动到python调用站的上一个或下一个frame. py-locals 用来打印局部变量 等等等等. gdb里也可以用help命令查看帮助:</TAB></TAB></p></blockquote><blockquote><p>(gdb) help py-print Look up the given python variable name, and print it 在这次追踪过程中, 用gdb-python排除了程序逻辑问题. 然后继续追踪内存泄漏问题:</p></blockquote><ul><li>可以结合mmap，及x\命令查看内存地址和程序计数器寄存器的情况</li></ul><blockquote><p>参考文档 https://github.com/lmacken/pyrasite https://docs.python.org/2/library/gc.html https://www.cnblogs.com/geaozhang/p/7111961.html http://man7.org/linux/man-pages/man7/epoll.7.html https://linux.die.net/man/4/epoll https://blog.csdn.net/ljx0305/article/details/4065058 https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#不可回收对象的例子- https://blog.csdn.net/evsqiezi/article/details/8061176 https://github.com/torvalds/linux/blob/master/net/ipv4/tcp.c https://juejin.im/post/5cfdd44a6fb9a07eb67d83e9 https://blog.csdn.net/haoel/article/details/1602108 https://mg.pov.lt/objgraph/ http://guppy-pe.sourceforge.net/ http://guppy-pe.sourceforge.net/heapy_tutorial.html https://www.cnblogs.com/chengliangsheng/p/3597010.html https://blog.csdn.net/gogoytgo/article/details/64130179</p></blockquote><blockquote><p>https://github.com/google/tcmalloc https://github.com/jemalloc/jemalloc https://blog.csdn.net/junlon2006/article/details/77854898</p></blockquote><h1 id="4-内存占用分析">4. 内存占用分析</h1><ul><li>针对monitor-server的情况<ol><li>进程启动后，创建到权重占比的已连接描述符后（例如2的权重占总连接的80个左右，3.3占130左右），物理内存占用值会稳定到一个确定值，不会一直上涨，所有初步判断并没有循环引用或者内存泄漏；</li><li>在测试环境中，给动态监控的逻辑部分在请求处理完成返回前，做一次全generation的主动垃圾回收，程序启动后，物理内存的占用会有一定的下降，表现为在几个小时呢从700MB到1.5GB之间；</li></ol></li><li><p>初步结论，内存无泄漏且无对象的循环引用，主动的gc回收或者降低阈值并增加垃圾回收的频率，会一定程度的降低进程的物理内存的占用，大概可以下降测试前的20%~30%;</p></li><li>考虑C底层预编译的运行库的内存管理算法</li><li>生产环境的CentOS7.x 64默认提供的C运行库glibc的版本为2.17，其中malloc库的为ptmalloc2</li><li>Google提供的替代品：</li><li>TCMalloc is Google’s customized implementation of C’s malloc() and C++’s operator new used for memory allocation within our C and C++ code. TCMalloc is a fast, multi-threaded malloc implementation.</li><li>https://github.com/google/tcmalloc</li><li>FaceBook提供的替代品：</li><li>jemalloc is a general purpose malloc(3) implementation that emphasizes fragmentation avoidance and scalable concurrency support.</li><li>https://github.com/jemalloc/jemalloc</li><li><p>https://www.facebook.com/jemalloc</p></li><li>生产环境网络进过yum search后，找到了jemalloc X86_64的版本，而且可以直接yum安装，无需再次下载和编译；</li></ul><h1 id="5-最终方案测试">5. 最终方案测试</h1><ul><li><p>在测试环境中，给动态监控的逻辑部分在请求处理完成返回前，做一次全generation的主动垃圾回收；</p></li><li>使用LD_PRELOAD，可以直接用jemalloc代替ptmalloc2，对python代码进行链接执行</li><li>测试方式</li><li>LD_PRELOAD=”/usr/lib64/libjemalloc.so” /home/monitor_server/bin/python /opt/netmon/service/monitor-server/monitor/run_server.py –config-file /opt/netmon/service/monitor-server/monitor/conf/conf.ini –port 51035 » /var/log/monitor-server/server_debug.log 2&gt;&amp;1 &amp;<div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre> root      76913  76489 20 15:36 pts/1    01:17:10 /home/monitor_server/bin/python /opt/netmon/debug/monitor-server/monitor/run_server.py <span class="nt">--config-file</span> /opt/netmon/debug/monitor-server/monitor/conf/conf.ini <span class="nt">--port</span> 51035
 VmRSS:    522232 kB
  76913 root       20   0 1991M  518M  6736 R 113.  0.2  1h17:15 │        └─ python /opt/netmon/debug/monitor-server/monitor/run_server.py <span class="nt">--config-file</span> /opt/netmon/debug/monitor-serve
</pre></table></code></div></div></li><li><p>最终表现</p></li><li>稳定运行15小时的server进行内存占用率维持在0.2%，物理内存的占用为500MB（上下不超过50MB），且添加了主动GC回收后，对单个逻辑核心的5分钟平均占用在50%（估计值）</li></ul><h1 id="6-文档">6. 文档</h1><p><a href="http://ithare.com/testing-memory-allocators-ptmalloc2-tcmalloc-hoard-jemalloc-while-trying-to-simulate-real-world-loads/">第三方模拟真实应用的算法测试-ptmalloc2-tcmalloc-hoard-jemalloc</a> <a href="https://segmentfault.com/a/1190000003063859">I/O多路复用技术的简单介绍</a> <a href=""></a> <a href=""></a> <a href=""></a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E8%AF%AD%E8%A8%80/'>体系结构-语言</a>, <a href='/categories/python/'>Python</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/gdb-gcc-debug/" class="post-tag no-text-decoration" >GDB-gcc-debug</a> <a href="/tags/jemalloc/" class="post-tag no-text-decoration" >jemalloc</a> <a href="/tags/ptmalloc2/" class="post-tag no-text-decoration" >ptmalloc2</a> <a href="/tags/tcmalloc/" class="post-tag no-text-decoration" >TCMalloc</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Python进程内存分析&大量内存占用的优化方案 - TeddyGoodman&url=http://localhost:4000/posts/CPython-malloc-python-gc/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Python进程内存分析&大量内存占用的优化方案 - TeddyGoodman&u=http://localhost:4000/posts/CPython-malloc-python-gc/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Python进程内存分析&大量内存占用的优化方案 - TeddyGoodman&url=http://localhost:4000/posts/CPython-malloc-python-gc/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <!-- The trending tags list v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT Licensed --> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/go/">Go</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/sumof2019/">SumOf2019</a> <a class="post-tag" href="/tags/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/">体系结构</a> <a class="post-tag" href="/tags/rabbitmq/">RabbitMQ</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/cpython/">CPython</a> <a class="post-tag" href="/tags/c%26c%2B%2B/">C&C++</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-3">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="post-extend-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/csapp/" class="btn btn-outline-primary"><p>深入理解计算机系统 [Computer-Systems-A-Programmer's-Perspective]</p></a> <a href="/posts/algorithm-heap/" class="btn btn-outline-primary"><p>algorithm-heap 堆排序的实现</p></a></div><!-- The related posts of current post. Placed in the bottom of every single post. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-4 mb-2 mb-sm-4 pb-2"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/understanding-of-tornado/"><div class="card-body"> <span class="timeago small"> Mar 24, 2020 <i class="unloaded">2020-03-24T10:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>tornado框架学习及源码分析</h3><div class="text-muted small"><p></p></div></div></a></div><div class="card"> <a href="/posts/python-performance-flame-graph/"><div class="card-body"> <span class="timeago small"> Apr 5, 2020 <i class="unloaded">2020-04-05T10:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Python性能分析和火焰图</h3><div class="text-muted small"><p>Python性能分析和火焰图 cProfile和profile为python程序提供的性能分析工具 profile提供一组统计信息，用来描述对于一个函数或者一个代码块的被调用次数或者执行次数和执行所花费的时间； 对于这些统计信息，可以使用python的pstats模块，使用不同类型的参数进行输出，或者使用第三方的模块输入火焰图，例如frameprof； python2.7-c...</p></div></div></a></div><div class="card"> <a href="/posts/python-core/"><div class="card-body"> <span class="timeago small"> Apr 26, 2020 <i class="unloaded">2020-04-26T10:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Python&CPython核心</h3><div class="text-muted small"><p>Python&amp;amp;CPython核心 “生成器与协程、CPython虚拟机原理、CPython解释器原理、内存管理与引用计数与优化、高级第三方库、Python语法魔术” CPython核心 I. 虚拟机工作原理&amp;amp;CPython源代码&amp;amp;工作方式 Evaluation Loop ceval.c Python虚拟机的 核心部分，迭代执行python字节码指令；...</p></div></div></a></div></div></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const el = document.querySelectorAll('#post-wrapper img'); const observer = lozad(el); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/TeddyGoodman">TeddyGoodman</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://github.com" target="_blank">Github.</a></p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted">Trending Tags</h4><!-- The trending tags list v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT Licensed --> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/go/">Go</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/sumof2019/">SumOf2019</a> <a class="post-tag" href="/tags/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/">体系结构</a> <a class="post-tag" href="/tags/rabbitmq/">RabbitMQ</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/cpython/">CPython</a> <a class="post-tag" href="/tags/c%26c%2B%2B/">C&C++</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js" integrity="sha256-qcLR00zq6pJk4je3MLgAri8Nn+ZumUlXgTKR2H/xCY0=" crossorigin="anonymous"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://localhost:4000{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script> <script src="/assets/live2d-widget/autoload.js"></script>
