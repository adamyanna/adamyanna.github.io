<!DOCTYPE html><html lang="en" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Python性能分析和火焰图 | TeddyGoodman</title><meta name="generator" content="Jekyll v4.3.1" /><meta property="og:title" content="Python性能分析和火焰图" /><meta name="author" content="Teddy" /><meta property="og:locale" content="en_US" /><meta name="description" content="Python性能分析和火焰图" /><meta property="og:description" content="Python性能分析和火焰图" /><link rel="canonical" href="http://localhost:4000/posts/python-performance-flame-graph/" /><meta property="og:url" content="http://localhost:4000/posts/python-performance-flame-graph/" /><meta property="og:site_name" content="TeddyGoodman" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-04-05T10:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Python性能分析和火焰图" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@Teddy" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/python-performance-flame-graph/"},"url":"http://localhost:4000/posts/python-performance-flame-graph/","author":{"@type":"Person","name":"Teddy"},"headline":"Python性能分析和火焰图","dateModified":"2020-04-05T10:00:00+08:00","datePublished":"2020-04-05T10:00:00+08:00","description":"Python性能分析和火焰图","@type":"BlogPosting","@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/main.css"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script> window.jQuery || document.write('<script src="/assets/lib/jquery-3.4.1.min.js"><\/script>'); </script> <script src="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha256-5+02zu5UULQkO7w1GIr6vftCgMfFdZcAHeDtFnKZsBs=" crossorigin="anonymous" async></script> <script src="/assets/js/dist/commons.js" async></script> <script src="/assets/js/dist/timeago.min.js" async></script><link rel="preload" as="style" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/syntax.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/syntax.css"><link rel="preload" as="style" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css"><link rel="preload" as="script" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js"><link rel="stylesheet" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css" /> <script src="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js" async></script> <script src="/assets/js/dist/toc.min.js" async></script> <script src="/assets/js/dist/tooltip-loader.min.js" async></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/avatar/avatar.jpg" alt="avatar"> </a></div><div class="profile-text mt-3"><div id="site-title"> <a href="/">TeddyGoodman</a></div><div id="site-subtitle" class="font-italic">-- Cloud Computing Enginer --</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-3 mr-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-3 mr-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-3 mr-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-3 mr-3 unloaded"></i> <span>ARCHIVES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-3 mr-3 unloaded"></i> <span>ABOUT</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <!-- Switch the mode between dark and light. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/TeddyGoodman" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="javascript:window.open('mailto:' + ['teddyynagoodman','gmail.com'].join('@'))"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" target="_blank"> <i class="fas fa-rss"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Python性能分析和火焰图</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Python性能分析和火焰图</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago" data-toggle="tooltip" data-placement="bottom" title="Sun, Apr 5, 2020, 10:00 AM +0800"> Apr 5, 2020 <i class="unloaded">2020-04-05T10:00:00+08:00</i> </span> by <span class="author"> Teddy </span></div></div><div class="post-content"><h1 id="python性能分析和火焰图">Python性能分析和火焰图</h1><h2 id="cprofile和profile为python程序提供的性能分析工具">cProfile和profile为python程序提供的性能分析工具</h2><ul><li>profile提供一组<strong>统计信息</strong>，用来描述对于一个函数或者一个代码块的被调用次数或者执行次数和执行所花费的时间；</li><li>对于这些统计信息，可以使用python的pstats模块，使用不同类型的参数进行输出，或者使用第三方的模块输入火焰图，例如frameprof；</li><li><a href="https://docs.python.org/2/library/profile.html#module-cProfile">python2.7-cProfile</a></li></ul><h2 id="使用方式">使用方式</h2><ul><li>运行命令中添加cProfile模块，来生产统计信息 <code class="language-plaintext highlighter-rouge">python -m cProfile [-o output_file] [-s sort_order] myscript.py</code><ul><li>-o表示程序生命周期结束后的输出文件</li><li>-s表示指定一个参数来进行排序，例如使用函数被调用次数排序ncalls，或者使用累积时间cumtime</li><li>-s参数在有-o输出文件的情况下，不会生效，因为输出文件包含原始的统计数据，需要再次读取和排序</li><li>当程序终止后才能生成文件，对于循环执行的进程或者服务，需要手动发送前台进程强制终止信号；</li></ul></li><li>在程序中导入cProfile使用<div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">cProfile</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="n">cProfile</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="s">'re.compile("foo|bar")'</span><span class="p">)</span>
</pre></table></code></div></div></li></ul><h2 id="实践">实践</h2><ul><li>使用cProfile启动python服务><code class="language-Bash"> cd /opt/netmon/debug/monitor-server/monitor/ /home/monitor_server/bin/python -m cProfile -o result.out /opt/netmon/debug/monitor-server/monitor/run_server.py --config-file /opt/netmon/debug/monitor-server/monitor/conf/conf.ini --port 51035 &gt;&gt; /var/log/monitor-server/server_debug.log 2&gt;&amp;1 </code></li><li>服务启动后，标准输出和标准错误都会追加到/var/log/monitor-server/server_debug.log</li><li>等待后端服务的进程执行一定的时间，例如10~30分钟，已经处理了相当一部分请求，将进程强制终止，得到result.out文件；</li><li>对result.out文件进行输出，可以直接使用python和pstats模块，或者使用脚本输出；</li></ul><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre> <span class="c1">#!/usr/bin/python
</span> 
 <span class="kn">import</span> <span class="nn">pstats</span>
 <span class="kn">import</span> <span class="nn">sys</span>
 
 <span class="n">input_f</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
 <span class="n">p</span> <span class="o">=</span> <span class="n">pstats</span><span class="p">.</span><span class="n">Stats</span><span class="p">(</span><span class="n">input_f</span><span class="p">)</span>
 <span class="c1">#p.sort_stats("cumulative", "name")
</span> <span class="n">p</span><span class="p">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="s">"ncalls"</span><span class="p">,</span> <span class="s">"cumtime"</span><span class="p">)</span>
 <span class="n">p</span><span class="p">.</span><span class="n">print_stats</span><span class="p">()</span>
</pre></table></code></div></div><ul><li>支持的排序方式有：<ul><li>ncalls</li><li>函数或者代码块被调用的次数</li><li>tottime</li><li>在函数中执行所使用的总时长，但是该时间会排除调用子功能所花费的时间</li><li>percall</li><li>tottime 除以 ncalls的商的值</li><li>cumtime</li><li>函数包含其子函数的总累积调用时间，对于递归函数同样适用，为递归函数的全部递归次数的执行总时长</li><li>percall</li><li>cumtime 除以 ncalls 的商的值</li><li>Filename</li><li>每个函数所在文件及开始行号</li></ul></li><li>输出结果：<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre> [root@cnsz036678 monitor]# python output_pstats.py cum.out | head -n 100
 Tue Apr  7 17:10:32 2020    cum.out
 
        13445271 function calls (13371131 primitive calls) in 436.704 seconds
 
  Ordered by: call count, cumulative time
 
  ncalls  tottime  percall  cumtime  percall filename:lineno(function)
 3726996    0.695    0.000    0.716    0.000 {method 'get' of 'dict' objects}
 1710220/1710218    0.565    0.000    0.580    0.000 {isinstance}
 1525540/1524061    0.191    0.000    0.192    0.000 {len}
  959341    1.045    0.000    1.045    0.000 {_codecs.utf_8_decode}
  959298    0.454    0.000    1.499    0.000 /home/monitor_server/lib64/python2.7/encodings/utf_8.py:15(decode)
  706968    0.595    0.000    0.926    0.000 /home/monitor_server/lib/python2.7/site-packages/oslo_config/cfg.py:2940(_get)
  706966    0.476    0.000    1.402    0.000 /home/monitor_server/lib/python2.7/site-packages/oslo_config/cfg.py:2509(__getattr__)
  706958    1.753    0.000    2.011    0.000 /opt/netmon/debug/monitor-server/monitor/core/handlers/device_info_handler.py:36(_format_speed)
  191741    0.034    0.000    0.034    0.000 {method 'append' of 'list' objects}
  176914    0.020    0.000    0.020    0.000 {ord}
  136071    0.042    0.000    0.042    0.000 {method 'seek' of 'cStringIO.StringO' objects}
   71548    0.034    0.000    0.034    0.000 {method 'endswith' of 'str' objects}
   66992    0.024    0.000    0.024    0.000 {method 'readline' of 'cStringIO.StringO' objects}
 59707/7204    0.367    0.000    2.729    0.000 /home/monitor_server/lib/python2.7/site-packages/redis/connection.py:283(read_response)
   59707    0.192    0.000    1.554    0.000 /home/monitor_server/lib/python2.7/site-packages/redis/connection.py:210(readline)
   59707    0.011    0.000    0.011    0.000 /home/monitor_server/lib/python2.7/site-packages/redis/_compat.py:126(byte_to_chr)
   53938    0.022    0.000    0.022    0.000 /home/monitor_server/lib/python2.7/site-packages/redis/connection.py:162(length)
   52878    0.072    0.000    0.393    0.000 {method 'decode' of 'str' objects}
   52564    0.034    0.000    0.034    0.000 {method 'read' of 'cStringIO.StringO' objects}
   52490    0.069    0.000    0.466    0.000 /home/monitor_server/lib/python2.7/site-packages/redis/connection.py:122(decode)
   52482    0.175    0.000    0.313    0.000 /home/monitor_server/lib/python2.7/site-packages/redis/connection.py:193(read)
   51196    0.068    0.000    0.081    0.000 /home/monitor_server/lib64/python2.7/sre_parse.py:183(__next)
   46852    0.030    0.000    0.103    0.000 /home/monitor_server/lib64/python2.7/sre_parse.py:202(get)
   44246    0.019    0.000    0.019    0.000 /home/monitor_server/lib/python2.7/site-packages/yaml/reader.py:87(peek)
   33628    0.020    0.000    0.020    0.000 {getattr}
   26234   15.935    0.001   16.355    0.001 {eval}
   25679    0.013    0.000    0.018    0.000 /home/monitor_server/lib64/python2.7/sre_parse.py:139(append)
 25451/25148    0.030    0.000    0.154    0.000 {method 'join' of 'str' objects}
   25357    0.017    0.000    0.017    0.000 {range}
</pre></table></code></div></div></li><li>该进程接入测试数据进行简单的分析后，初步结论<ul><li>现在通过一些测试，能看出来一部分问题出现的可能，第一是json解析的操作耗时，第二是 IOString 结构体底层的过多的处理，第三是getattr方式来定位对象函数</li><li>需要更多实际生产环境导致程序大量接口超时的数据模拟；</li></ul></li></ul><h2 id="火焰图">火焰图</h2><ul><li>使用flameprof来生成火焰图</li><li>安装<ul><li><code class="language-plaintext highlighter-rouge">pip install flameprof</code></li></ul></li><li>简单使用：<ul><li><code class="language-plaintext highlighter-rouge">flameprof result_2.cum.out &gt; cum.svg</code><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>flameprof <span class="nt">--help</span>
usage: flameprof.py <span class="o">[</span><span class="nt">-h</span><span class="o">]</span> <span class="o">[</span><span class="nt">--width</span> WIDTH] <span class="o">[</span><span class="nt">--row-height</span> ROW_HEIGHT]
              <span class="o">[</span><span class="nt">--font-size</span> FONT_SIZE] <span class="o">[</span><span class="nt">--threshold</span> THRESHOLD]
              <span class="o">[</span><span class="nt">--format</span> <span class="o">{</span>svg,log<span class="o">}]</span> <span class="o">[</span><span class="nt">--log-mult</span> LOG_MULT] <span class="o">[</span><span class="nt">--version</span><span class="o">]</span>
              <span class="o">[</span><span class="nt">-r</span><span class="o">]</span> <span class="o">[</span><span class="nt">-m</span><span class="o">]</span> <span class="o">[</span><span class="nt">--cpu</span><span class="o">]</span> <span class="o">[</span><span class="nt">-o</span> OUT] <span class="o">[</span><span class="nt">--wsgi-out-dir</span> WSGI_OUT_DIR]
              <span class="o">[</span><span class="nt">--wsgi-format</span> WSGI_FORMAT]
              stats
</pre></table></code></div></div></li><li>使用help产看具体用法<ul><li><a href="https://pypi.org/project/flameprof/">pypi-flameprof</a></li><li><a href="http://www.brendangregg.com/flamegraphs.html">flamegraphs</a></li></ul></li></ul></li><li>如何快速看懂火焰图<ul><li><a href="http://www.ruanyifeng.com/blog/2017/09/flame-graph.html">看懂火焰图</a></li></ul></li><li>通常性能分析工具会返回 CPU 正在执行的指令对应的函数名以及调用栈（stack）</li><li>通常，它的执行频率是 99Hz（每秒99次），如果99次都返回同一个函数名，那就说明 CPU 这一秒钟都在执行同一个函数，可能存在性能问题。（CPU每秒执行指令的次数取决于CPU内频和外频以及晶振频率）</li><li>y 轴表示调用栈，每一层都是一个函数。调用栈越深，火焰就越高，顶部就是正在执行的函数，下方都是它的父函数。</li><li>x 轴表示抽样数，如果一个函数在 x 轴占据的宽度越宽，就表示它被抽到的次数多，即执行的时间长。注意，x 轴不代表时间，而是所有的调用栈合并后，按字母顺序排列的。</li><li>火焰图就是看顶层的哪个函数占据的宽度最大。只要有”平顶”（plateaus），就表示该函数可能存在性能问题。</li><li>颜色没有特殊含义，因为火焰图表示的是 CPU 的繁忙程度，所以一般选择暖色调。</li></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E8%AF%AD%E8%A8%80/'>体系结构-语言</a>, <a href='/categories/python/'>Python</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/python/" class="post-tag no-text-decoration" >Python</a> <a href="/tags/flamegraph/" class="post-tag no-text-decoration" >Flamegraph</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Python性能分析和火焰图 - TeddyGoodman&url=http://localhost:4000/posts/python-performance-flame-graph/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Python性能分析和火焰图 - TeddyGoodman&u=http://localhost:4000/posts/python-performance-flame-graph/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Python性能分析和火焰图 - TeddyGoodman&url=http://localhost:4000/posts/python-performance-flame-graph/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <!-- The trending tags list v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT Licensed --> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/go/">Go</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/sumof2019/">SumOf2019</a> <a class="post-tag" href="/tags/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/">体系结构</a> <a class="post-tag" href="/tags/rabbitmq/">RabbitMQ</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/cpython/">CPython</a> <a class="post-tag" href="/tags/c%26c%2B%2B/">C&C++</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-3">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="post-extend-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/golang-performance-flame-graph/" class="btn btn-outline-primary"><p>Golang性能分析和监控</p></a> <a href="/posts/Redis/" class="btn btn-outline-primary"><p>Redis学习及源码分析</p></a></div><!-- The related posts of current post. Placed in the bottom of every single post. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-4 mb-2 mb-sm-4 pb-2"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/understanding-of-tornado/"><div class="card-body"> <span class="timeago small"> Mar 24, 2020 <i class="unloaded">2020-03-24T10:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>tornado框架学习及源码分析</h3><div class="text-muted small"><p></p></div></div></a></div><div class="card"> <a href="/posts/python-core/"><div class="card-body"> <span class="timeago small"> Apr 26, 2020 <i class="unloaded">2020-04-26T10:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Python&CPython核心</h3><div class="text-muted small"><p>Python&amp;amp;CPython核心 “生成器与协程、CPython虚拟机原理、CPython解释器原理、内存管理与引用计数与优化、高级第三方库、Python语法魔术” CPython核心 I. 虚拟机工作原理&amp;amp;CPython源代码&amp;amp;工作方式 Evaluation Loop ceval.c Python虚拟机的 核心部分，迭代执行python字节码指令；...</p></div></div></a></div><div class="card"> <a href="/posts/Python-dynamic-map/"><div class="card-body"> <span class="timeago small"> Mar 24, 2020 <i class="unloaded">2020-03-24T10:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Python实现动态生成类的http接口-monitor动态监控项</h3><div class="text-muted small"><p>项目背景 采集厂商网络硬件设备基础指标，封装OpenFalcon数据结构 参与开发人数：1人 监控系统动态监控 需要实现的目标： 数据库监控表项动态管理监控项数据处理、封装接口 新增监控项由对于处理规则处理，项目的新监控项开发只需要编写规则函数和录入监控项字段即可 1. API 处理和报文解析 项目启动，导入文件...</p></div></div></a></div></div></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const el = document.querySelectorAll('#post-wrapper img'); const observer = lozad(el); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/TeddyGoodman">TeddyGoodman</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://github.com" target="_blank">Github.</a></p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted">Trending Tags</h4><!-- The trending tags list v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT Licensed --> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/go/">Go</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/sumof2019/">SumOf2019</a> <a class="post-tag" href="/tags/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/">体系结构</a> <a class="post-tag" href="/tags/rabbitmq/">RabbitMQ</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/cpython/">CPython</a> <a class="post-tag" href="/tags/c%26c%2B%2B/">C&C++</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js" integrity="sha256-qcLR00zq6pJk4je3MLgAri8Nn+ZumUlXgTKR2H/xCY0=" crossorigin="anonymous"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://localhost:4000{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script> <script src="/assets/live2d-widget/autoload.js"></script>
