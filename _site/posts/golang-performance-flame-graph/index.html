<!DOCTYPE html><html lang="en" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Golang性能分析和监控 | TeddyGoodman</title><meta name="generator" content="Jekyll v4.3.1" /><meta property="og:title" content="Golang性能分析和监控" /><meta name="author" content="Teddy" /><meta property="og:locale" content="en_US" /><meta name="description" content="Golang性能分析和监控" /><meta property="og:description" content="Golang性能分析和监控" /><link rel="canonical" href="http://localhost:4000/posts/golang-performance-flame-graph/" /><meta property="og:url" content="http://localhost:4000/posts/golang-performance-flame-graph/" /><meta property="og:site_name" content="TeddyGoodman" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-04-05T10:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Golang性能分析和监控" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@Teddy" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/golang-performance-flame-graph/"},"url":"http://localhost:4000/posts/golang-performance-flame-graph/","author":{"@type":"Person","name":"Teddy"},"headline":"Golang性能分析和监控","dateModified":"2020-04-05T10:00:00+08:00","datePublished":"2020-04-05T10:00:00+08:00","description":"Golang性能分析和监控","@type":"BlogPosting","@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/main.css"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script> window.jQuery || document.write('<script src="/assets/lib/jquery-3.4.1.min.js"><\/script>'); </script> <script src="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha256-5+02zu5UULQkO7w1GIr6vftCgMfFdZcAHeDtFnKZsBs=" crossorigin="anonymous" async></script> <script src="/assets/js/dist/commons.js" async></script> <script src="/assets/js/dist/timeago.min.js" async></script><link rel="preload" as="style" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/syntax.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/syntax.css"><link rel="preload" as="style" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css"><link rel="preload" as="script" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js"><link rel="stylesheet" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css" /> <script src="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js" async></script> <script src="/assets/js/dist/toc.min.js" async></script> <script src="/assets/js/dist/tooltip-loader.min.js" async></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/avatar/avatar.jpg" alt="avatar"> </a></div><div class="profile-text mt-3"><div id="site-title"> <a href="/">TeddyGoodman</a></div><div id="site-subtitle" class="font-italic">-- Cloud Computing Enginer --</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-3 mr-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-3 mr-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-3 mr-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-3 mr-3 unloaded"></i> <span>ARCHIVES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-3 mr-3 unloaded"></i> <span>ABOUT</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper"> <!-- Switch the mode between dark and light. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border"></span> <a href="https://github.com/TeddyGoodman" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="javascript:window.open('mailto:' + ['teddyynagoodman','gmail.com'].join('@'))"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" target="_blank"> <i class="fas fa-rss"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Golang性能分析和监控</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Golang性能分析和监控</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago" data-toggle="tooltip" data-placement="bottom" title="Sun, Apr 5, 2020, 10:00 AM +0800"> Apr 5, 2020 <i class="unloaded">2020-04-05T10:00:00+08:00</i> </span> by <span class="author"> Teddy </span></div></div><div class="post-content"><h1 id="golang性能分析和监控">Golang性能分析和监控</h1><h2 id="tool-pprof-和-package-pprof">tool pprof 和 package pprof</h2><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>* [pprof](https://golang.org/pkg/runtime/pprof/)
* 通过HTTP服务提供运行时的性能分析数据（统计数据）
* 通过使用go tool pprof可以对数据进行特殊的格式化，以满足分析需求
* 包导入的方式
    * `import "net/http/pprof"`
* http定位器访问方式
    * `/debug/pprof`
</pre></table></code></div></div><h2 id="实践过程">实践过程</h2><div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

 <span class="c">//c := make(chan os.Signal)</span>
 <span class="c">//signal.Notify(c)</span>

 <span class="n">binaryAbsPath</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">Abs</span><span class="p">(</span><span class="n">filepath</span><span class="o">.</span><span class="n">Dir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">0</span><span class="p">]))</span>

 <span class="c">// @ golang performance test</span>
 <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"[monitor-patrol] Performance CPU, %s/cpu_monitor.prof...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">filepath</span><span class="o">.</span><span class="n">Dir</span><span class="p">(</span><span class="n">binaryAbsPath</span><span class="p">))</span>
 <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"[monitor-patrol] Performance MEM, %s/mem_monitor.prof...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">filepath</span><span class="o">.</span><span class="n">Dir</span><span class="p">(</span><span class="n">binaryAbsPath</span><span class="p">))</span>
 <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"[monitor-patrol] Performance monitor, contect to 127.0.0.1:8080 to check...</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

 <span class="n">cpuProFile</span> <span class="o">:=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">Dir</span><span class="p">(</span><span class="n">binaryAbsPath</span><span class="p">)</span> <span class="o">+</span> <span class="s">"/cpu_monitor.prof"</span>
 <span class="n">memProFile</span> <span class="o">:=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">Dir</span><span class="p">(</span><span class="n">binaryAbsPath</span><span class="p">)</span> <span class="o">+</span> <span class="s">"/mem_monitor.prof"</span>

 <span class="c">// @ Windows debug</span>
 <span class="c">//cpuProFile := "./cpu_monitor.prof"</span>
 <span class="c">//memProFile := "./mem_monitor.prof"</span>

 <span class="n">f</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">cpuProFile</span><span class="p">)</span>
 <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"could not create CPU profile: %s"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">pprof</span><span class="o">.</span><span class="n">StartCPUProfile</span><span class="p">(</span><span class="n">f</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>  <span class="c">//监控cpu</span>
  <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"could not start CPU profile: %s"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
 <span class="p">}</span>

 <span class="n">runtime</span><span class="o">.</span><span class="n">GOMAXPROCS</span><span class="p">(</span><span class="n">runtime</span><span class="o">.</span><span class="n">NumCPU</span><span class="p">())</span>


 <span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">"0.0.0.0:8080"</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
 <span class="p">}()</span>

 <span class="n">pg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">program</span><span class="p">{}</span>
 <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">svc</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span> <span class="n">syscall</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">syscall</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">syscall</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">,</span> <span class="n">syscall</span><span class="o">.</span><span class="n">SIGQUIT</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"run exit with err:%s"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
  <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Main END</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
  <span class="c">//</span>
  <span class="n">pprof</span><span class="o">.</span><span class="n">StopCPUProfile</span><span class="p">()</span>
  <span class="c">//</span>
  <span class="n">f</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">memProFile</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
   <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"could not create memory profile: %s"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">runtime</span><span class="o">.</span><span class="n">GC</span><span class="p">()</span> <span class="c">// GC，获取最新的数据信息</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">pprof</span><span class="o">.</span><span class="n">WriteHeapProfile</span><span class="p">(</span><span class="n">f</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>  <span class="c">// 写入内存信息</span>
   <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"could not write memory profile: %s"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">f</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
  <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Main END</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
  <span class="c">//</span>
  <span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
 <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="n">log</span><span class="o">.</span><span class="n">Logger</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"bye :-)"</span><span class="p">)</span>
 <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="方式一">方式一</h3><ul><li>使用方式是通过import直接导入 <code class="language-plaintext highlighter-rouge">_ "net/http/pprof"</code></li><li>然后通过http的package直接启动监听服务 <code class="language-plaintext highlighter-rouge">http.ListenAndServe()</code></li><li>通过浏览器可以直接访问 <code class="language-plaintext highlighter-rouge">http://ip:port/debug/pprof</code> 来查看当前的性能采样情况</li></ul><h3 id="方式二">方式二</h3><ul><li>通过 io package的writer，创建并调用i/o写入性能采样数据 <code class="language-plaintext highlighter-rouge">pprof.StartCPUProfile(f)</code> <code class="language-plaintext highlighter-rouge">pprof.WriteHeapProfile(f)</code></li><li>程序结束退出后，可以直接访问生成的cpu和heap文件</li></ul><h5 id="debugpprof-内容">debug/pprof 内容</h5><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre>/debug/pprof/

Types of profiles available:
Count Profile
4 allocs
0 block
0 cmdline
1054 goroutine
4 heap
0 mutex
0 profile
13 threadcreate
0 trace
full goroutine stack dump 
Profile Descriptions:

allocs: A sampling of all past memory allocations
block: Stack traces that led to blocking on synchronization primitives
cmdline: The command line invocation of the current program
goroutine: Stack traces of all current goroutines
heap: A sampling of memory allocations of live objects. You can specify the gc GET parameter to run GC before taking the heap sample.
mutex: Stack traces of holders of contended mutexes
profile: CPU profile. You can specify the duration in the seconds GET parameter. After you get the profile file, use the go tool pprof command to investigate the profile.
threadcreate: Stack traces that led to the creation of new OS threads
trace: A trace of execution of the current program. You can specify the duration in the seconds GET parameter. After you get the trace file, use the go tool trace command to investigate the trace.
</pre></table></code></div></div><ul><li>allocs<ul><li>对程序声明周期内所有分配的内存的抽样</li></ul></li><li>block<ul><li>因为堆栈跟踪导致对“同步原语”的阻塞</li></ul></li><li>cmdline<ul><li>当前程序的命令行调用</li></ul></li><li>goroutine<ul><li>当前所有的go协程的堆栈追踪</li></ul></li><li>heap<ul><li>当前堆内存中处于“存活”状态的对象的抽样，可以在运行抽样，特别的指定想要垃圾回收的对象</li></ul></li><li>mutex<ul><li>对“互斥锁”的持有对象的堆栈跟踪</li></ul></li><li>profile<ul><li>CPU 的性能描述数据</li><li>如果使用了StartCPUProfile写入文件的方式，在http服务中无法下载该文件，对该文件的查看方式</li><li>使用 <code class="language-plaintext highlighter-rouge">go tool pprof</code> 命令进入交互式环境，使用top命令查看调用时长等；<ul><li>典型的命令<ul><li>top Outputs top entries in text form</li><li>web Visualize graph through web browser</li><li>call_tree Create a context-sensitive call tree</li><li>list Output annotated source for functions matching regexp</li></ul></li><li>使用<code class="language-plaintext highlighter-rouge">help</code>命令查看详情</li><li>使用<code class="language-plaintext highlighter-rouge">web</code>命令生成可视化的svg调用树，也可以使用<code class="language-plaintext highlighter-rouge">web Func</code>来过滤执行函数相关的调用树；<blockquote><p>CentOS下必须安装 xdg-utils 和 graphviz</p></blockquote></li><li>top+[数量值]，可以查看占用CPU采样时间的函数的行数，例如默认top为top10，就只看占用CPU采样时间最长的10个函数调用；</li><li>组合使用：<ol><li>使用top命令找到占据CPU采样时间最多的函数调用</li><li>再通过 web 函数名 生成该函数的调用树的图谱，查看调用关系，找到调用该函数的父级函数</li><li>使用 list 父级函数 查看该函数的具体代码实现，通过对函数内部使用的数据结构和处理判断对CPU发生大量占用的点；</li><li>思路：通过结合top和web命令找到导致占用大量抽样的关键函数，分析函数内部实现，和其涉及到的数据结构和算法；对该函数的优化可以结合go test benchmark的基准测试来测试优化后的性能；><code class="language-Bash"> [root@CNSZ049589 /]# go tool pprof optcpu_monitor.prof File: libc-2.17.so Build ID: 8b2c421716985b927aa0caf2a05d0b1f452367f7 Type: cpu Time: Nov 11, 2019 at 6:07pm (CST) Duration: 3.89s, Total samples = 22.57s (580.86%) Entering interactive mode (type "help" for commands, "o" for options) (pprof) top Showing nodes accounting for 12980ms, 57.51% of 22570ms total Dropped 254 nodes (cum &lt;= 112.85ms) Showing top 10 nodes out of 132 flat flat% sum% cum cum% 4470ms 19.81% 19.81% 4500ms 19.94% runtime.chanrecv 2260ms 10.01% 29.82% 6730ms 29.82% runtime.selectnbrecv 1290ms 5.72% 35.53% 1330ms 5.89% encoding/json.stateInString 1060ms 4.70% 40.23% 2190ms 9.70% encoding/json.(*decodeState).scanWhile 930ms 4.12% 44.35% 2020ms 8.95% encoding/json.checkValid 620ms 2.75% 47.10% 7100ms 31.46% encoding/json.(*decodeState).object 600ms 2.66% 49.76% 3810ms 16.88% code.test.com.cn/test-monitor/monitor/monitor-patrol/handler/analyzer.UploadEventToDB 600ms 2.66% 52.41% 1630ms 7.22% runtime.scanobject 580ms 2.57% 54.98% 580ms 2.57% runtime.memmove 570ms 2.53% 57.51% 4090ms 18.12% code.test.com.cn/test-monitor/monitor/monitor-patrol/handler/analyzer.UploadMonitorCoverageData </code></li></ol></li></ul></li></ul></li><li>threadcreate<ul><li>对于从操作系统创建的新的线程的堆栈堆栈跟踪</li></ul></li><li><p>当前程序执行的跟踪。 您可以在秒GET参数中指定持续时间。 获取跟踪文件后，使用go工具trace命令调查跟踪。</p></li><li>内存分析<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>[root@CNSZ049589 /]# go tool pprof optmem_monitor.prof 
File: libc-2.17.so
Build ID: 8b2c421716985b927aa0caf2a05d0b1f452367f7
Type: inuse_space
Time: Nov 11, 2019 at 6:07pm (CST)
Entering interactive mode (type "help" for commands, "o" for options)
(pprof) top
Showing nodes accounting for 573.38MB, 98.95% of 579.46MB total
Dropped 32 nodes (cum &lt;= 2.90MB)
Showing top 10 nodes out of 27
    flat  flat%   sum%        cum   cum%
173.51MB 29.94% 29.94%   184.01MB 31.76%  encoding/json.(*decodeState).literalStore
158.42MB 27.34% 57.28%   158.42MB 27.34%  reflect.unsafe_NewArray
105.63MB 18.23% 75.51%   105.63MB 18.23%  code.test.com.cn/test-monitor/monitor/monitor-patrol/handler/analyzer.(*DataContainer).AppendMetricList
    64MB 11.05% 86.56%   201.35MB 34.75%  code.test.com.cn/test-monitor/monitor/monitor-patrol/handler/analyzer.(*Analyzer).DataDistribution
 23.72MB  4.09% 90.65%    29.72MB  5.13%  sync.(*Map).Store
 20.76MB  3.58% 94.23%    20.76MB  3.58%  code.test.com.cn/test-monitor/monitor/monitor-patrol/vendor/github.com/streadway/amqp.(*Channel).recvContent
 10.50MB  1.81% 96.04%    10.50MB  1.81%  encoding/json.(*decodeState).convertNumber
  8.34MB  1.44% 97.48%     8.34MB  1.44%  code.test.com.cn/test-monitor/monitor/monitor-patrol/vendor/github.com/streadway/amqp.(*reader).parseBodyFrame
  5.50MB  0.95% 98.43%     5.50MB  0.95%  sync.newEntry (inline)
     3MB  0.52% 98.95%        3MB  0.52%  runtime.malg
</pre></table></code></div></div></li><li>memprofile 就是堆采样数据，使用参数结合 go tool pprof 来查看内存情况<ul><li>–inuse_objects 来显示使用的堆的对象的个数</li><li>–alloc_objects 分配的堆对象个数</li><li>–alloc_space 分配的堆内存大小</li></ul></li><li>使用web 生成可视化文件，查看内存分配；</li></ul><h3 id="prometheus">Prometheus</h3><ul><li>Prometheus client内置了golang metrics暴露的handler，只需要简单调用即可实现</li><li>使用metrics即可定位metrics指标的采集数据</li><li>使用模块<strong>“github.com/zsais/go-gin-prometheus”</strong> ```golang package main</li></ul><p>import ( “github.com/prometheus/client_golang/prometheus/promhttp” “net/http” )</p><p>func main() { http.Handle(“/metrics”, promhttp.Handler()) panic(http.ListenAndServe(“:9090”, nil)) } ```</p><ul><li>访问http://localhost:9090/metrics 即可。</li><li>同时可以通过Prometheus来采集此Endpoint暴露出来的数据，也可以进行自定义数据的采集<ul><li>prometheus修改yaml配置文件，增加新的job和job指标静态描述</li><li>进行配置重载 <code class="language-plaintext highlighter-rouge">curl -X POST http://ip:port/-/reload</code></li></ul></li><li>参考文档<ul><li>https://blog.pvincent.io/2017/12/prometheus-blog-series-part-4-instrumenting-code-in-go-and-java/</li></ul></li></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E8%AF%AD%E8%A8%80/'>体系结构-语言</a>, <a href='/categories/golang/'>Golang</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/go/" class="post-tag no-text-decoration" >Go</a> <a href="/tags/go-pprof/" class="post-tag no-text-decoration" >Go-pprof</a> <a href="/tags/flamegraph/" class="post-tag no-text-decoration" >Flamegraph</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Golang性能分析和监控 - TeddyGoodman&url=http://localhost:4000/posts/golang-performance-flame-graph/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Golang性能分析和监控 - TeddyGoodman&u=http://localhost:4000/posts/golang-performance-flame-graph/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Golang性能分析和监控 - TeddyGoodman&url=http://localhost:4000/posts/golang-performance-flame-graph/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <!-- The trending tags list v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT Licensed --> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/go/">Go</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/sumof2019/">SumOf2019</a> <a class="post-tag" href="/tags/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/">体系结构</a> <a class="post-tag" href="/tags/rabbitmq/">RabbitMQ</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/cpython/">CPython</a> <a class="post-tag" href="/tags/c%26c%2B%2B/">C&C++</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-3">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="post-extend-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/b-tree-and-indexing-principle/" class="btn btn-outline-primary"><p>红黑树&B树应用及索引原理</p></a> <a href="/posts/python-performance-flame-graph/" class="btn btn-outline-primary"><p>Python性能分析和火焰图</p></a></div><!-- The related posts of current post. Placed in the bottom of every single post. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-4 mb-2 mb-sm-4 pb-2"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/golang-core/"><div class="card-body"> <span class="timeago small"> Apr 26, 2020 <i class="unloaded">2020-04-26T10:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Golang核心</h3><div class="text-muted small"><p>Golang核心 Go 类型决断和Reflect和Select</p></div></div></a></div><div class="card"> <a href="/posts/Prometheus/"><div class="card-body"> <span class="timeago small"> Apr 6, 2020 <i class="unloaded">2020-04-06T10:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Prometheus</h3><div class="text-muted small"><p>Prometheus prometheus.io Prometheus生态系统架构图 ecosystem components architecture 基本流程： Prometheus Server从“采集器” Jobs / Exporters 中收集指标数据 Server同时会从推送网关“收集” 生命周期较短的任务采集指标 ...</p></div></div></a></div><div class="card"> <a href="/posts/redis_data_sampling/"><div class="card-body"> <span class="timeago small"> May 13, 2020 <i class="unloaded">2020-05-13T14:54:35+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Data Sampling [Redis]</h3><div class="text-muted small"><p>监控覆盖率检查和数据完整性检查【2020-4】 方案一，单节点 方案二，可横向扩展集群 ![]({{ “/assets/img/posts/redis_data_sampling_1.png” relative_url }}) 方案： monitor-torrent负责与redis保持连接，对应key更新当前数据value和...</p></div></div></a></div></div></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const el = document.querySelectorAll('#post-wrapper img'); const observer = lozad(el); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/TeddyGoodman">TeddyGoodman</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://github.com" target="_blank">Github.</a></p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted">Trending Tags</h4><!-- The trending tags list v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT Licensed --> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/algorithm/">Algorithm</a> <a class="post-tag" href="/tags/go/">Go</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/sumof2019/">SumOf2019</a> <a class="post-tag" href="/tags/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/">体系结构</a> <a class="post-tag" href="/tags/rabbitmq/">RabbitMQ</a> <a class="post-tag" href="/tags/network/">Network</a> <a class="post-tag" href="/tags/cpython/">CPython</a> <a class="post-tag" href="/tags/c%26c%2B%2B/">C&C++</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js" integrity="sha256-qcLR00zq6pJk4je3MLgAri8Nn+ZumUlXgTKR2H/xCY0=" crossorigin="anonymous"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://localhost:4000{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script> <script src="/assets/live2d-widget/autoload.js"></script>
