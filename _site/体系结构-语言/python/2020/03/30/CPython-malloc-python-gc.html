<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-translate-customization" content="108d9124921d80c3-80e20d618ff053c8-g4f02ec6f3dba68b7-c">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Python进程内存分析&amp;大量内存占用的优化方案 | Adam Yan Na Blog</title>
<meta name="generator" content="Jekyll v4.3.2">
<meta property="og:title" content="Python进程内存分析&amp;大量内存占用的优化方案">
<meta name="author" content="Teddy">
<meta property="og:locale" content="en_US">
<meta name="description" content="Python进程内存分析&amp;大量内存占用的优化方案">
<meta property="og:description" content="Python进程内存分析&amp;大量内存占用的优化方案">
<link rel="canonical" href="http://localhost:4000/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E8%AF%AD%E8%A8%80/python/2020/03/30/CPython-malloc-python-gc.html">
<meta property="og:url" content="http://localhost:4000/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E8%AF%AD%E8%A8%80/python/2020/03/30/CPython-malloc-python-gc.html">
<meta property="og:site_name" content="Adam Yan Na Blog">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2020-03-30T00:00:00+08:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Python进程内存分析&amp;大量内存占用的优化方案">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Teddy"},"dateModified":"2020-03-30T00:00:00+08:00","datePublished":"2020-03-30T00:00:00+08:00","description":"Python进程内存分析&amp;大量内存占用的优化方案","headline":"Python进程内存分析&amp;大量内存占用的优化方案","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E8%AF%AD%E8%A8%80/python/2020/03/30/CPython-malloc-python-gc.html"},"url":"http://localhost:4000/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E8%AF%AD%E8%A8%80/python/2020/03/30/CPython-malloc-python-gc.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="icon" href="">
  <link rel="canonical" href="http://localhost:4000">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-noto-sans@0.0.72/index.min.css">
  <link rel="stylesheet" href="/assets/css/main.css">
  <script src="/assets/js/main.js"></script><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Adam Yan Na Blog">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
<!-- and it's easy to individually load additional languages -->
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/go.min.js" async></script>



















<script>
// Init highlight js
document.addEventListener('DOMContentLoaded', function(event) {
  var els = document.querySelectorAll('pre code')

  function addLangData(block) {
    var outer = block.parentElement.parentElement.parentElement;
    var lang = block.getAttribute('data-lang');
    for (var i = 0; i < outer.classList.length; i++) {
      var cls = outer.classList[i];
      if (cls.startsWith('language-')) {
        lang = cls;
        break;
      }
    }
    if (!lang) {
      cls = block.getAttribute('class');
      lang = cls ? cls.replace('hljs ', '') : '';
    }
    if (lang.startsWith('language-')) {
      lang = lang.substr(9);
    }
    block.setAttribute('class', 'hljs ' + lang);
    block.parentNode.setAttribute('data-lang', lang);
  }

  function addBadge(block) {
    var enabled = ('true' || 'true').toLowerCase();
    if (enabled == 'true') {
      var pre = block.parentElement;
      pre.classList.add('badge');
    }
  }

  function handle(block) {
    addLangData(block);
    addBadge(block)
    hljs.highlightBlock(block);
  }

  for (var i = 0; i < els.length; i++) {
    var el = els[i];
    handle(el);
  }
});
</script>

<style>
  /* code language badge */
  pre.badge::before {
    content: attr(data-lang);
    color: #fff;
    background-color: #ff4e00;
    padding: 0 .5em;
    border-radius: 0 2px;
    text-transform: uppercase;
    text-align: center;
    min-width: 32px;
    display: inline-block;
    position: absolute;
    right: 0;
  }

  /* fix wrong badge display for firefox browser */
  code > table pre::before {
    display: none;
  }
</style>
<script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/umd/photoswipe-lightbox.umd.min.js" async></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/umd/photoswipe.umd.min.js" async></script>
<link href="//cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/photoswipe.min.css" rel="stylesheet">
<style>
  .pswp .pswp__container .pswp__img {
    background-color: white;
  }
</style>

<script>
  function initPhotoSwipe() {
    let customOptions = {};

    try {
      const data = ``.replaceAll("=>", ":");
      customOptions = JSON.parse(data);
    } catch (e) {
      console.info("Invalid custom photo previewer options! " + e.message);
    }

    // Define object and gallery options
    const options = Object.assign(
      {
        gallery: "section.main",
        children: "a.photo-swipe",
        photo_scale: 2,
        // dynamic import is not supported in UMD version
        pswpModule: PhotoSwipe,
      },
      customOptions
    );

    const galleryEl = document.querySelector(options.gallery);
    if (!galleryEl) {
      return;
    }

    const imgEls = [];
    const els = galleryEl.querySelectorAll("img:not(.emoji)");
    els.forEach((el) => {
      if (el.src.trim() == "") {
        return;
      }
      if (!imgEls.includes(el)) {
        imgEls.push(el);
      }
    });

    if (imgEls.length === 0) {
      return;
    }

    imgEls.forEach((imgEl) => {
      imgEl.outerHTML = `
      <a class="photo-swipe"
        href="${imgEl.src}"
        data-pswp-width="${
          Math.max(imgEl.naturalWidth, imgEl.width) * options.photo_scale
        }"
        data-pswp-height="${
          Math.max(imgEl.naturalHeight, imgEl.height) * options.photo_scale
        }"
        data-pswp-caption="${imgEl.getAttribute("caption") || imgEl.alt}"
        target="_blank">
        ${imgEl.outerHTML}
      </a>`;
    });

    // Initialize PhotoSwipe 5
    var lightbox = new PhotoSwipeLightbox(options);

    lightbox.init();
  }

  window.addEventListener("load", initPhotoSwipe);
</script>
</head>
<body>



























































































































<header class="site-header " role="banner">

  <div class="wrapper">
    <div class="site-header-inner">
<span class="site-brand"><a class="site-brand-inner" rel="author" href="/">
  <img class="site-favicon" title="Adam Yan Na Blog" src="" onerror="this.style.display='none'">
  Adam Yan Na Blog
</a>
</span><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger">
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewbox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
              </svg>
            </span>
          </label>

          <div class="trigger">
<a class="page-link" href="/about.html">ABOUT</a><a class="page-link" href="/archives.html">ARCHIVES</a><a class="page-link" href="/categories.html">CATEGORIES</a><a class="page-link" href="/">HOME</a><a class="page-link" href="/tags.html">TAGS</a>









<span class="page-link">



<div id="google_translate_element" style="display: none;">
</div>

<span class="ct-language">
  <ul class="list-unstyled ct-language-dropdown">
    
      <li>
        <a href="#" class="lang-select" data-lang="en">
          
          <img src="https://cdn.countryflags.com/thumbs/united-states-of-america/flag-400.png" title="English">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="fr">
          
          <img src="https://cdn.countryflags.com/thumbs/france/flag-400.png" title="French">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="zh-CN">
          
          <img src="https://cdn.countryflags.com/thumbs/china/flag-400.png" title="Chinese(Simple)">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="ja">
          
          <img src="https://cdn.countryflags.com/thumbs/japan/flag-400.png" title="Japanese">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="ko">
          
          <img src="https://cdn.countryflags.com/thumbs/south-korea/flag-400.png" title="Korean">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="ru">
          
          <img src="https://cdn.countryflags.com/thumbs/russia/flag-400.png" title="Russian">
          
        </a>
      </li>
    
  </ul>
</span>

<script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({
    pageLanguage: 'en',
    autoDisplay: false,
    layout: google.translate.TranslateElement.InlineLayout.VERTICAL
  }, 'google_translate_element');

  // Links to cross-origin destinations are unsafe
  var gll = document.getElementsByClassName('goog-logo-link')[0];
  if (gll) {
    gll.setAttribute('rel', 'noopener');
  }

  function restoreLang() {
    var iframe = document.getElementsByClassName('goog-te-banner-frame')[0];
    if (!iframe) return;

    var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
    var restore_el = innerDoc.getElementsByTagName("button");

    for (var i = 0; i < restore_el.length; i++) {
      if (restore_el[i].id.indexOf("restore") >= 0) {
        restore_el[i].click();
        var close_el = innerDoc.getElementsByClassName("goog-close-link");
        close_el[0].click();
        return;
      }
    }
  }

  function triggerHtmlEvent(element, eventName) {
    var event;
    if (document.createEvent) {
      event = document.createEvent('HTMLEvents');
      event.initEvent(eventName, true, true);
      element.dispatchEvent(event);
    } else {
      event = document.createEventObject();
      event.eventType = eventName;
      element.fireEvent('on' + event.eventType, event);
    }
  }

  var googleCombo = document.querySelector("select.goog-te-combo");
  var langSelect = document.querySelector('.ct-language');
  langSelect.addEventListener('click', function(event) {
    if (!event.target) {
      return;
    }

    var selected = document.querySelector('.ct-language .ct-language-selected');
    if (selected) {
      selected.classList.remove('ct-language-selected');
    }

    var target = event.target;
    while (target && target !== langSelect ) {
      if (target.matches('.lang-select')) {
        break;
      }
      target = target.parentElement;
    }

    if (target && target.matches('.lang-select')) {
      var lang = target.getAttribute('data-lang');
      if (googleCombo.value == lang) {
        restoreLang();
      } else {
        target.parentElement.classList.add('ct-language-selected');
        googleCombo.value = lang;
        triggerHtmlEvent(googleCombo, 'change');
      }
    }

    event.preventDefault();
  });
}
</script>

<script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" async></script>
</span>
</div>
        </nav>
</div>
  </div>
</header>

<script>
  function initHeader() {
    var lastScrollY = getScrollPos().y;
    var documentElement = document.documentElement;

    function storeScrollData() {
      var y = getScrollPos().y;var scrollStatus = "";

      if (y <= 0) {
        scrollStatus = "top";
      } else if ((window.innerHeight + y) >= document.body.offsetHeight) {
        scrollStatus = "bottom";
      } else {
        var isScrollDown = (y - lastScrollY > 0) ? true : false;
        scrollStatus = isScrollDown ? "down" : "up";
      }

      lastScrollY = y;
      documentElement.setAttribute("data-scroll-status", scrollStatus);
    }

    window.addEventListener('scroll', function(e) {
      storeScrollData();
    });

    storeScrollData();
  }
  document.addEventListener('DOMContentLoaded', initHeader);
</script>
















































































































































<script>
  function hashLocate(hashValue) {
    hashValue = hashValue.replace(/^.*#h-/, '');
    hashValue = decodeURIComponent(hashValue);
    var element = document.getElementById(hashValue);

    if (!element) {
      return;
    }

    var header = document.querySelector('header.site-header');
    var headerRect = header.getBoundingClientRect();
    var headerTop = Math.floor(headerRect.top);
    var headerHeight = Math.floor(headerRect.height);
    var scrollPos = getScrollPos();
    var offsetY = element.offsetTop - (headerTop + headerHeight + 20);

    if (offsetY == scrollPos.y) {
      return;
    }

    if (headerTop == 0  && offsetY > scrollPos.y) {
      offsetY += headerHeight + 2;
    } else if (headerTop < 0  && offsetY < scrollPos.y) {
      offsetY -= headerHeight - 2;
    }

    smoothScrollTo(offsetY);
  }

  // The first event occurred
  window.addEventListener('load', function(event) {
    if (window.location.hash) {
      hashLocate(window.location.hash);
    }
  });

  // The first event occurred
  window.addEventListener('click', function(event) {
    if (event.target.tagName.toLowerCase() == 'a') {
      hashLocate(event.target.getAttribute('href'));
    }
  });
</script>
<div class="theme-toggle">
  <input type="checkbox" id="theme-switch">
  <label for="theme-switch">
    <div class="toggle"></div>
    <div class="names">
      <p class="light">Light</p>
      <p class="dark">Dark</p>
    </div>
  </label>
</div>




<script>
  (function() {
    var sw = document.getElementById('theme-switch');
    var html = document.getElementsByTagName('html')[0];
    var nightModeOption = ('auto' || 'auto').toLowerCase();
    var storage = nightModeOption === 'manual'
        ? localStorage
        : sessionStorage;
    var themeData = loadThemeData();

    function saveThemeData(data) {
      storage.setItem('theme', JSON.stringify(data));
    }

    function loadThemeData() {
      var data = storage.getItem('theme');
      try {
        data = JSON.parse(data ? data : '');
      } catch(e) {
        data = { nightShift: undefined, autoToggleAt: 0 };
        saveThemeData(data);
      }
      return data;
    }

    function handleThemeToggle(nightShift) {
      themeData.nightShift = nightShift;
      saveThemeData(themeData);
      html.dataset.theme = nightShift ? 'dark' : 'light';
      setTimeout(function() {
        sw.checked = nightShift ? true : false;
      }, 50);
    }

    function autoThemeToggle() {
      // Next time point of theme toggle
      var now = new Date();
      var toggleAt = new Date();
      var hours = now.getHours();
      var nightShift = hours >= 19 || hours <=7;

      if (nightShift) {
        if (hours > 7) {
          toggleAt.setDate(toggleAt.getDate() + 1);
        }
        toggleAt.setHours(7);
      } else {
        toggleAt.setHours(19);
      }

      toggleAt.setMinutes(0);
      toggleAt.setSeconds(0);
      toggleAt.setMilliseconds(0)

      var delay = toggleAt.getTime() - now.getTime();

      // auto toggle theme mode
      setTimeout(function() {
        handleThemeToggle(!nightShift);
      }, delay);

      return {
        nightShift: nightShift,
        toggleAt: toggleAt.getTime()
      };
    }

    // Listen the theme toggle event
    sw.addEventListener('change', function(event) {
      handleThemeToggle(event.target.checked);
    });

    if (nightModeOption == 'auto') {
      var data = autoThemeToggle();

      // Toggle theme by local setting
      if (data.toggleAt > themeData.autoToggleAt) {
        themeData.autoToggleAt = data.toggleAt;
        handleThemeToggle(data.nightShift);
      } else {
        handleThemeToggle(themeData.nightShift);
      }
    } else if (nightModeOption == 'manual') {
      handleThemeToggle(themeData.nightShift);
    } else {
      var nightShift = themeData.nightShift;
      if (nightShift === undefined) {
        nightShift = nightModeOption === 'on';
      }
      handleThemeToggle(nightShift);
    }
  })();
</script>
<div id="click-to-top" class="click-to-top">
  <i class="fa fa-arrow-up"></i>
</div>
<script>
  (function () {
    const clickToTop = document.getElementById('click-to-top');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 100) {
        clickToTop.classList.add('show')
      }else {
        clickToTop.classList.remove('show')
      }
    });
    clickToTop.addEventListener('click', () => {
      window.smoothScrollTo(0);
    });
  })();
</script>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="framework">
  <section class="main">

     <div class="post">
  <section>









<header class="post-header">
  <h1 class="post-title p-name" itemprop="name headline">Python进程内存分析&amp;大量内存占用的优化方案</h1>
  <h2 class="post-subtitle"></h2>

  <div class="post-meta">
    <time class="dt-published" datetime="2020-03-30T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Mar 30, 2020
    </time><span class="post-author left-vsplit"><i class="fa fa-pencil"></i> Teddy</span>
    
































    <span class="post-reading-time left-vsplit"><i class="fa fa-clock-o"></i> About 14 mins</span>
  </div>
<div class="post-tags">
<a class="post-tag" href="/tags.html#GDB-gcc-debug">#GDB-gcc-debug</a><a class="post-tag" href="/tags.html#jemalloc">#jemalloc</a><a class="post-tag" href="/tags.html#ptmalloc2">#ptmalloc2</a><a class="post-tag" href="/tags.html#TCMalloc">#TCMalloc</a>
</div></header>
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="post-content e-content" itemprop="articleBody">

      <h1 id="python进程内存分析大量内存占用的优化方案">Python进程内存分析&amp;大量内存占用的优化方案</h1>

<h2 id="cpython预编译运行库">CPython预编译运行库</h2>

<blockquote>
  <ul>
    <li>python-debuginfo-2.7.5-86.el7.x86_64</li>
    <li>glibc-debuginfo-common-2.17-292.el7.x86_64</li>
    <li>python-debuginfo-2.7.5-86.el7.x86_64</li>
  </ul>
</blockquote>

<h1 id="monitor-server-内存分析大量内存占用的优化方案">monitor-server 内存分析，大量内存占用的优化方案</h1>

<h1 id="1-当前程序状态">1. 当前程序状态</h1>

<ul>
  <li>物理机
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>417593 root      20   0 4325700 1.946g   6724 S   8.9  0.8 891:53.36 python
641599 root      20   0 4322988 1.922g   6748 S   3.0  0.8   1219:54 python
641904 root      20   0 4328792 1.968g   6748 S   3.0  0.8   1359:53 python
641963 root      20   0 4327696 1.930g   6748 S   2.0  0.8   1263:28 python
</code></pre></div>    </div>
  </li>
  <li>虚拟机
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>609083 root      20   0 4123852   1.5g   1660 S   2.3  9.5 109:47.85 python
643875 root      20   0 4262180   1.7g   1284 S   1.3 11.0  89:58.01 python
643877 root      20   0 4192588   1.6g   1440 S   1.3 10.6  86:33.74 python
671562 root      20   0 4253364   1.7g   1704 S   1.0 10.8  69:23.61 python   
</code></pre></div>    </div>
  </li>
  <li>运行时间在1000小时左右的进程</li>
  <li>在裸金属中占用物理内存比例为0.8%，主机内存总大小为256GB，每个python进程占用大小为2GB左右</li>
  <li>在虚拟机中占用的物理内存大小9%~ 11%，主机内存总大小16GB，每个python进程占用内存大小为2GB左右</li>
  <li>同一LISTEN端口，TCP服务保持的TCP长链接对应Socket数量
    <ul>
      <li>虚拟机：80左右</li>
      <li>物理机：120 - 140左右</li>
    </ul>
  </li>
  <li>因为在LVS转发配置
    <ul>
      <li>虚拟机 权重 20   单个进程的权重 20/10</li>
      <li>物理机 权重 100  单个进程的权重 100/30</li>
    </ul>
  </li>
</ul>

<h1 id="2-server对交付报文的处理">2. server对交付报文的处理</h1>
<ul>
  <li>
    <p>server处理HTTP报文的有效载荷数据大小为数bk到数百kb，服务器使用I/O多路复用，借助select(此处使用了linux的epoll)函数检查事件输入，进程通过监听描述符创建了80到140个连接描述符，并将数据交付给multiprocessing线程池中25个线程中空闲的线程，在文件的读写过程中，server的动态监控及接口监控等数据处理有一定复杂度的函数，会产生大量的数据拷贝和引用，并会创建很多对象（datamodel等）；</p>
  </li>
  <li>python的垃圾回收发生的条件
    <blockquote>
      <p>https://docs.python.org/2/library/gc.html
官方文档：The GC classifies objects into three generations depending on how many collection sweeps they have survived. New objects are placed in the youngest generation (generation 0). If an object survives a collection it is moved into the next older generation. Since generation 2 is the oldest generation, objects in that generation remain there after a collection. In order to decide when to run, the collector keeps track of the number object allocations and deallocations since the last collection. When the number of allocations minus the number of deallocations exceeds threshold0, collection starts. Initially only generation 0 is examined. If generation 0 has been examined more than threshold1 times since generation 1 has been examined, then generation 1 is examined as well. Similarly, threshold2 controls the number of collections of generation 1 before collecting generation 2.</p>
    </blockquote>
  </li>
  <li>python内存管理的三层结构
    <ul>
      <li>generation 0：新建的对象</li>
      <li>generation 1：垃圾回收后，任然存在引用，则归入1</li>
      <li>generation 2：最老的无法被collection函数回收的对象</li>
    </ul>
  </li>
  <li>回收机制会在内存分配数量和取消分配数量的差值超过 一个特定的阈值 才会触发</li>
  <li>通过gc模块，可以查看默认的阈值，且可以通过调用set_threshold函数，配置定制的阈值
    <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">gc</span>
<span class="n">gc</span><span class="p">.</span><span class="n">get_threshold</span><span class="p">()</span><span class="err">　　</span><span class="c1">#gc模块中查看阈值的方法
</span><span class="p">(</span><span class="mi">700</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>这里的解释是：阈值超过700时才会对g0的对象进行回收，每10次回收g0会发生1次回收g1，每10次回收g1会发生1次回收g2；</li>
  <li>gc模块提供主动触发垃圾回收的函数
    <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="n">generation</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="n">collect</span><span class="p">([</span><span class="n">generation</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">n</span>
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p>With no arguments, run a full collection.  The optional argument
may be an integer specifying which generation to collect.  A ValueError
is raised if the generation number is invalid.</p>
</blockquote>

<ul>
  <li>对于不传入参数的调用来说，会发起g0 g1 g2三代的全部的回收；</li>
  <li>CPython对C运行库提供的free函数的调用，也存在一定的条件
    <ul>
      <li>第3层：最上层，用户对Python对象的直接操作</li>
      <li>第1层和第2层：内存池，有Python的接口函数PyMem_Malloc实现-----若请求分配的内存在1~256字节之间就使用内存池管理系统进行分配，调用malloc函数分配内存，但是每次只会分配一块大小为256K的大块内存，不会调用free函数释放内存，将该内存块留在内存池中以便下次使用。</li>
      <li>第0层：大内存-----若请求分配的内存大于256K，malloc函数分配内存，free函数释放内存；</li>
    </ul>
  </li>
</ul>

<h1 id="3-动手操作问题定位">3. 动手操作，问题定位</h1>
<h2 id="中断运行的程序输出无法回收的对象">中断运行的程序，输出无法回收的对象</h2>
<blockquote>
  <p>A list of objects which the collector found to be unreachable but could not be freed (uncollectable objects). By default, this list contains only objects with <strong>del</strong>() methods. 1 Objects that have <strong>del</strong>() methods and are part of a reference cycle cause the entire reference cycle to be uncollectable, including objects not necessarily in the cycle but reachable only from it. Python doesn’t collect such cycles automatically because, in general, it isn’t possible for Python to guess a safe order in which to run the <strong>del</strong>() methods. If you know a safe order, you can force the issue by examining the garbage list, and explicitly breaking cycles due to your objects within the list. Note that these objects are kept alive even so by virtue of being in the garbage list, so they should be removed from garbage too. For example, after breaking cycles, do del gc.garbage[:] to empty the list. It’s generally better to avoid the issue by not creating cycles containing objects with <strong>del</strong>() methods, and garbage can be examined in that case to verify that no such cycles are being created.</p>
</blockquote>

<ul>
  <li>pip install pyrasite</li>
  <li>pip show pyrasite</li>
</ul>

<blockquote>
  <p>Name: pyrasite
Version: 2.0
Summary: Inject code into a running Python process
Home-page: http://pyrasite.com
Author: Luke Macken</p>
</blockquote>

<ul>
  <li>安装pyrasite工具，该工具可以中断正在运行的进程，并对进程进行注入和检查</li>
  <li>
    <p>pyrasite-shell <pid>， 接下来就可以在<pid>的进程里调用任意的python代码, 来查看进程的状态.</pid></pid></p>
  </li>
  <li>guppy 取得内存使用的各种对象占用情况，guppy 可以用来打印出各种对象各占用多少空间, 如果python进程中有没有释放的对象, 造成内存占用升高, 通过guppy可以查看出来:</li>
  <li>pip install guppy
    <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="n">pyrasite</span><span class="o">-</span><span class="n">shell</span> <span class="o">&lt;</span><span class="n">pid</span><span class="o">&gt;</span>
<span class="kn">from</span> <span class="nn">guppy</span> <span class="kn">import</span> <span class="n">hpy</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">hpy</span><span class="p">()</span>
<span class="n">h</span><span class="p">.</span><span class="n">heap</span><span class="p">()</span>
</code></pre></div>    </div>
  </li>
  <li>运行此命令报错，暂时未定位原因，h.heap可以查看当前进程堆的内存分配情况，例如各种类型的对象占用的内存长度；
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code># Partition of a set of 48477 objects. Total size = 3265516 bytes.
#  Index  Count   %     Size   % Cumulative  % Kind (class / dict of class)
#      0  25773  53  1612820  49   1612820  49 str
#      1  11699  24   483960  15   2096780  64 tuple
#      2    174   0   241584   7   2338364  72 dict of module
#      3   3478   7   222592   7   2560956  78 types.CodeType
#      4   3296   7   184576   6   2745532  84 function
#      5    401   1   175112   5   2920644  89 dict of class
#      6    108   0    81888   3   3002532  92 dict (no owner)
#      7    114   0    79632   2   3082164  94 dict of type
#      8    117   0    51336   2   3133500  96 type
#      9    667   1    24012   1   3157512  97 __builtin__.wrapper_descriptor
# &lt;76 more rows. Type e.g. '_.more' to view.&gt;
h.iso(1,[],{})
# Partition of a set of 3 objects. Total size = 176 bytes.
#  Index  Count   %     Size   % Cumulative  % Kind (class / dict of class)
#      0      1  33      136  77       136  77 dict (no owner)
#      1      1  33       28  16       164  93 list
#      2      1  33       12   7       176 100 int
</code></pre></div>    </div>
  </li>
  <li>无法回收的对象</li>
  <li>python垃圾回收, 对象无法被垃圾回收(uncollectable object), 满足2个条件:
    <ol>
      <li>循环引用</li>
      <li>循环引用的链上某个对象定义了__del__方法, 循环引用的一组对象被gc模块识别为可回收的, 但需要先调用每个对象上的__del__方法, 才能回收. 但用户自定义了__del__的对象, gc系统不知道应该先调用环上的哪个__del__. 因此无法回收这类对象.</li>
    </ol>
  </li>
  <li>不能回收的python对象会持续占据内存</li>
  <li>查找uncollectable的对象:
    <div class="language-python highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="n">pyrasite</span><span class="o">-</span><span class="n">shell</span> <span class="p">{</span><span class="n">PID</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">gc</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">gc</span><span class="p">.</span><span class="n">collect</span><span class="p">()</span> <span class="c1"># first run gc, find out uncollectable object and put them in gc.garbage
</span>           <span class="c1"># output number of object collected
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">gc</span><span class="p">.</span><span class="n">garbage</span>   <span class="c1"># print all uncollectable objects
</span><span class="o">&gt;&gt;&gt;</span> <span class="p">[]</span>               <span class="c1"># empty
</span></code></pre></div>    </div>
    <blockquote>
      <p>如果在上面最后一步打印出了任何不能回收的对象, 则需要进一步查找循环引用链上在哪个对象上包含__del__方法.</p>
    </blockquote>
  </li>
  <li>
    <p>gdb查看python线程执行上下文及调用栈</p>
  </li>
  <li>安装python的debuginfo及gcc的debuginfo</li>
  <li>gdb python {PID}
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="o">(</span>gdb<span class="o">)</span> info threads
Id   Target Id         Frame 
 36   Thread 0x7f4b2bbad740 <span class="o">(</span>LWP 404510<span class="o">)</span> 0x00007f4b2a9e1e63 <span class="k">in </span>epoll_wait <span class="o">()</span> at ../sysdeps/unix/syscall-template.S:81
 35   Thread 0x7f4a7bb7a700 <span class="o">(</span>LWP 412337<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a58000910<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 34   Thread 0x7f4a7c37b700 <span class="o">(</span>LWP 412248<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a54000b30<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 33   Thread 0x7f4a7cb7c700 <span class="o">(</span>LWP 410227<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a5c000b30<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 32   Thread 0x7f4a7d37d700 <span class="o">(</span>LWP 409187<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a6826fa50<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 31   Thread 0x7f4a7dc3e700 <span class="o">(</span>LWP 408137<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a70003470<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 30   Thread 0x7f4a7e43f700 <span class="o">(</span>LWP 406936<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a6c33ccc0<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 29   Thread 0x7f4a8effd700 <span class="o">(</span>LWP 405827<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a74811da0<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 28   Thread 0x7f4a8f7fe700 <span class="o">(</span>LWP 404586<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a80001b90<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 27   Thread 0x7f4a8ffff700 <span class="o">(</span>LWP 404585<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a88002620<span class="o">)</span>
 ...
<span class="o">(</span>gdb<span class="o">)</span> thread 24
<span class="o">[</span>Switching to thread 24 <span class="o">(</span>Thread 0x7f4aadffb700 <span class="o">(</span>LWP 404582<span class="o">))]</span>
<span class="c">#0  0x00007f4b2b3c7afb in futex_abstimed_wait (cancel=true, private=&lt;optimized out&gt;, abstime=0x0, expected=0, futex=0x7f4a9c002050)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
43            err <span class="o">=</span> lll_futex_wait <span class="o">(</span>futex, expected, private<span class="o">)</span><span class="p">;</span>
<span class="o">(</span>gdb<span class="o">)</span> py-list
334            waiter.acquire<span class="o">()</span>
335            self.__waiters.append<span class="o">(</span>waiter<span class="o">)</span>
336            saved_state <span class="o">=</span> self._release_save<span class="o">()</span>
337            try:    <span class="c"># restore state no matter what (e.g., KeyboardInterrupt)</span>
338                <span class="k">if </span><span class="nb">timeout </span>is None:
<span class="o">&gt;</span>339                    waiter.acquire<span class="o">()</span>
340                    <span class="k">if </span>__debug__:
341                        self._note<span class="o">(</span><span class="s2">"%s.wait(): got it"</span>, self<span class="o">)</span>
342                <span class="k">else</span>:
343                    <span class="c"># Balancing act:  We can't afford a pure busy loop, so we</span>
344                    <span class="c"># have to sleep; but if we sleep the whole timeout time,</span>
<span class="o">(</span>gdb<span class="o">)</span> 
</code></pre></div>    </div>
  </li>
  <li>
    <p>看到大量的线程处于 futex_abstimed_wait 状态，使用py-list查看代码后，发现当前该线程的ioloop处于等待状态，结合htop或者top命令，可以看到当前进程的25个线程大多数线程处于等待调度状态（饥饿状态），分析为server扩容后，单个进程的负载很大程度下降，导致对80~140个范围内的已连接FD不需要频繁的线程上下文切换即可完成处理；</p>
  </li>
  <li>使用gcc debug 可以查看当前CPython的调用栈
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a9c002050<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
<span class="c">#1  do_futex_wait (sem=sem@entry=0x7f4a9c002050, abstime=0x0) at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:223</span>
<span class="c">#2  0x00007f4b2b3c7b8f in __new_sem_wait_slow (sem=0x7f4a9c002050, abstime=0x0) at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:292</span>
<span class="c">#3  0x00007f4b2b3c7c2b in __new_sem_wait (sem=&lt;optimized out&gt;) at ../nptl/sysdeps/unix/sysv/linux/sem_wait.c:28</span>
<span class="c">#4  0x00007f4b2b6e7795 in PyThread_acquire_lock (lock=0x7f4a9c002050, waitflag=1) at /usr/src/debug/Python-2.7.5/Python/thread_pthread.h:323</span>
<span class="c">#5  0x00007f4b2b6eb482 in lock_PyThread_acquire_lock (self=0x7f4b1862a930, args=&lt;optimized out&gt;) at /usr/src/debug/Python-2.7.5/Modules/threadmodule.c:52</span>
<span class="c">#6  0x00007f4b2b6bad40 in call_function (oparg=&lt;optimized out&gt;, pp_stack=0x7f4aadffa060) at /usr/src/debug/Python-2.7.5/Python/ceval.c:4408</span>
<span class="c">#7  PyEval_EvalFrameEx (</span>
 <span class="nv">f</span><span class="o">=</span>f@entry<span class="o">=</span>Frame 0x7f4af4026420, <span class="k">for </span>file /usr/lib64/python2.7/threading.py, line 339, <span class="k">in </span><span class="nb">wait</span> <span class="o">(</span><span class="nv">self</span><span class="o">=</span>&lt;_Condition<span class="o">(</span><span class="nv">_Verbose__verbose</span><span class="o">=</span>False, <span class="nv">_Condition__lock</span><span class="o">=</span>&lt;thread.lock at remote 0x7f4b18756f30&gt;, <span class="nv">acquire</span><span class="o">=</span>&lt;built-in method acquire of thread.lock object at remote 0x7f4b18756f30&gt;, <span class="nv">_Condition__waiters</span><span class="o">=[</span>&lt;thread.lock at remote 0x7f4b1862a3f0&gt;, &lt;thread.lock at remote 0x7f4b10aab750&gt;, &lt;thread.lock at remote 0x7f4b1862adb0&gt;, &lt;thread.lock at remote 0x7f4b1862ab10&gt;, &lt;thread.lock at remote 0x7f4b1862ae50&gt;, &lt;thread.lock at remote 0x7f4b1862abd0&gt;, &lt;thread.lock at remote 0x7f4b1862a4d0&gt;, &lt;thread.lock at remote 0x7f4b1862a930&gt;, &lt;thread.lock at remote 0x7f4b1862a8b0&gt;, &lt;thread.lock at remote 0x7f4b1862ae70&gt;, &lt;thread.lock at remote 0x7f4b1862a530&gt;, &lt;thread.lock at remote 0x7f4b1862ab90&gt;, &lt;thread.lock at remote 0x7f4b1862a8d0&gt;, &lt;thread.lock at remote 0x7f4b1862a9d0&gt;, &lt;thread.lock at remote 0x7f4b1862a150&gt;, &lt;thread.lock at remote 0x7f4b1862a290&gt;, &lt;thread.lock at remote 0x7f4b1862aad0&gt;, &lt;thread.lock at remote 0x7f4b1862ad30&gt;, &lt;thread.lock at r...<span class="o">(</span>truncated<span class="o">)</span>, <span class="nv">throwflag</span><span class="o">=</span>throwflag@entry<span class="o">=</span>0<span class="o">)</span>
 at /usr/src/debug/Python-2.7.5/Python/ceval.c:3040
<span class="c">#8  0x00007f4b2b6bd08d in PyEval_EvalCodeEx (co=&lt;optimized out&gt;, globals=&lt;optimized out&gt;, locals=locals@entry=0x0, args=&lt;optimized out&gt;, argcount=1, kws=0x7f4aa800cd30, kwcount=0, </span>
 <span class="nv">defs</span><span class="o">=</span>0x7f4b1fe30188, <span class="nv">defcount</span><span class="o">=</span>2, <span class="nv">closure</span><span class="o">=</span>closure@entry<span class="o">=</span>0x0<span class="o">)</span> at /usr/src/debug/Python-2.7.5/Python/ceval.c:3640
<span class="c">#9  0x00007f4b2b6ba58c in fast_function (nk=&lt;optimized out&gt;, na=&lt;optimized out&gt;, n=&lt;optimized out&gt;, pp_stack=0x7f4aadffa270, func=&lt;optimized out&gt;)</span>
 at /usr/src/debug/Python-2.7.5/Python/ceval.c:4504
<span class="c">#10 call_function (oparg=&lt;optimized out&gt;, pp_stack=0x7f4aadffa270) at /usr/src/debug/Python-2.7.5/Python/ceval.c:4429</span>
<span class="c">#11 PyEval_EvalFrameEx (</span>
 <span class="nv">f</span><span class="o">=</span>f@entry<span class="o">=</span>Frame 0x7f4aa800cb80, <span class="k">for </span>file /usr/lib64/python2.7/Queue.py, line 168, <span class="k">in </span>get <span class="o">(</span><span class="nv">self</span><span class="o">=</span>&lt;Queue<span class="o">(</span><span class="nv">unfinished_tasks</span><span class="o">=</span>47882, <span class="nv">queue</span><span class="o">=</span>&lt;collections.deque at remote 0x7f4b0fed62f0&gt;, <span class="nv">maxsize</span><span class="o">=</span>0, <span class="nv">all_tasks_done</span><span class="o">=</span>&lt;_Condition<span class="o">(</span><span class="nv">_Verbose__verbose</span><span class="o">=</span>False, <span class="nv">_Condition__lock</span><span class="o">=</span>&lt;thread.lock at remote 0x7f4b18756f30&gt;, <span class="nv">acquire</span><span class="o">=</span>&lt;built-in method acquire of thread.lock object at remote 0x7f4b18756f30&gt;, <span class="nv">_Condition__waiters</span><span class="o">=[]</span>, <span class="nv">release</span><span class="o">=</span>&lt;built-in method release of thread.lock object at remote 0x7f4b18756f30&gt;<span class="o">)</span> at remote 0x7f4b177ab710&gt;, <span class="nv">mutex</span><span class="o">=</span>&lt;thread.lock at remote 0x7f4b18756f30&gt;, <span class="nv">not_full</span><span class="o">=</span>&lt;_Condition<span class="o">(</span><span class="nv">_Verbose__verbose</span><span class="o">=</span>False, <span class="nv">_Condition__lock</span><span class="o">=</span>&lt;thread.lock at remote 0x7f4b18756f30&gt;, <span class="nv">acquire</span><span class="o">=</span>&lt;built-in method acquire of thread.lock object at remote 0x7f4b18756f30&gt;, <span class="nv">_Condition__waiters</span><span class="o">=[]</span>, <span class="nv">release</span><span class="o">=</span>&lt;built-in method release of thread.lock object at remote 0x7f4b18756f30&gt;<span class="o">)</span> at remote 0x7f4b177ab790&gt;, <span class="nv">not_empty</span><span class="o">=</span>&lt;_Condition<span class="o">(</span><span class="nv">_Verbose__verbose</span><span class="o">=</span>False, <span class="nv">_Condition__lock</span><span class="o">=</span>&lt;thread.lock at remote 0x7f4b18756f30&gt;, <span class="nv">acquire</span><span class="o">=</span>&lt;built-in method acquire of thread.lock objec...<span class="o">(</span>truncated<span class="o">)</span>, <span class="nv">throwflag</span><span class="o">=</span>throwflag@entry<span class="o">=</span>0<span class="o">)</span>
 at /usr/src/debug/Python-2.7.5/Python/ceval.c:3040
<span class="c">#12 0x00007f4b2b6bd08d in PyEval_EvalCodeEx (co=&lt;optimized out&gt;, globals=&lt;optimized out&gt;, locals=locals@entry=0x0, args=&lt;optimized out&gt;, argcount=1, kws=0x7f4a9c000d58, kwcount=0, </span>
 <span class="nv">defs</span><span class="o">=</span>0x7f4b1f725800, <span class="nv">defcount</span><span class="o">=</span>2, <span class="nv">closure</span><span class="o">=</span>closure@entry<span class="o">=</span>0x0<span class="o">)</span> at /usr/src/debug/Python-2.7.5/Python/ceval.c:3640
<span class="c">#13 0x00007f4b2b6ba58c in fast_function (nk=&lt;optimized out&gt;, na=&lt;optimized out&gt;, n=&lt;optimized out&gt;, pp_stack=0x7f4aadffa480, func=&lt;optimized out&gt;)</span>
 at /usr/src/debug/Python-2.7.5/Python/ceval.c:4504
<span class="c">#14 call_function (oparg=&lt;optimized out&gt;, pp_stack=0x7f4aadffa480) at /usr/src/debug/Python-2.7.5/Python/ceval.c:4429</span>
</code></pre></div>    </div>
  </li>
  <li>通过调用栈可以看到，频繁出现的线程等待的信号量<code class="language-plaintext highlighter-rouge">/linux/sem_waitcommon.c</code>
</li>
  <li>如果发现某个线程有问题, 切换到那个线程上, 查看调用栈确定具体的执行步骤, 使用bt 命令:</li>
  <li>py-bt显示出python源码的调用栈, 调用参数, 以及所在行的代码.
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="c">#4 Waiting for a lock (e.g. GIL)</span>
<span class="c">#5 Waiting for a lock (e.g. GIL)</span>
<span class="c">#7 Frame 0x7f4af4026420, for file /usr/lib64/python2.7/threading.py, line 339, in wait (self=&lt;_Condition(_Verbose__verbose=False, _Condition__lock=&lt;thread.lock at remote 0x7f4b18756f30&gt;, acquire=&lt;built-in method acquire of thread.lock object at remote 0x7f4b18756f30&gt;, _Condition__waiters=[&lt;thread.lock at remote 0x7f4b1862a3f0&gt;, &lt;thread.lock at remote 0x7f4b10aab750&gt;, &lt;thread.lock at remote 0x7f4b1862adb0&gt;, &lt;thread.lock at remote 0x7f4b1862ab10&gt;, &lt;thread.lock at remote 0x7f4b1862ae50&gt;, &lt;thread.lock at remote 0x7f4b1862abd0&gt;, &lt;thread.lock at remote 0x7f4b1862a4d0&gt;, &lt;thread.lock at remote 0x7f4b1862a930&gt;, &lt;thread.lock at remote 0x7f4b1862a8b0&gt;, &lt;thread.lock at remote 0x7f4b1862ae70&gt;, &lt;thread.lock at remote 0x7f4b1862a530&gt;, &lt;thread.lock at remote 0x7f4b1862ab90&gt;, &lt;thread.lock at remote 0x7f4b1862a8d0&gt;, &lt;thread.lock at remote 0x7f4b1862a9d0&gt;, &lt;thread.lock at remote 0x7f4b1862a150&gt;, &lt;thread.lock at remote 0x7f4b1862a290&gt;, &lt;thread.lock at remote 0x7f4b1862aad0&gt;, &lt;thread.lock at remote 0x7f4b1862ad30&gt;, &lt;thread.lock at r...(truncated)</span>
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p>coredump
如果要进行比较长时间的跟踪, 最好将python程序的进程信息全部coredump出来, 之后对core文件进行分析, 避免影响正在运行的程序.
(gdb) generate-core-file
这条命令将当前gdb attach的程序dump到它的运行目录, 名字为core.<pid>, 然后再用gdb 加载这个core文件, 进行打印堆栈, 查看变量等分析, 无需attach到正在运行的程序:</pid></p>

  <p>gdb python core.<pid></pid></p>
</blockquote>

<blockquote>
  <p>其他命令
其他命令可以在gdb输入py<tab><tab> 看到, 和gdb的命令对应, 例如:
(gdb) py
py-bt               py-list             py-print            python
py-down             py-locals           py-up               python-interactive
py-up, py-down 可以用来移动到python调用站的上一个或下一个frame.
py-locals 用来打印局部变量
等等等等. gdb里也可以用help命令查看帮助:</tab></tab></p>
</blockquote>

<blockquote>
  <p>(gdb) help py-print
Look up the given python variable name, and print it
在这次追踪过程中, 用gdb-python排除了程序逻辑问题. 然后继续追踪内存泄漏问题:</p>
</blockquote>

<ul>
  <li>可以结合mmap，及x\命令查看内存地址和程序计数器寄存器的情况</li>
</ul>

<blockquote>
  <p>参考文档
https://github.com/lmacken/pyrasite
https://docs.python.org/2/library/gc.html
https://www.cnblogs.com/geaozhang/p/7111961.html
http://man7.org/linux/man-pages/man7/epoll.7.html
https://linux.die.net/man/4/epoll
https://blog.csdn.net/ljx0305/article/details/4065058
https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#不可回收对象的例子-
https://blog.csdn.net/evsqiezi/article/details/8061176
https://github.com/torvalds/linux/blob/master/net/ipv4/tcp.c
https://juejin.im/post/5cfdd44a6fb9a07eb67d83e9
https://blog.csdn.net/haoel/article/details/1602108
https://mg.pov.lt/objgraph/
http://guppy-pe.sourceforge.net/
http://guppy-pe.sourceforge.net/heapy_tutorial.html
https://www.cnblogs.com/chengliangsheng/p/3597010.html
https://blog.csdn.net/gogoytgo/article/details/64130179</p>
</blockquote>

<blockquote>
  <p>https://github.com/google/tcmalloc
https://github.com/jemalloc/jemalloc
https://blog.csdn.net/junlon2006/article/details/77854898</p>
</blockquote>

<h1 id="4-内存占用分析">4. 内存占用分析</h1>

<ul>
  <li>针对monitor-server的情况
    <ol>
      <li>进程启动后，创建到权重占比的已连接描述符后（例如2的权重占总连接的80个左右，3.3占130左右），物理内存占用值会稳定到一个确定值，不会一直上涨，所有初步判断并没有循环引用或者内存泄漏；</li>
      <li>在测试环境中，给动态监控的逻辑部分在请求处理完成返回前，做一次全generation的主动垃圾回收，程序启动后，物理内存的占用会有一定的下降，表现为在几个小时呢从700MB到1.5GB之间；</li>
    </ol>
  </li>
  <li>
    <p>初步结论，内存无泄漏且无对象的循环引用，主动的gc回收或者降低阈值并增加垃圾回收的频率，会一定程度的降低进程的物理内存的占用，大概可以下降测试前的20%~30%;</p>
  </li>
  <li>考虑C底层预编译的运行库的内存管理算法</li>
  <li>生产环境的CentOS7.x 64默认提供的C运行库glibc的版本为2.17，其中malloc库的为ptmalloc2</li>
  <li>Google提供的替代品：</li>
  <li>TCMalloc is Google’s customized implementation of C’s malloc() and C++’s operator new used for memory allocation within our C and C++ code. TCMalloc is a fast, multi-threaded malloc implementation.</li>
  <li>https://github.com/google/tcmalloc</li>
  <li>FaceBook提供的替代品：</li>
  <li>jemalloc is a general purpose malloc(3) implementation that emphasizes fragmentation avoidance and scalable concurrency support.</li>
  <li>https://github.com/jemalloc/jemalloc</li>
  <li>
    <p>https://www.facebook.com/jemalloc</p>
  </li>
  <li>生产环境网络进过yum search后，找到了jemalloc X86_64的版本，而且可以直接yum安装，无需再次下载和编译；</li>
</ul>

<h1 id="5-最终方案测试">5. 最终方案测试</h1>
<ul>
  <li>
    <p>在测试环境中，给动态监控的逻辑部分在请求处理完成返回前，做一次全generation的主动垃圾回收；</p>
  </li>
  <li>使用LD_PRELOAD，可以直接用jemalloc代替ptmalloc2，对python代码进行链接执行</li>
  <li>测试方式</li>
  <li>LD_PRELOAD=”/usr/lib64/libjemalloc.so” /home/monitor_server/bin/python /opt/netmon/service/monitor-server/monitor/run_server.py –config-file /opt/netmon/service/monitor-server/monitor/conf/conf.ini –port 51035 » /var/log/monitor-server/server_debug.log 2&gt;&amp;1 &amp;
    <div class="language-bash highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> root      76913  76489 20 15:36 pts/1    01:17:10 /home/monitor_server/bin/python /opt/netmon/debug/monitor-server/monitor/run_server.py <span class="nt">--config-file</span> /opt/netmon/debug/monitor-server/monitor/conf/conf.ini <span class="nt">--port</span> 51035
 VmRSS:    522232 kB
  76913 root       20   0 1991M  518M  6736 R 113.  0.2  1h17:15 │        └─ python /opt/netmon/debug/monitor-server/monitor/run_server.py <span class="nt">--config-file</span> /opt/netmon/debug/monitor-serve
</code></pre></div>    </div>
  </li>
  <li>
    <p>最终表现</p>
  </li>
  <li>稳定运行15小时的server进行内存占用率维持在0.2%，物理内存的占用为500MB（上下不超过50MB），且添加了主动GC回收后，对单个逻辑核心的5分钟平均占用在50%（估计值）</li>
</ul>

<h1 id="6-文档">6. 文档</h1>
<p><a href="http://ithare.com/testing-memory-allocators-ptmalloc2-tcmalloc-hoard-jemalloc-while-trying-to-simulate-real-world-loads/">第三方模拟真实应用的算法测试-ptmalloc2-tcmalloc-hoard-jemalloc</a>
<a href="https://segmentfault.com/a/1190000003063859">I/O多路复用技术的简单介绍</a>
<a href=""></a>
<a href=""></a>
<a href=""></a></p>


    </div>

</article>
<div class="post-nav">
<a class="previous" href="/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%9F%BA%E7%A1%80/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/2020/03/27/csapp.html" title="深入理解计算机系统 [Computer-Systems-A-Programmer's-Perspective]">深入理解计算机系统 [Computer-Systems-A-Programmer's-Perspective]</a><a class="next" href="/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%BA%94%E7%94%A8/%E4%B8%AD%E9%97%B4%E4%BB%B6/2020/03/31/Redis.html" title="Redis学习及源码分析">Redis学习及源码分析</a>
</div>
<div class="post-related">
      <div>Related Articles</div>
      <ul>
        <li class="">
          <a class="post-link" href="/blogging/demo/2019/08/08/text-and-typography.html" title="Text and Typography">
            Text and Typography<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li>
<li class="">
          <a class="post-link" href="/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84-%E5%9F%BA%E7%A1%80/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/2020/03/27/csapp.html" title="深入理解计算机系统 [Computer-Systems-A-Programmer's-Perspective]">
            深入理解计算机系统 [Computer-Systems-A-Programmer's-Perspective]<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li>
<li class="">
          <a class="post-link" href="/%E5%AE%9E%E8%B7%B5/%E7%AE%97%E6%B3%95%E8%AE%AD%E7%BB%83/2020/01/08/Beginning-of-2020-Algorithm.html" title="BeginningOf2020 - Algorithm">
            BeginningOf2020 - Algorithm<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li>
<li class="">
          <a class="post-link" href="/%E8%A7%84%E5%88%92/%E5%B7%A5%E4%BD%9C%E6%B5%81/2021/02/15/mac-reset-smc-nvram.html" title="Mac Reset Smc nvram">
            Mac Reset Smc nvram<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li>
</ul>
    </div>
<div class="post-comments"></div></section>
</div>


  </section>
  <section class="sidebar" style="margin-left: 15px;">
    <!-- Get sidebar items --><style type="text/css" media="screen">
.post-menu ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
</style>

<div class="post-menu">
  <div class="post-menu-title">TOC</div>
  <div class="post-menu-content"></div>
</div>

<script>
  function generateContent() {
    var menu = document.querySelector(".post-menu");
    var menuContent =  menu.querySelector(".post-menu-content");
    var headings = document.querySelector(".post-content").querySelectorAll("h2, h3, h4, h5, h6");

    // Hide menu when no headings
    if (headings.length === 0) {
      return menu.style.display = "none";
    }

    // Generate post menu
    var menuHTML = '';
    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      menuHTML += (
        '<li class="h-' + h.tagName.toLowerCase() + '">'
        + '<a href="#h-' + h.getAttribute('id') + '">' + h.textContent + '</a></li>');
    }

    menuContent.innerHTML = '<ul>' + menuHTML + '</ul>';

    // The header element
    var header = document.querySelector('header.site-header');

    function doMenuCollapse(index, over_items) {
      var items = menuContent.firstChild.children;

      if (over_items == undefined) {
        over_items = 20;
      }

      if (items.length < over_items) {
        return;
      }

      var activeItem = items[index];
      var beginItem = activeItem
      var endItem = activeItem
      var beginIndex = index;
      var endIndex = index + 1;
      while (beginIndex >= 0
        && !items[beginIndex].classList.contains('h-h2')) {
        beginIndex -= 1;
      }
      while (endIndex < items.length
        && !items[endIndex].classList.contains('h-h2')) {
        endIndex += 1;
      }
      for (var i = 0; i < beginIndex; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
      for (var i = beginIndex + 1; i < endIndex; i++) {
        item = items[i]
        // if (!item.classList.contains('h-h2')) {
          item.style.display = '';
        // }
      }
      for (var i = endIndex; i < items.length; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
    }

    // Init menu collapsed
    doMenuCollapse(-1);

    // Active the menu item
    window.addEventListener('scroll', function (event) {
      var lastActive = menuContent.querySelector('.active');
      var changed = true;
      var activeIndex = -1;
      for (var i = headings.length - 1; i >= 0; i--) {
        var h = headings[i];
        var headingRect = h.getBoundingClientRect();
        var headerRect = header.getBoundingClientRect();
        var headerTop = Math.floor(headerRect.top);
        var headerHeight = Math.floor(headerRect.height);
        var headerHeight = headerTop + headerHeight + 20;
        if (headingRect.top <= headerHeight) {
          var id = 'h-' + h.getAttribute('id');
          var a = menuContent.querySelector('a[href="#' + id  + '"]');
          var curActive = a.parentNode;
          if (curActive) {
            curActive.classList.add('active');
            activeIndex = i;
          }
          if (lastActive == curActive) {
            changed = false;
          }
          break;
        }
      }
      if (changed) {
        if (lastActive) {
          lastActive.classList.remove('active');
        }
        doMenuCollapse(activeIndex);
      }
      event.preventDefault();
    });
  }
  generateContent();
</script>
</section>
</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">
    <div class="site-footer-inner">
<div>Unpublished Work <span class="copyleft">©</span> 2017-2023 Adam Yan Na</div>
      <div>Powered by <a title="Jekyll is a simple, blog-aware, static site
      generator." href="https://jekyllrb.com/">Jekyll</a> &amp; <a title="Yat, yet
      another theme." href="https://github.com/jeffreytse/jekyll-theme-yat">Yat Theme</a>.</div>
      <div class="footer-col rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a>
</div>
    </div>
  </div>
</footer>
</body>
</html>
