<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"><link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"><style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li:not(:nth-child(1)) > a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(2) > ul > li:nth-child(6) > ul > li:nth-child(1) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(2) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(2) > ul > li:nth-child(6) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(2) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(6) > ul.nav-list { display: block; }</style><script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon"><title>Live Migration Precopy Analyze | Adam Yan Na Docs</title><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Live Migration Precopy Analyze" /><meta property="og:locale" content="en_US" /><meta name="description" content="Engineering &amp; Philosophy &amp; Life Experience" /><meta property="og:description" content="Engineering &amp; Philosophy &amp; Life Experience" /><link rel="canonical" href="http://localhost:4000/docs/archives/2023/2023-01-02-live_migration_precopy/" /><meta property="og:url" content="http://localhost:4000/docs/archives/2023/2023-01-02-live_migration_precopy/" /><meta property="og:site_name" content="Adam Yan Na Docs" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Live Migration Precopy Analyze" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Engineering &amp; Philosophy &amp; Life Experience","headline":"Live Migration Precopy Analyze","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/icon-512x512.png"}},"url":"http://localhost:4000/docs/archives/2023/2023-01-02-live_migration_precopy/"}</script><body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewBox="0 0 16 16"><title>Copy</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"><title>Copied</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg><div class="side-bar"><div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"><div class="site-logo" role="img" aria-label="Adam Yan Na Docs"></div></a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button></div><nav aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Archives category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/archives/" class="nav-list-link">Archives</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2018 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2018/2018/" class="nav-list-link">2018</a><ul class="nav-list"></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2019 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2019/2019/" class="nav-list-link">2019</a><ul class="nav-list"></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2020 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2020/2020/" class="nav-list-link">2020</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/archives/2020/2020-09-22-roles-of-agile-team/" class="nav-list-link">Agile</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-02-18-Algorithm-Everything/" class="nav-list-link">Algorithm Everything</a><li class="nav-list-item"> <a href="/docs/archives/2018/2018-10-26-Algorithm-matrix/" class="nav-list-link">Algorithm Matrix</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-31-algorithm-heap/" class="nav-list-link">Algorithm-heap 堆排序的实现</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-14-ansible-automation/" class="nav-list-link">Ansible自动化</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-01-08-%5BBeginning-of-2020--Algorithm%5D/" class="nav-list-link">BeginningOf2020 - Algorithm</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-16-c-programming-language-recap/" class="nav-list-link">C programming language recap</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-10-c-cpp-syntactic-sugar/" class="nav-list-link">C/C++ Syntactic sugar 语法糖</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-13-cpython-implementation/" class="nav-list-link">CPython源代码分析&虚拟机原理</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-07-26-cloud-qualification/" class="nav-list-link">Cloud Qualification</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-13-redis_data_sampling/" class="nav-list-link">Data Sampling [Redis]</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-07-12-git-advanced/" class="nav-list-link">Git进阶</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-05-golang-performance-flame-graph/" class="nav-list-link">Golang性能分析和监控</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-20-select-poll-epoll/" class="nav-list-link">I/O的多路复用算法</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-03-kubernetes-curve/" class="nav-list-link">Kubernetes & Docker</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-13-linux-command-tools/" class="nav-list-link">Linux常用工具&内置命令</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-18-linux-networking/" class="nav-list-link">Linux网络基础</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-08-05-macos-configuration/" class="nav-list-link">MacOS Configure</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-14-monitor_system_restructure/" class="nav-list-link">Monitor System</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-02-Algorithm-curve/" class="nav-list-link">My Algorithm Curve</a><li class="nav-list-item"> <a href="/docs/archives/2018/2018-10-25-PostgreSQL/" class="nav-list-link">PostgreSQL fundamental and operation</a><li class="nav-list-item"> <a href="/docs/archives/2018/2018-10-23-Postgresql-pgpool/" class="nav-list-link">Postgresql HA & Loadblance - pgpool II</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-06-Prometheus/" class="nav-list-link">Prometheus</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-26-python-core/" class="nav-list-link">Python&CPython核心</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-25-python-memory-management-implementation/" class="nav-list-link">Python内存管理的底层实现&程序内存分析</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-24-Python-dynamic-map/" class="nav-list-link">Python实现动态生成类的http接口-monitor动态监控项</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-05-python-performance-flame-graph/" class="nav-list-link">Python性能分析和火焰图</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-14-python-service-deployment/" class="nav-list-link">Python服务容器化部署</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-30-CPython-malloc-python-gc/" class="nav-list-link">Python进程内存分析&大量内存占用的优化方案</a><li class="nav-list-item"> <a href="/docs/archives/2019/2019-02-20-RabbitMQ-pub-sub/" class="nav-list-link">RabbitMQ & AMQP</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-14-redhat-6.5-python-dependency/" class="nav-list-link">Red Hat Enterprise Linux Kernel Version 2.6.32 3.8.13 python依赖环境手动部署</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-31-Redis/" class="nav-list-link">Redis学习及源码分析</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-01-08-%5BSum-of-2019--DataInfluxPatrol-Golang%5D/" class="nav-list-link">SumOf2019 - DataInfluxPatrol</a><li class="nav-list-item"> <a href="/docs/archives/2018/2018-12-05-V2ray-Websocket-Nginx/" class="nav-list-link">V2ray Nginx 配置</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-09-man-signal/" class="nav-list-link">linux signal</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-13-pg-dead-lock/" class="nav-list-link">pg数据库过程事务执行的锁竞争导致锁表</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-01-01-cs-communication-physical-architecture/" class="nav-list-link">体系结构-树</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-18-tech-stack-planning-2020/" class="nav-list-link">技术栈提升规划 [2020]</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-13-data-patrol/" class="nav-list-link">时序数据完整性的方法巡检工具</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-12-core-knowledge/" class="nav-list-link">核心知识库</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-01-iter-massive-data-programming/" class="nav-list-link">海量数据程序设计思路</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-27-csapp/" class="nav-list-link">深入理解计算机系统 [Computer-Systems-A-Programmer's-Perspective]</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-20-operating-system/" class="nav-list-link">现代操作系统</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-25-pointer-reference-understanding/" class="nav-list-link">理解C/C++中的指针和引用</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-16-tcp-network-analysis/" class="nav-list-link">生产环境TCP网络问题分析</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-07-capsule/" class="nav-list-link">知识碎片</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-02-b-tree-and-indexing-principle/" class="nav-list-link">红黑树&B树应用及索引原理</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-16-network-curve/" class="nav-list-link">计算机网络</a><li class="nav-list-item"> <a href="/docs/archives/2018/2018-12-05-Linux-Ulimit/" class="nav-list-link">通过 ulimit 改善系统性能</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2021 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2021/2021/" class="nav-list-link">2021</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/archives/2021/2021-02-15-mac-reset-smc-nvram/" class="nav-list-link">Mac Reset Smc Nvram</a><li class="nav-list-item"> <a href="/docs/archives/2021/2021-02-15-research-of-ergonomics/" class="nav-list-link">Research of Ergonomics</a><li class="nav-list-item"> <a href="/docs/archives/2021/2021-02-15-work-efficiency/" class="nav-list-link">Work Efficiency</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2022 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2022/2022/" class="nav-list-link">2022</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/archives/2022/2022-11-19-Criticism-of-Hegelianism/" class="nav-list-link">Criticism of Hegelianism</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2023 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2023/2023/" class="nav-list-link">2023</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/archives/2023/2023-01-02-live_migration_precopy/" class="nav-list-link">Live Migration Precopy Analyze</a></ul></ul></ul><ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/adamyanna" class="nav-list-link external" > Adam Yan Na GitHub <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a><li class="nav-list-item external"> <a href="https://www.linkedin.com/in/adam-yan-na" class="nav-list-link external" > Adam Yan Na Linkedin <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search" role="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Adam Yan Na Docs" aria-label="Search Adam Yan Na Docs" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="https://github.com/adamyanna" class="site-button" > Adam Yan Na GitHub </a><li class="aux-nav-list-item"> <a href="https://www.linkedin.com/in/adam-yan-na" class="site-button" > Adam Yan Na Linkedin </a></ul></nav></div><div class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="/docs/archives/archives/">Archives</a><li class="breadcrumb-nav-list-item"><a href="/docs/archives/2023/2023/">2023</a><li class="breadcrumb-nav-list-item"><span>Live Migration Precopy Analyze</span></ol></nav><div id="main-content" class="main-content"><main><p class="label label-blue"><strong>live_migration</strong></p><p class="label label-green"><strong>qemu</strong></p><p class="label label-purple"><strong>libvirt</strong></p><p class="label label-yellow"><strong>kvm</strong></p><p class="label label-red"><strong>precopy</strong></p><h1 id="热迁移原理"> <a href="#热迁移原理" class="anchor-heading" aria-labelledby="热迁移原理"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 热迁移原理</h1><h2 id="热迁移核心步骤"> <a href="#热迁移核心步骤" class="anchor-heading" aria-labelledby="热迁移核心步骤"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 热迁移核心步骤</h2><h3 id="虚拟化层面实现流程和通信方式"> <a href="#虚拟化层面实现流程和通信方式" class="anchor-heading" aria-labelledby="虚拟化层面实现流程和通信方式"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 虚拟化层面实现流程和通信方式</h3><ol><li>通过 python libvirt 接口启动 libvirt 迁移流程<li>client（agent compute）连接源端 libvirtd 进程<li>client 连接目的端 libvirt 进程<li>调用源端 domainMigrateBegin3<li>调用目的端 domainMigratePrapare3<li>调用源端 domainMigratePerform3 domainMigratePerform3函数主要是执行迁移操作，将源端的数据迁移到目的端。然后等待迁移完成的信号 大致的调用流程： 1. qemuDomainMigratePerform3 → qemuMigrationPerform → qemuMigrationPerformPhase → doNativeMigrate → qemuMigrationRun → qemuMonitorSetMigrationSpeed → qemuMigrationConnect →<br /> qemuMonitorMigrateToHost → qemuMonitorJSONMigrate 2. 终会调用到 QEMU中的qmp_migrate 3. setup iterature complete<li>源端 libvirtd 进程调用 源端 qemu qmp_migrate tcp_start_outgoing_migration migrate_fd_connect migrate_compress_thread_create migration_thread qemu_savevm_state_begin qemu_savevm_state_pending qemu_savevm_state_iterate migration_completion vm_stop<li>目的端 qemu_start_incoming_migration tcp_start_incoming_migration process_incoming_migration_co migrate_decompress_threads_create qemu_loadvm_state cpu_synchronize_all_post_init process_incoming_migration_bin vm_start</ol><h3 id="源端调用流程分析"> <a href="#源端调用流程分析" class="anchor-heading" aria-labelledby="源端调用流程分析"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 源端调用流程分析</h3><ul><li>TODO</ul><h3 id="目的端调用流程分析"> <a href="#目的端调用流程分析" class="anchor-heading" aria-labelledby="目的端调用流程分析"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 目的端调用流程分析</h3><ul><li>TODO</ul><h3 id="qmp_migrate"> <a href="#qmp_migrate" class="anchor-heading" aria-labelledby="qmp_migrate"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> qmp_migrate</h3><ul><li>tcp_start_outgoing_migration<ul><li>创建和目的端 libvirt 的 tcp 连接</ul><li>migrate_fd_connect<ul><li>qemu接收来自 libvirt 传入的fd (tcp socket)，准备写入数据</ul><li>迁移主函数 migration_thread<ul><li>发送header<li>建立迁移的准备<li>迭代传输<li>完成迁移</ul></ul><h3 id="qemu-内存迁移---标脏所有的内存页"> <a href="#qemu-内存迁移---标脏所有的内存页" class="anchor-heading" aria-labelledby="qemu-内存迁移---标脏所有的内存页"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> qemu 内存迁移 - 标脏所有的内存页</h3><h4 id="kvm-内存管理简介"> <a href="#kvm-内存管理简介" class="anchor-heading" aria-labelledby="kvm-内存管理简介"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> kvm 内存管理简介</h4><ul><li><p>GVA - Guest虚拟地址</p><li><p>GPA - Guest物理地址</p><li><p>HVA - Host虚拟地址</p><li><p>HPA -Host物理地址</p></ul><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">KVMSlot</span>
<span class="p">{</span>
     <span class="n">hwaddr</span> <span class="n">start_addr</span><span class="p">;</span>               <span class="c1">//Guest物理地址块的起始地址</span>
     <span class="n">ram_addr_t</span> <span class="n">memory_size</span><span class="p">;</span>          <span class="c1">//大小</span>
     <span class="kt">void</span> <span class="o">*</span><span class="n">ram</span><span class="p">;</span>                       <span class="c1">//QUMU用户空间地址 </span>
     <span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>                        <span class="c1">//slot id</span>
     <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">KVMSlot</span><span class="p">;</span>


<span class="k">struct</span> <span class="n">kvm_memslots</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">nmemslots</span><span class="p">;</span>                      <span class="c1">//slot number</span>
	<span class="k">struct</span> <span class="n">kvm_memory_slot</span> <span class="n">memslots</span><span class="p">[</span><span class="n">KVM_MEMORY_SLOTS</span> <span class="o">+</span> <span class="n">KVM_PRIVATE_MEM_SLOTS</span><span class="p">];</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">kvm_memory_slot</span> <span class="p">{</span>
	<span class="n">gfn_t</span> <span class="n">base_gfn</span><span class="p">;</span>                     <span class="c1">//该块物理内存块所在guest 物理页帧号</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">npages</span><span class="p">;</span>               <span class="c1">//该块物理内存块占用的page数</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">rmap</span><span class="p">;</span>                <span class="c1">//分配该块物理内存对应的host内核虚拟地址（vmalloc分配）</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dirty_bitmap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rmap_pde</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">write_count</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">lpage_info</span><span class="p">[</span><span class="n">KVM_NR_PAGE_SIZES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">userspace_addr</span><span class="p">;</span>       <span class="c1">//用户空间地址（QEMU)</span>
	<span class="kt">int</span> <span class="n">user_alloc</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div><ol><li>KVM的虚拟机实际上运行在Qemu的进程上下文中<li>虚拟机的物理内存实际上是Qemu进程的虚拟地址<li>KVMSlot 定义了GPA到HVA的映射关系，也就是虚拟机物理地址和宿主机OS虚拟地址之间的关系<li>Guest运行过程中，内存访问的过程，根据其所在memslot区域获得其对应的HVA 宿主机os虚拟地址，交给宿主机OS将HVA转化为HPA，得到宿主页帧号，对于缺页有缺页处理函数负责完成GPA-&gt;HPA转化</ol><ul><li>memory model (info mtree from QEMU monitor console of guest vm)<li>MemoryRegion 用于描述一个范围内的映射规则<li>AddressSpace 用于描述整个地址空间的映射关系<li>guest 通过映射关系访问到这些地址<ul><li>从顶层 MemoryRegion 逐个找其 child MemoryRegion，其中还需要处理 alias 和 priority 的问题<li>QEMU 在 MemoryRegion 的属性发生修改<li>MemoryRegion 生成 FlatRange，避免逐级查询 MemoryRegion<li>FlatRange 树形结构查询，查询时间复杂度 O(n) 优化到 O(log(N))</ul><li>例如：kvm 处理 io 端口的操作键盘输入，只要给出 AddressSpace 以及地址，最后就可以找到最后的 handler 为 kbd_read_data</ul><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 调用栈</span>
<span class="cm">/*
#2  kbd_read_data (opaque=0x555556844d98, addr=&lt;optimized out&gt;, size=&lt;optimized out&gt;) at ../hw/input/pckbd.c:387
#3  0x0000555555cd2092 in memory_region_read_accessor (mr=mr@entry=0x555556844df0, addr=0, value=value@entry=0x7fffd9ff9130, size=size@entry=1, shift=0, mask=mask@entry=255, attrs=...) at ../softmmu/memory.c:440
#4  0x0000555555cceb1e in access_with_adjusted_size (addr=addr@entry=0, value=value@entry=0x7fffd9ff9130, size=size@entry=1, access_size_min=&lt;optimized out&gt;, access_size_max=&lt;optimized out&gt;, access_fn=0x555555cd2050 &lt;memory_region_read_accessor&gt;, mr=0x555556844df0, attrs=...) at ../softmmu/memory.c:554
#5  0x0000555555cd1ac1 in memory_region_dispatch_read1 (attrs=..., size=&lt;optimized out&gt;, pval=0x7fffd9ff9130, addr=0, mr=0x555556844df0) at ../softmmu/memory.c:1424
#6  memory_region_dispatch_read (mr=mr@entry=0x555556844df0, addr=0, pval=pval@entry=0x7fffd9ff9130, op=MO_8, attrs=attrs@entry=...) at ../softmmu/memory.c:1452
#7  0x0000555555c9eb89 in flatview_read_continue (fv=fv@entry=0x7ffe4402d230, addr=addr@entry=96, attrs=..., ptr=ptr@entry=0x7fffeb17d000, len=len@entry=1, addr1=&lt;optimized out&gt;, l=&lt;optimized out&gt;, mr=0x555556844df0) at /home/maritns3/core/kvmqemu/include/qemu/host-utils.h:165
#8  0x0000555555c9ed43 in flatview_read (fv=0x7ffe4402d230, addr=addr@entry=96, attrs=attrs@entry=..., buf=buf@entry=0x7fffeb17d000, len=len@entry=1) at ../softmmu/physmem.c:2881
#9  0x0000555555c9ee96 in address_space_read_full (as=0x555556606880 &lt;address_space_io&gt;, addr=96, attrs=..., buf=0x7fffeb17d000, len=1) at ../softmmu/physmem.c:2894
#10 0x0000555555c9f015 in address_space_rw (as=&lt;optimized out&gt;, addr=addr@entry=96, attrs=..., attrs@entry=..., buf=&lt;optimized out&gt;, len=len@entry=1, is_write=is_write@entry=false) at ../softmmu/physmem.c:2922
#11 0x0000555555c8ece9 in kvm_handle_io (count=1, size=1, direction=&lt;optimized out&gt;, data=&lt;optimized out&gt;, attrs=..., port=96) at ../accel/kvm/kvm-all.c:2635
#12 kvm_cpu_exec (cpu=cpu@entry=0x555556af4410) at ../accel/kvm/kvm-all.c:2886
#13 0x0000555555cf1825 in kvm_vcpu_thread_fn (arg=arg@entry=0x555556af4410) at ../accel/kvm/kvm-accel-ops.c:49
#14 0x0000555555e55983 in qemu_thread_start (args=&lt;optimized out&gt;) at ../util/qemu-thread-posix.c:541
#15 0x00007ffff628d609 in start_thread (arg=&lt;optimized out&gt;) at pthread_create.c:477
#16 0x00007ffff61b4293 in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95
*/</span>
</code></pre></div></div><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//┌──────────► 这是一个 AddressSpace，AddressSpace 用于描述整个地址空间的映射关系。</span>
<span class="c1">// │                                        ┌───────────────────────► MemoryRegion 的优先级，如果一个范围两个 MemoryRegion 出现重叠，优先级高的压制优先级低的</span>
<span class="c1">// │                                        │</span>
<span class="c1">// │                                        │   ┌───────────────────► 表示这个空间的类型，一般划分为 io 和 RAM</span>
<span class="c1">// │                                        │   │    ┌──────────────► 这是一个 MemoryRegion，这是 Address Space 中最核心的概念，MemoryRegion 用于描述一个范围内的映射规则</span>
<span class="c1">//address-space: memory                     │   │    │</span>
  <span class="mo">0000000000000000</span><span class="o">-</span><span class="n">ffffffffffffffff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">system</span>
  <span class="mo">0000000000000000</span><span class="o">-</span><span class="n">ffffffffffffffff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">system</span>
    <span class="mo">0000000000000000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">bfffffff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ram</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">ram</span><span class="o">-</span><span class="n">below</span><span class="o">-</span><span class="mi">4</span><span class="n">g</span> <span class="err">@</span><span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="mo">0000000000000000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">bfffffff</span> <span class="err">──────────────┐</span>
    <span class="mo">0000000000000000</span><span class="o">-</span><span class="n">ffffffffffffffff</span> <span class="p">(</span><span class="n">prio</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">pci</span>                                                                       <span class="err">│</span>
      <span class="mo">00000000000</span><span class="n">a0000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">bffff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">vga</span><span class="o">-</span><span class="n">lowmem</span>                                                               <span class="err">│</span>
      <span class="mo">00000000000</span><span class="n">c0000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">dffff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rom</span><span class="p">)</span><span class="o">:</span> <span class="n">pc</span><span class="p">.</span><span class="n">rom</span>                                                                   <span class="err">│</span>
      <span class="mf">00000000000e0000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">fffff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rom</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">isa</span><span class="o">-</span><span class="n">bios</span> <span class="err">@</span><span class="n">pc</span><span class="p">.</span><span class="n">bios</span> <span class="mo">0000000000020000</span><span class="o">-</span><span class="mo">000000000003</span><span class="n">ffff</span>                <span class="err">│</span>
      <span class="mo">00000000</span><span class="n">fd000000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">fdffffff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ram</span><span class="p">)</span><span class="o">:</span> <span class="n">vga</span><span class="p">.</span><span class="n">vram</span>                                                                 <span class="err">│</span>
      <span class="mo">00000000</span><span class="n">fe000000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">fe003fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">virtio</span><span class="o">-</span><span class="n">pci</span>                                                               <span class="err">│</span>
        <span class="mo">00000000</span><span class="n">fe000000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">fe000fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">virtio</span><span class="o">-</span><span class="n">pci</span><span class="o">-</span><span class="n">common</span><span class="o">-</span><span class="n">virtio</span><span class="o">-</span><span class="mi">9</span><span class="n">p</span>                                            <span class="err">│</span>
        <span class="mo">00000000</span><span class="n">fe001000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">fe001fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">virtio</span><span class="o">-</span><span class="n">pci</span><span class="o">-</span><span class="n">isr</span><span class="o">-</span><span class="n">virtio</span><span class="o">-</span><span class="mi">9</span><span class="n">p</span>                                               <span class="err">│</span>
        <span class="mo">00000000</span><span class="n">fe002000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">fe002fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">virtio</span><span class="o">-</span><span class="n">pci</span><span class="o">-</span><span class="n">device</span><span class="o">-</span><span class="n">virtio</span><span class="o">-</span><span class="mi">9</span><span class="n">p</span>                                            <span class="err">│</span>
        <span class="mo">00000000</span><span class="n">fe003000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">fe003fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">virtio</span><span class="o">-</span><span class="n">pci</span><span class="o">-</span><span class="n">notify</span><span class="o">-</span><span class="n">virtio</span><span class="o">-</span><span class="mi">9</span><span class="n">p</span>                                            <span class="err">│</span>
      <span class="mo">00000000</span><span class="n">febc0000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">febdffff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">e1000</span><span class="o">-</span><span class="n">mmio</span>                                                               <span class="err">│</span>
      <span class="mo">00000000</span><span class="n">febf0000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">febf3fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">nvme</span><span class="o">-</span><span class="n">bar0</span>                                                                <span class="err">│</span>
        <span class="mo">00000000</span><span class="n">febf0000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">febf1fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">nvme</span>                                                                   <span class="err">│</span>
        <span class="mo">00000000</span><span class="n">febf2000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">febf240f</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">msix</span><span class="o">-</span><span class="n">table</span>                                                             <span class="err">│</span>
        <span class="mo">00000000</span><span class="n">febf3000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">febf300f</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">msix</span><span class="o">-</span><span class="n">pba</span>                                                               <span class="err">│</span>
      <span class="mo">00000000</span><span class="n">febf4000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">febf7fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">nvme</span><span class="o">-</span><span class="n">bar0</span>                                                                <span class="err">│</span>
        <span class="mo">00000000</span><span class="n">febf4000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">febf5fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">nvme</span>                                                                   <span class="err">│</span>
        <span class="mo">00000000</span><span class="n">febf6000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">febf640f</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">msix</span><span class="o">-</span><span class="n">table</span>                                                             <span class="err">│</span>
        <span class="mo">00000000</span><span class="n">febf7000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">febf700f</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">msix</span><span class="o">-</span><span class="n">pba</span>                                                               <span class="err">│</span>
      <span class="mo">00000000</span><span class="n">febf8000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">febf8fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">vga</span><span class="p">.</span><span class="n">mmio</span>                                                                 <span class="err">│</span>
        <span class="mo">00000000</span><span class="n">febf8000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">febf817f</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">edid</span>                                                                   <span class="err">└──</span> <span class="n">ram</span><span class="o">-</span><span class="n">below</span><span class="o">-</span><span class="mi">4</span><span class="n">g</span> <span class="err">是</span> <span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="err">的一个</span> <span class="n">alias</span>
        <span class="mo">00000000</span><span class="n">febf8400</span><span class="o">-</span><span class="mo">00000000</span><span class="n">febf841f</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">vga</span> <span class="n">ioports</span> <span class="n">remapped</span>
        <span class="mo">00000000</span><span class="n">febf8500</span><span class="o">-</span><span class="mo">00000000</span><span class="n">febf8515</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">bochs</span> <span class="n">dispi</span> <span class="n">interface</span>                                                  <span class="err">┌──</span> <span class="n">ram</span><span class="o">-</span><span class="n">above</span><span class="o">-</span><span class="mi">4</span><span class="n">g</span> <span class="err">也是</span> <span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="err">的一个</span> <span class="n">alias</span><span class="p">,</span> <span class="err">两者都被放到</span> <span class="n">system</span> <span class="err">这个</span> <span class="n">MemoryRegion</span> <span class="err">上</span>
        <span class="mo">00000000</span><span class="n">febf8600</span><span class="o">-</span><span class="mo">00000000</span><span class="n">febf8607</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">qemu</span> <span class="n">extended</span> <span class="n">regs</span>                                                     <span class="err">│</span>
      <span class="mo">00000000</span><span class="n">febf9000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">febf9fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">virtio</span><span class="o">-</span><span class="mi">9</span><span class="n">p</span><span class="o">-</span><span class="n">pci</span><span class="o">-</span><span class="n">msix</span>                                                       <span class="err">│</span>
        <span class="mo">00000000</span><span class="n">febf9000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">febf901f</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">msix</span><span class="o">-</span><span class="n">table</span>                                                             <span class="err">│</span>
        <span class="mo">00000000</span><span class="n">febf9800</span><span class="o">-</span><span class="mo">00000000</span><span class="n">febf9807</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">msix</span><span class="o">-</span><span class="n">pba</span>                                                               <span class="err">│</span>
      <span class="mo">00000000</span><span class="n">fffc0000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">ffffffff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rom</span><span class="p">)</span><span class="o">:</span> <span class="n">pc</span><span class="p">.</span><span class="n">bios</span>                                                                  <span class="err">│</span>
    <span class="mo">00000000000</span><span class="n">a0000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">bffff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">smram</span><span class="o">-</span><span class="n">region</span> <span class="err">@</span><span class="n">pci</span> <span class="mo">00000000000</span><span class="n">a0000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">bffff</span>                  <span class="err">│</span>
    <span class="mo">00000000000</span><span class="n">c0000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">c3fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ram</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">pam</span><span class="o">-</span><span class="n">rom</span> <span class="err">@</span><span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="mo">00000000000</span><span class="n">c0000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">c3fff</span>                    <span class="err">│</span>
    <span class="mo">00000000000</span><span class="n">c4000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">c7fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ram</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">pam</span><span class="o">-</span><span class="n">rom</span> <span class="err">@</span><span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="mo">00000000000</span><span class="n">c4000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">c7fff</span>                    <span class="err">│</span>
    <span class="mo">00000000000</span><span class="n">c8000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">cbfff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ram</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">pam</span><span class="o">-</span><span class="n">rom</span> <span class="err">@</span><span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="mo">00000000000</span><span class="n">c8000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">cbfff</span>                    <span class="err">│</span>
    <span class="mo">00000000000</span><span class="n">cb000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">cdfff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">ram</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">kvmvapic</span><span class="o">-</span><span class="n">rom</span> <span class="err">@</span><span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="mo">00000000000</span><span class="n">cb000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">cdfff</span>            <span class="err">│</span>
    <span class="mo">00000000000</span><span class="n">cc000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">cffff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ram</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">pam</span><span class="o">-</span><span class="n">rom</span> <span class="err">@</span><span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="mo">00000000000</span><span class="n">cc000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">cffff</span>                    <span class="err">│</span>
    <span class="mo">00000000000</span><span class="n">d0000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">d3fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ram</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">pam</span><span class="o">-</span><span class="n">rom</span> <span class="err">@</span><span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="mo">00000000000</span><span class="n">d0000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">d3fff</span>                    <span class="err">│</span>
    <span class="mo">00000000000</span><span class="n">d4000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">d7fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ram</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">pam</span><span class="o">-</span><span class="n">rom</span> <span class="err">@</span><span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="mo">00000000000</span><span class="n">d4000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">d7fff</span>                    <span class="err">│</span>
    <span class="mo">00000000000</span><span class="n">d8000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">dbfff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ram</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">pam</span><span class="o">-</span><span class="n">rom</span> <span class="err">@</span><span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="mo">00000000000</span><span class="n">d8000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">dbfff</span>                    <span class="err">│</span>
    <span class="mo">00000000000</span><span class="n">dc000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">dffff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ram</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">pam</span><span class="o">-</span><span class="n">rom</span> <span class="err">@</span><span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="mo">00000000000</span><span class="n">dc000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">dffff</span>                    <span class="err">│</span>
    <span class="mf">00000000000e0000</span><span class="o">-</span><span class="mf">00000000000e3</span><span class="n">fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ram</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">pam</span><span class="o">-</span><span class="n">rom</span> <span class="err">@</span><span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="mf">00000000000e0000</span><span class="o">-</span><span class="mf">00000000000e3</span><span class="n">fff</span>                    <span class="err">│</span>
    <span class="mf">00000000000e4000</span><span class="o">-</span><span class="mf">00000000000e7</span><span class="n">fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ram</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">pam</span><span class="o">-</span><span class="n">ram</span> <span class="err">@</span><span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="mf">00000000000e4000</span><span class="o">-</span><span class="mf">00000000000e7</span><span class="n">fff</span>                    <span class="err">│</span>
    <span class="mf">00000000000e8000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">ebfff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ram</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">pam</span><span class="o">-</span><span class="n">ram</span> <span class="err">@</span><span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="mf">00000000000e8000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">ebfff</span>                    <span class="err">│</span>
    <span class="mo">00000000000</span><span class="n">ec000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">effff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ram</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">pam</span><span class="o">-</span><span class="n">ram</span> <span class="err">@</span><span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="mo">00000000000</span><span class="n">ec000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">effff</span>                    <span class="err">│</span>
    <span class="mo">00000000000</span><span class="n">f0000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">fffff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ram</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">pam</span><span class="o">-</span><span class="n">rom</span> <span class="err">@</span><span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="mo">00000000000</span><span class="n">f0000</span><span class="o">-</span><span class="mo">00000000000</span><span class="n">fffff</span>                    <span class="err">│</span>
    <span class="mo">00000000</span><span class="n">fec00000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">fec00fff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">ioapic</span>                                                                     <span class="err">│</span>
    <span class="mo">00000000</span><span class="n">fed00000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">fed003ff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">hpet</span>                                                                       <span class="err">│</span>
    <span class="mo">00000000</span><span class="n">fee00000</span><span class="o">-</span><span class="mo">00000000</span><span class="n">feefffff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="n">o</span><span class="p">)</span><span class="o">:</span> <span class="n">apic</span><span class="o">-</span><span class="n">msi</span>                                                                <span class="err">│</span>
    <span class="mo">0000000100000000</span><span class="o">-</span><span class="mo">00000001</span><span class="n">bfffffff</span> <span class="p">(</span><span class="n">prio</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ram</span><span class="p">)</span><span class="o">:</span> <span class="n">alias</span> <span class="n">ram</span><span class="o">-</span><span class="n">above</span><span class="o">-</span><span class="mi">4</span><span class="n">g</span> <span class="err">@</span><span class="n">pc</span><span class="p">.</span><span class="n">ram</span> <span class="mo">00000000</span><span class="n">c0000000</span><span class="o">-</span><span class="mo">000000017</span><span class="n">fffffff</span> <span class="err">──────────────┘</span>
</code></pre></div></div><h4 id="dirty-page-tracking-脏页标记"> <a href="#dirty-page-tracking-脏页标记" class="anchor-heading" aria-labelledby="dirty-page-tracking-脏页标记"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> dirty page tracking 脏页标记</h4><h5 id="dirty-bitmap"> <a href="#dirty-bitmap" class="anchor-heading" aria-labelledby="dirty-bitmap"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> dirty bitmap</h5><ul><li>bitmap是将原本需要占用1个字节或者多个字节的整数，转化成对一个字节单位中的一个确定位置的比特的占用<li>Bitmaps are bit vectors where each ‘1’ bit in the vector indicates a modified (“dirty”) segment of the corresponding block device. The size of the segment that is tracked is the granularity of the bitmap. If the granularity of a bitmap is 64K, each ‘1’ bit means that a 64K region as a whole may have changed in some way, possibly by as little as one byte.、<li>将向量上的每个“1”表示为对应块的脏页，bitmap的增量每增加“1”，就是每个内存脏页大小（4kByte）变更了<li><p>核心：使用 bitmap 上每一个 solt 槽位来表示一个固定大小的脏页是否变更</p><li>https://qemu-project.gitlab.io/qemu/interop/bitmaps.html</ul><h5 id="dirty-ring"> <a href="#dirty-ring" class="anchor-heading" aria-labelledby="dirty-ring"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> dirty ring</h5><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* https://blog.csdn.net/huang987246510/article/details/112293303
</code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+-------------+          +----------+       +--------------+          +---------------------+
|             |          | ram_list +-----&gt; | dirty_memory +--------&gt; | migration_bitmap_rcu|
|             |          +----------+       +------+-------+          +---------------------+
| Guest       |                                    ^
|             |                                    |
|             |                                    |
|             |                                    |用户态
|             +--------------------------------+   |-----
|             |                                |   |内核态
|             |                                |   |
|             |                                |   |
|             |                                v   |
|             |                                    |
|             |          +---------+       +-------+--------+
|             |          | memslot +-----&gt; | dirty_bitmap   |
+-------------+          +---------+       +----------------+
</code></pre></div></div><h5 id="用户态"> <a href="#用户态" class="anchor-heading" aria-labelledby="用户态"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 用户态</h5><ul><li>用户态与脏页统计有关的数据结构：RAMList和RAMBlock<li>RAMList用在从内核获取脏页的时候，它表示脏页的粒度是kvm中的一个slot<ul><li>如前所述：KVMSlot 定义了GPA到HVA的映射关系，也就是虚拟机物理地址和宿主机OS虚拟地址之间的关系</ul><li>RAMBlock中的位图用来描述一个RAMBlock的脏页使用情况，它表示的脏页粒度是Qemu中的一个RAMBlock<li>在内存迁移统计脏页过程中，会依次使用这两个数据结构统计剩余内存的脏页数量</ul><h5 id="内核态"> <a href="#内核态" class="anchor-heading" aria-labelledby="内核态"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 内核态</h5><ul><li>kvm_userspace_memory_region<li>kvm_dirty_log<li>kvm_memory_slot<li>为了让用于态统计虚机的脏页，内核提供了两个接口，分别是KVM_SET_USER_MEMORY_REGION、KVM_GET_DIRTY_LOG，这两个接口<li>内核提供了两个命令供用户态统计虚机的脏页，KVM_SET_USER_MEMORY_REGION、KVM_GET_DIRTY_LOG，KVM_SET_USER_MEMORY_REGION命令字作用在vm的fd，用来通知kvm开启对某段内存区域的脏页跟踪，结构体kvm_userspace_memory_region 是用户态传入的参数，用来描述kvm应该跟踪的内存区域<li>KVM_GET_DIRTY_LOG命令字作用在vm的fd，用来获取内核跟踪的脏页信息，结构体kvm_dirty_log作为参数用来指定要查询的内存slot，同时保存内核的脏页查询结果</ul><h5 id="交互过程简介"> <a href="#交互过程简介" class="anchor-heading" aria-labelledby="交互过程简介"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 交互过程简介</h5><ul><li>根据PML的硬件特性，每当CPU在Guest态根据EPT转换地址后，写数据到物理页，这时如果PML特性开启，在设置EPT页表项的Dirty位之后，还会将GPA地址写入PML Buffer。</ul><h5 id="清零dirty位"> <a href="#清零dirty位" class="anchor-heading" aria-labelledby="清零dirty位"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 清零Dirty位</h5><ul><li>KVM的实现中，在创建slot时，如果不想记录某个slot包含的所有物理页的是否为脏，需要默认将这些物理页对应的页表项的Dirty页置位，因为如果Dirty位是0，Guest态CPU写物理页时会将其置1并且填充GPA到PML Buffer，如果PML Buffer满了，就会触发VMExit，增加不必要的开销。反之，要记录脏页，首先需要将指向slot包含的所有物理页的spte的Dirty位清零，这里需要根据gfn找到指向该gfn对应页的spte，反向映射数组rmap就派上了用场。 物理页开启写保护：除了清零页表项的Dirty位，记录脏页还需要开启页的写保护，在脏页记录的过程中，所有slot包含的物理页变成只读，当CPU写访问这个页时，发生缺页异常，kvm会重新分配一个新的页给CPU。在脏页记录关闭后，才能将写保护去掉，slot包含的所有页变成可读写。</ul><h5 id="步骤"> <a href="#步骤" class="anchor-heading" aria-labelledby="步骤"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 步骤</h5><ol><li>qemu 初始化一个 bitmap 结构体 <code class="language-plaintext highlighter-rouge">migration_bitmap_rcu</code> 并set所有的solt 为1<li>qemu 将对内存页的标脏提交给 kvm 并调用 address_space_update_topology_pass<li>address_space_update_topology_pass 调用 log_start 将已经定义的 memory slot 增加 KVM_MEM_LOG_DIRTY_PAGES 的 flag，这一步就是内核标脏<li>kvm_create_dirty_bitmap kvm 初始化内存脏页 bitmap kvm_create_dirty_bitmap<li>qemu kvm 通过 migration_bitmap_sync 将内核脏页的 usersSpace 同步到 ram_list 结构体中<li>migration_bitmap_sync 将当前 ram_list 中的脏页 bitmap 拷贝到 migration_bitmap_rcu，这一步主要就是将kernal中的脏页同步回 qemu bitmap 结构体中<li>通过对 migration_bitmap_rcu-&gt;bmap 的迭代，qemu将通过调用 ram_find_and_save_block 找到脏页并将脏页写入初始化的 fd</ol><h5 id="简化步骤"> <a href="#简化步骤" class="anchor-heading" aria-labelledby="简化步骤"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 简化步骤</h5><ol><li>qemu 初始化一个处于用户态的 bitmap 用于记录脏页，并set所有的solt 为1<li>qemu 初始化 RAMList 和 RAMBlock，分别用于存储虚拟机整个地址空间 kvmslot 和 用于表示单个脏页的 RAMBlock<li>qemu 将对内存页的标脏提交给 kvm<li>kvm 将已经定义的 memory slot 增加标脏的 flag，这一步就是内核标脏<li>qemu kvm中通过 kvm_vm_ioctl 获取内存脏页并同步到 RAMList和RAMBlock<li>将当前 ram_list 中的脏页 bitmap 拷贝到 migration_bitmap_rcu，这一步主要就是将kernal中的脏页同步回 qemu bitmap 结构体中<li>通过对 migration_bitmap_rcu-&gt;bmap 的迭代，qemu将通过调用 ram_find_and_save_block 找到脏页并将脏页写入初始化的 fd<li>对已经完成拷贝的 block 进行清脏 KVM_CLEAR_DIRTY_LOG（一次拷贝完成，对端返回脏页数量）<li>计算内存脏页率<li>进行第二次拷贝</ol><ul><li>执行栈帧<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(gdb) bt
#0  kvm_set_user_memory_region (kml=0x55ab8fc502c0, slot=0x55ab8fc50500) at /home/liqiang02/qemu0711/qemu-2.8/kvm-all.c:236
#1  0x000055ab8df10a92 in kvm_slot_update_flags (kml=0x55ab8fc502c0, mem=0x55ab8fc50500, mr=0x55ab8fd36f70)
  at /home/liqiang02/qemu0711/qemu-2.8/kvm-all.c:376
#2  0x000055ab8df10b1f in kvm_section_update_flags (kml=0x55ab8fc502c0, section=0x7f0ab37fb4c0)
  at /home/liqiang02/qemu0711/qemu-2.8/kvm-all.c:389
#3  0x000055ab8df10b65 in kvm_log_start (listener=0x55ab8fc502c0, section=0x7f0ab37fb4c0, old=0, new=4)
  at /home/liqiang02/qemu0711/qemu-2.8/kvm-all.c:404
#4  0x000055ab8df18b33 in address_space_update_topology_pass (as=0x55ab8ea21880 &lt;address_space_memory&gt;, old_view=0x7f0cc4118ca0, 
  new_view=0x7f0aa804d380, adding=true) at /home/liqiang02/qemu0711/qemu-2.8/memory.c:854
#5  0x000055ab8df18d9b in address_space_update_topology (as=0x55ab8ea21880 &lt;address_space_memory&gt;)
  at /home/liqiang02/qemu0711/qemu-2.8/memory.c:886
#6  0x000055ab8df18ed6 in memory_region_transaction_commit () at /home/liqiang02/qemu0711/qemu-2.8/memory.c:926
#7  0x000055ab8df1c9ef in memory_global_dirty_log_start () at /home/liqiang02/qemu0711/qemu-2.8/memory.c:2276
#8  0x000055ab8df30ce6 in ram_save_init_globals () at /home/liqiang02/qemu0711/qemu-2.8/migration/ram.c:1939
#9  0x000055ab8df30d36 in ram_save_setup (f=0x55ab90d874c0, opaque=0x0) at /home/liqiang02/qemu0711/qemu-2.8/migration/ram.c:1960
#10 0x000055ab8df3609a in qemu_savevm_state_begin (f=0x55ab90d874c0, params=0x55ab8ea0178c &lt;current_migration+204&gt;)
  at /home/liqiang02/qemu0711/qemu-2.8/migration/savevm.c:956
#11 0x000055ab8e25d9b8 in migration_thread (opaque=0x55ab8ea016c0 &lt;current_migration&gt;) at migration/migration.c:1829
#12 0x00007f0cda1fd494 in start_thread () from /lib/x86_64-linux-gnu/libpthread.so.0
#13 0x00007f0cd9f3facf in clone () from /lib/x86_64-linux-gnu/libc.so.6
</code></pre></div></div></ul><h3 id="4---qemu-向-tcp-sockets-中写入内存数据迁移的控制层和实现层完全分开"> <a href="#4---qemu-向-tcp-sockets-中写入内存数据迁移的控制层和实现层完全分开" class="anchor-heading" aria-labelledby="4---qemu-向-tcp-sockets-中写入内存数据迁移的控制层和实现层完全分开"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4 - qemu 向 tcp sockets 中写入内存数据（迁移的控制层和实现层完全分开）</h3><ul><li>开始迁移内存，将内存数据拷贝到目的端（defaultpage size 4k）<li>发送内存数据到目的端，返回发送的内存页个数<li>qemu每拷贝一次内存之前，会统计一次剩余的脏页数量，对比域值后决定是否一次性迁移<ul><li>脏页统计方法：dirtyrate = increased_memory / meaurement_time<li>脏页速率越大，虚机内存变化越快，迁移时花费的时间就越多<li>脏页统计率的统计过程和 dirty page tracking 类似，也是通过对内核中的脏页和qemu bitmap 之间的同步来计算增量<li>https://blog.csdn.net/huang987246510/article/details/118424717</ul><li>内存发送和接收</ul><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   source                                destination

            +------------------------+             +-------------------------+
            |                        |             |                         |
  SETUP     | ram_save_setup         |             |  ram_load_setup         |
            |                        |             |                         |
            +------------------------+             +-------------------------+

            sync dirty bit to                      Setup RAMBlock-&gt;receivedmap
        RAMBlock-&gt;bmap


            +------------------------+             +-------------------------+
            |                        |             |                         |
  ITER      | ram_save_pending       |             |  ram_load               |
            | ram_save_iterate       |             |                         |
            |                        |             |                         |
            +------------------------+             +-------------------------+

            sync dirty bit                         Receive page
        and send page


            +------------------------+             +-------------------------+
            |                        |             |                         |
  COMP      | ram_save_pending       |             |  ram_load               |
            | ram_save_complete      |             |                         |
            |                        |             |                         |
            +------------------------+             +-------------------------+

            sync dirty bit                         Receive page
              and send page
</code></pre></div></div><h3 id="5---迭代所有脏页脏页达到一定的水平线"> <a href="#5---迭代所有脏页脏页达到一定的水平线" class="anchor-heading" aria-labelledby="5---迭代所有脏页脏页达到一定的水平线"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5 - 迭代所有脏页，脏页达到一定的水平线</h3><ul><li>TODO</ul><h3 id="6---暂停虚拟机默认值30ms一次性迁移剩余脏页"> <a href="#6---暂停虚拟机默认值30ms一次性迁移剩余脏页" class="anchor-heading" aria-labelledby="6---暂停虚拟机默认值30ms一次性迁移剩余脏页"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 6 - 暂停虚拟机（默认值30ms），一次性迁移剩余脏页</h3><h3 id="7---启动目的端vm"> <a href="#7---启动目的端vm" class="anchor-heading" aria-labelledby="7---启动目的端vm"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7 - 启动目的端vm</h3><h1 id="热迁移-downtime"> <a href="#热迁移-downtime" class="anchor-heading" aria-labelledby="热迁移-downtime"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 热迁移 downtime</h1><h2 id="什么是-downtime"> <a href="#什么是-downtime" class="anchor-heading" aria-labelledby="什么是-downtime"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 什么是 downtime</h2><ul><li>脏页率达到指定阈值之后，暂停虚拟机，一次性迁移剩余脏页，并启动目的虚拟机的过程耗时<li>热迁移的停机时间（downtime）不是简单设置一个数字<li>迁移过程中的停机时间是变化的<li>不断增加，在一段时间后停机时间达到最终的最大值（用户态给定的最大值），这个值就是 live_migration_downtime</ul><h2 id="影响参数"> <a href="#影响参数" class="anchor-heading" aria-labelledby="影响参数"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 影响参数</h2><ul><li>CONF.libvirt.live_migration_downtime<ul><li>最大值，手动配置、配置读取<li>downtime_steps 每个 Step 的 max downtime 都在递增直到真正用户设定的最大可容忍 downtime， 这是因为 Nova 在不断的试探实际最小的 max downtime，尽可能早的进入退出状态。</ul><li>CONF.libvirt.live_migration_downtime_steps<ul><li>最大值，手动配置、配置读取<li>一个元组表示一个 Step，分 Steps 次给 libvirtd 传输</ul><li>CONF.libvirt.live_migration_downtime_delay<ul><li>最大值，手动配置、配置读取<li>下一次传递时间间隔</ul><li>downtime 通过上面一个算法得出：每次迭代都会重新计算虚拟机新的脏内存以及每次迭代所花掉的时间来估算带宽，再根据带宽和当前迭代的脏页数计算出传输剩余数据的时间<li>如果最后一次 libvirtd 迭代计算出来的 downtime 在传递的 downtime 范围内，则满足退出条件<li>自动收敛模式：如果虚拟机持续处于高业务状态，那么 libvirtd 会自动调整 vCPU 参数以减轻负载，达到降低脏内存的增长速度，从而保证 downtime 进入退出范围<li>compute 中通过 migrateSetMaxDowntime 实现</ul></main><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0">Engineering & Philosophy & Life Experience - A Motorcycle rider and loving husband.</p><div class="d-flex mt-2"></div></footer></div></div><div class="search-overlay"></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.6/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script>
