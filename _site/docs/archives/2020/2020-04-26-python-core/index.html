<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"><link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"><style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li:not(:nth-child(21)) > a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(2) > ul > li:nth-child(3) > ul > li:nth-child(21) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(2) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(2) > ul > li:nth-child(3) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(2) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(3) > ul.nav-list { display: block; }</style><script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon"><title>Python&amp;CPython核心 | Adam Yan Na Docs</title><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Python&amp;CPython核心" /><meta property="og:locale" content="en_US" /><meta name="description" content="Engineering &amp; Philosophy &amp; Life Experience" /><meta property="og:description" content="Engineering &amp; Philosophy &amp; Life Experience" /><link rel="canonical" href="http://localhost:4000/docs/archives/2020/2020-04-26-python-core/" /><meta property="og:url" content="http://localhost:4000/docs/archives/2020/2020-04-26-python-core/" /><meta property="og:site_name" content="Adam Yan Na Docs" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Python&amp;CPython核心" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Engineering &amp; Philosophy &amp; Life Experience","headline":"Python&amp;CPython核心","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/icon-512x512.png"}},"url":"http://localhost:4000/docs/archives/2020/2020-04-26-python-core/"}</script><body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewBox="0 0 16 16"><title>Copy</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"><title>Copied</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg><div class="side-bar"><div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"><div class="site-logo" role="img" aria-label="Adam Yan Na Docs"></div></a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button></div><nav aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Archives category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/archives/" class="nav-list-link">Archives</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2018 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2018/2018/" class="nav-list-link">2018</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/archives/2018/2018-10-26-Algorithm-matrix/" class="nav-list-link">Algorithm Matrix</a><li class="nav-list-item"> <a href="/docs/archives/2018/2018-10-25-PostgreSQL/" class="nav-list-link">PostgreSQL fundamental and operation</a><li class="nav-list-item"> <a href="/docs/archives/2018/2018-10-23-Postgresql-pgpool/" class="nav-list-link">Postgresql HA & Loadblance - pgpool II</a><li class="nav-list-item"> <a href="/docs/archives/2018/2018-12-05-V2ray-Websocket-Nginx/" class="nav-list-link">V2ray Nginx 配置</a><li class="nav-list-item"> <a href="/docs/archives/2018/2018-12-05-Linux-Ulimit/" class="nav-list-link">通过 ulimit 改善系统性能</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2019 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2019/2019/" class="nav-list-link">2019</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/archives/2019/2019-02-20-RabbitMQ-pub-sub/" class="nav-list-link">RabbitMQ & AMQP</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2020 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2020/2020/" class="nav-list-link">2020</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/archives/2020/2020-09-22-roles-of-agile-team/" class="nav-list-link">Agile</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-02-18-Algorithm-Everything/" class="nav-list-link">Algorithm Everything</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-31-algorithm-heap/" class="nav-list-link">Algorithm-heap 堆排序的实现</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-14-ansible-automation/" class="nav-list-link">Ansible自动化</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-01-08-%5BBeginning-of-2020--Algorithm%5D/" class="nav-list-link">BeginningOf2020 - Algorithm</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-16-c-programming-language-recap/" class="nav-list-link">C programming language recap</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-10-c-cpp-syntactic-sugar/" class="nav-list-link">C/C++ Syntactic sugar 语法糖</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-13-cpython-implementation/" class="nav-list-link">CPython源代码分析&虚拟机原理</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-07-26-cloud-qualification/" class="nav-list-link">Cloud Qualification</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-13-redis_data_sampling/" class="nav-list-link">Data Sampling [Redis]</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-07-12-git-advanced/" class="nav-list-link">Git进阶</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-05-golang-performance-flame-graph/" class="nav-list-link">Golang性能分析和监控</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-20-select-poll-epoll/" class="nav-list-link">I/O的多路复用算法</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-03-kubernetes-curve/" class="nav-list-link">Kubernetes & Docker</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-13-linux-command-tools/" class="nav-list-link">Linux常用工具&内置命令</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-18-linux-networking/" class="nav-list-link">Linux网络基础</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-08-05-macos-configuration/" class="nav-list-link">MacOS Configure</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-14-monitor_system_restructure/" class="nav-list-link">Monitor System</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-02-Algorithm-curve/" class="nav-list-link">My Algorithm Curve</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-06-Prometheus/" class="nav-list-link">Prometheus</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-26-python-core/" class="nav-list-link">Python&CPython核心</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-25-python-memory-management-implementation/" class="nav-list-link">Python内存管理的底层实现&程序内存分析</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-24-Python-dynamic-map/" class="nav-list-link">Python实现动态生成类的http接口-monitor动态监控项</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-05-python-performance-flame-graph/" class="nav-list-link">Python性能分析和火焰图</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-14-python-service-deployment/" class="nav-list-link">Python服务容器化部署</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-30-CPython-malloc-python-gc/" class="nav-list-link">Python进程内存分析&大量内存占用的优化方案</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-14-redhat-6.5-python-dependency/" class="nav-list-link">Red Hat Enterprise Linux Kernel Version 2.6.32 3.8.13 python依赖环境手动部署</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-31-Redis/" class="nav-list-link">Redis学习及源码分析</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-01-08-%5BSum-of-2019--DataInfluxPatrol-Golang%5D/" class="nav-list-link">SumOf2019 - DataInfluxPatrol</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-09-man-signal/" class="nav-list-link">linux signal</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-13-pg-dead-lock/" class="nav-list-link">pg数据库过程事务执行的锁竞争导致锁表</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-01-01-cs-communication-physical-architecture/" class="nav-list-link">体系结构-树</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-18-tech-stack-planning-2020/" class="nav-list-link">技术栈提升规划 [2020]</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-13-data-patrol/" class="nav-list-link">时序数据完整性的方法巡检工具</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-12-core-knowledge/" class="nav-list-link">核心知识库</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-01-iter-massive-data-programming/" class="nav-list-link">海量数据程序设计思路</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-27-csapp/" class="nav-list-link">深入理解计算机系统 [Computer-Systems-A-Programmer's-Perspective]</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-20-operating-system/" class="nav-list-link">现代操作系统</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-25-pointer-reference-understanding/" class="nav-list-link">理解C/C++中的指针和引用</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-16-tcp-network-analysis/" class="nav-list-link">生产环境TCP网络问题分析</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-07-capsule/" class="nav-list-link">知识碎片</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-02-b-tree-and-indexing-principle/" class="nav-list-link">红黑树&B树应用及索引原理</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-16-network-curve/" class="nav-list-link">计算机网络</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2021 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2021/2021/" class="nav-list-link">2021</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/archives/2021/2021-02-15-mac-reset-smc-nvram/" class="nav-list-link">Mac Reset Smc Nvram</a><li class="nav-list-item"> <a href="/docs/archives/2021/2021-02-15-research-of-ergonomics/" class="nav-list-link">Research of Ergonomics</a><li class="nav-list-item"> <a href="/docs/archives/2021/2021-02-15-work-efficiency/" class="nav-list-link">Work Efficiency</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2022 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2022/2022/" class="nav-list-link">2022</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/archives/2022/2022-11-19-Criticism-of-Hegelianism/" class="nav-list-link">Criticism of Hegelianism</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2023 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2023/2023/" class="nav-list-link">2023</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/archives/2023/2023-01-02-live_migration_precopy/" class="nav-list-link">Live Migration Precopy Analyze</a></ul></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Engineering category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/engineering/engineering/" class="nav-list-link">Engineering</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in I. Foundament category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/engineering/foundament/foundament/" class="nav-list-link">I. Foundament</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/engineering/foundament/algorithm/algorithm/" class="nav-list-link">1.1 Algorithm</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in II. System Design category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/engineering/system_design/system_design/" class="nav-list-link">II. System Design</a><ul class="nav-list"></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in III. Experience category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/engineering/experience/experience/" class="nav-list-link">III. Experience</a><ul class="nav-list"></ul><li class="nav-list-item"><a href="/docs/engineering/kickstart_and_recap_231112205754/" class="nav-list-link">Kickstart & Recap</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Jq category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/jq/jq/" class="nav-list-link">Jq</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Cloud Native Automation category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/jq/cloud_native_automation/cloud_native_automation/" class="nav-list-link">Cloud Native Automation</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/jq/cloud_native_automation/python_automation/" class="nav-list-link">Python automation</a></ul></ul></ul><ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/adamyanna" class="nav-list-link external" > Adam Yan Na GitHub <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a><li class="nav-list-item external"> <a href="https://www.linkedin.com/in/adam-yan-na" class="nav-list-link external" > Adam Yan Na Linkedin <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search" role="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Adam Yan Na Docs" aria-label="Search Adam Yan Na Docs" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="https://github.com/adamyanna" class="site-button" > Adam Yan Na GitHub </a><li class="aux-nav-list-item"> <a href="https://www.linkedin.com/in/adam-yan-na" class="site-button" > Adam Yan Na Linkedin </a></ul></nav></div><div class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="/docs/archives/archives/">Archives</a><li class="breadcrumb-nav-list-item"><a href="/docs/archives/2020/2020/">2020</a><li class="breadcrumb-nav-list-item"><span>Python&CPython核心</span></ol></nav><div id="main-content" class="main-content"><main><p class="label label-blue"><strong>CPython</strong></p><p class="label label-green"><strong>Python</strong></p><p class="label label-yellow"><strong>2020-04-26 10:00:00 +0800</strong></p><h1 id="pythoncpython核心"> <a href="#pythoncpython核心" class="anchor-heading" aria-labelledby="pythoncpython核心"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Python&amp;CPython核心</h1><blockquote><p>“生成器与协程、CPython虚拟机原理、CPython解释器原理、内存管理与引用计数与优化、高级第三方库、Python语法魔术”</p></blockquote><h1 id="cpython核心"> <a href="#cpython核心" class="anchor-heading" aria-labelledby="cpython核心"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> CPython核心</h1><h2 id="i-虚拟机工作原理cpython源代码工作方式"> <a href="#i-虚拟机工作原理cpython源代码工作方式" class="anchor-heading" aria-labelledby="i-虚拟机工作原理cpython源代码工作方式"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> I. 虚拟机工作原理&amp;CPython源代码&amp;工作方式</h2><h1 id="evaluation-loop-cevalc"> <a href="#evaluation-loop-cevalc" class="anchor-heading" aria-labelledby="evaluation-loop-cevalc"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Evaluation Loop <strong>ceval.c</strong></h1><ul><li>Python虚拟机的 <strong>核心部分</strong>，迭代执行python字节码指令；迭代执行的实现依靠 <strong>for</strong> 循环；<li>Python/ceval.c 模块，包含实现执行部分的核心代码，核心函数为 <strong>PyEval_EvalFrameEx</strong>，该函数中包含执行循环；<li>ceval.c 模块会针对不同的平台或者操作系统类型，进行对线程和虚拟机有不同的优化；</ul><h1 id="执行循环的工作原理"> <a href="#执行循环的工作原理" class="anchor-heading" aria-labelledby="执行循环的工作原理"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 执行循环的工作原理</h1><ul><li>执行前的准备工作 initialization &amp; prepare context<ul><li><strong>_PyEval_EvalCodeWithName</strong><ul><li>代码对象从代码块创建，在python源代码中，代码块包含函数、模块、类、装饰器等等；<li>从代码块创建的代码对象会经过一连串的函数调用 run_mod -&gt; PyEval_EvalCode -&gt; PyEval_EvalCodeEx -&gt; _PyEval_EvalCodeWithName -&gt; PyEval_EvalFrameEx<li>_PyEval_EvalCodeWithName 的过程包括<ul><li>初始化“帧对象”，用来提供执行“代码对象”的上下文<li>为“frame fast locals” 添加 <em>dict</em> 关键词<li>为 “fastlocals” 添加位置参数 <em>positional arguments</em> （python函数中的*args类型的参数）<li>将 无位置变量序列 <em>non-positional variable sequence</em> 和 无关键词参数 <em>non-keyword arguments</em> 添加到 <strong>fastlocals数组</strong>，这些变量都被存放在 <strong>元组</strong> 类型的数据结构中；（python函数中的*args，**kwargs类型的参数）<li>检查代码块是否有提供或是否重复提供 kwargs 类型的参数；<li>检查是否缺少*args位置参数，如果发现缺少则抛出错误<li>添加默认参数到 <em>fastlocals</em> 数组<li>初始化存储空间和单元变量（storage and cell variables）并拷贝空闲变量数组到当前帧中；</ul></ul></ul><li>循环的执行 Evaluation Loop<ul><li><p>始化过程完成后，PyEval_EvalFrameEx会以参数的形式调用帧（frame object）；</p><li><p>PyEval_EvalFrameEx 会进行C的优化，例如宏和计算gotos；</p><li>Evaluation Loop中的核心重要变量 （ceval.c）<ul><li>**stack_pointer，引用下一个要执行的“执行帧”的空闲槽（free slot）；<li>*next_instr，引用执行循环需要执行的下一个指令；可以将该变量视为C程序内存中栈帧的程序计数器指针<code class="language-plaintext highlighter-rouge">%rip</code><li>opcode，引用当前正在执行的opcode或者将要执行的opcode<li>oparg，引用当前执行或将要执行的opcode所需参数<li>why，执行循环 Evaluation Loop 是一个无线循环 - for(;;)，执行循环需要跳出或终止条件，该变量引用当前要跳出循环的原因；例如跳出循环的原因是因为代码快函数的返回，该变量则应用“WHY_RETURN”状态；<li>fastlocals，引用保存了本地变量的数组<li>freevars，引用，变量名称列表，但是这些名称在代码块中并没有被定义；<li>retval，引用代码快的返回值；<li>co，引用了代码对象，参考虚拟机原理，该对象保存着执行循环的“字节码指令”和过程变量；<li>names，引用了“执行帧对象”的代码块中所有值的名称；<li>consts，引用了代码对象中使用的常量；<blockquote><p>回顾虚拟机字节码 python vm bytecode instruction 字节码长度为 16bit，Python虚拟机使用小端法（最低最前，大多数机器都是用小端法表示地址，16进制的最低有效位存储从虚拟内存低地址位开始存储） 字节码包含两个字节，第一个字节存放OPARG，第二个字节存放OPCODE；</p></blockquote></ul><div class="table-wrapper"><table><thead><tr><th>8bit<th>8bit<tbody><tr><td>OPARG<td>OPCODE</table></div><li>重要的C宏<ul><li>TARGET(op) 定义<code class="language-plaintext highlighter-rouge">#define TARGET(op)</code> ，扩展为case op，将当前要执行的字节码和代码快的实现进行匹配；<li>DISPATCH，扩展为 continue，和宏 - FAST_DISPATCH，用来处理执行循环执行完该opcode之后的“控制流”；<li>FAST_DISPATH，扩展为跳入fast_next_opcode标签；</ul><li>处理字节码相关的C宏<ul><li>INSTR_OFFSET()，这个宏在当前的指令数组中为指令提供“字偏移”<li>NEXTOPARG()，这个宏用来更新下一个要执行的指令和过程变量的opcode和oparg变量；</ul><li>执行循环过程分析</ul></ul><h2 id="ii-内存管理和底层数据结构的实现及数据结构的内存分配回收扩容-heap"> <a href="#ii-内存管理和底层数据结构的实现及数据结构的内存分配回收扩容-heap" class="anchor-heading" aria-labelledby="ii-内存管理和底层数据结构的实现及数据结构的内存分配回收扩容-heap"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> II. 内存管理和底层数据结构的实现及数据结构的内存分配、回收、扩容 “heap”</h2><h3 id="优化"> <a href="#优化" class="anchor-heading" aria-labelledby="优化"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 优化</h3><ul><li>最小开销的python代码中变量创建和管理<li>Py_INCREF和Py_DECREF了，它们都是内存管理函数。CPython使用引用计数来管理对象的生命周期。一旦新建引用指向对象，那么Py_INCREF会将对象的引用递增，一旦引用超出作用域，Py_INCREF就会递减对象的引用。<li><p>垃圾回收分析</p><ul><li><p>python的垃圾回收发生的条件</p><blockquote><p>https://docs.python.org/2/library/gc.html 官方文档：The GC classifies objects into three generations depending on how many collection sweeps they have survived. New objects are placed in the youngest generation (generation 0). If an object survives a collection it is moved into the next older generation. Since generation 2 is the oldest generation, objects in that generation remain there after a collection. In order to decide when to run, the collector keeps track of the number object allocations and deallocations since the last collection. When the number of allocations minus the number of deallocations exceeds threshold0, collection starts. Initially only generation 0 is examined. If generation 0 has been examined more than threshold1 times since generation 1 has been examined, then generation 1 is examined as well. Similarly, threshold2 controls the number of collections of generation 1 before collecting generation 2.</p></blockquote><li><p>python内存管理的三层结构</p><ul><li><p>generation 0：新建的对象</p><li><p>generation 1：垃圾回收后，任然存在引用，则归入1</p><li><p>generation 2：最老的无法被collection函数回收的对象</p></ul><li><p>回收机制会在内存分配数量和取消分配数量的差值超过 一个特定的阈值 才会触发</p><li><p>通过gc模块，可以查看默认的阈值，且可以通过调用set_threshold函数，配置定制的阈值</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kn">import</span> <span class="n">gc</span>
 <span class="n">gc</span><span class="p">.</span><span class="nf">get_threshold</span><span class="p">()</span>  <span class="c1">#gc模块中查看阈值的方法
</span> <span class="p">(</span><span class="mi">700</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</code></pre></div></div></ul><li>这里的解释是：阈值超过700时才会对g0的对象进行回收，每10次回收g0会发生1次回收g1，每10次回收g1会发生1次回收g2；<li>gc模块提供主动触发垃圾回收的函数<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="n">generation</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
 <span class="nf">collect</span><span class="p">([</span><span class="n">generation</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">n</span>
</code></pre></div></div><blockquote><p>With no arguments, run a full collection. The optional argument may be an integer specifying which generation to collect. A ValueError is raised if the generation number is invalid.</p></blockquote><ul><li><p>对于不传入参数的调用来说，会发起g0 g1 g2三代的全部的回收；</p><li>CPython对C运行库提供的free函数的调用，也存在一定的条件<li>第3层：最上层，用户对Python对象的直接操作</ul><li>第1层和第2层：内存池，有Python的接口函数PyMem_Malloc实现-----若请求分配的内存在1~256字节之间就使用内存池管理系统进行分配，调用malloc函数分配内存，但是每次只会分配一块大小为256K的大块内存，不会调用free函数释放内存，将该内存块留在内存池中以便下次使用。<ul><li>第0层：大内存-----若请求分配的内存大于256K，malloc函数分配内存，free函数释放内存；</ul></ul><h2 id="iii-生成器和协程-generator--coroutine"> <a href="#iii-生成器和协程-generator--coroutine" class="anchor-heading" aria-labelledby="iii-生成器和协程-generator--coroutine"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> III. 生成器和协程 generator &amp; coroutine</h2><h3 id="生成器对象-generator"> <a href="#生成器对象-generator" class="anchor-heading" aria-labelledby="生成器对象-generator"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 生成器对象 generator</h3><div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* _PyGenObject_HEAD defines the initial segment of generator
   and coroutine objects. */</span>
<span class="cp">#define _PyGenObject_HEAD(prefix)                                           \
    PyObject_HEAD                                                           \、
</span>    <span class="cm">/* Note: gi_frame can be NULL if the generator is "finished" */</span>         \
    <span class="k">struct</span> <span class="n">_frame</span> <span class="o">*</span><span class="n">prefix</span><span class="err">##</span><span class="n">_frame</span><span class="p">;</span>                                          \
    <span class="cm">/* True if generator is being executed. */</span>                              \
    <span class="kt">char</span> <span class="n">prefix</span><span class="err">##</span><span class="n">_running</span><span class="p">;</span>                                                  \
    <span class="cm">/* The code object backing the generator */</span>                             \
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">prefix</span><span class="err">##</span><span class="n">_code</span><span class="p">;</span>                                                \
    <span class="cm">/* List of weak reference. */</span>                                           \
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">prefix</span><span class="err">##</span><span class="n">_weakreflist</span><span class="p">;</span>                                         \
    <span class="cm">/* Name of the generator. */</span>                                            \
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">prefix</span><span class="err">##</span><span class="n">_name</span><span class="p">;</span>                                                \
    <span class="cm">/* Qualified name of the generator. */</span>                                  \
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">prefix</span><span class="err">##</span><span class="n">_qualname</span><span class="p">;</span>                                            \
    <span class="n">_PyErr_StackItem</span> <span class="n">prefix</span><span class="err">##</span><span class="n">_exc_state</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="cm">/* The gi_ prefix is intended to remind of generator-iterator. */</span>
    <span class="n">_PyGenObject_HEAD</span><span class="p">(</span><span class="n">gi</span><span class="p">)</span>
<span class="p">}</span> <span class="n">PyGenObject</span><span class="p">;</span>
</code></pre></div></div><ul><li>结构底层定义为 _PyGenObject_HEAD, 结构体对象为PyGenObject<ul><li>在生成器对象中包含了 帧对象的引用 和 代码对象的引用，回顾python虚拟机实现可知，代码对象在运行时会生成帧对象，解释器对帧对象进行执行，其中包含了代码对象中的Python虚拟机指令和过程变量；<li>运行的生成器提供了 “suspended”阻塞 和 “resumed”就绪 的状态切换的功能；<li>定义的属性包括和宏<ul><li>*prefix##_frame<ul><li>帧对象，包含生成器对象的代码对象引用，用来执行该对象</ul><li>prefix##_running<ul><li>布尔值，用来确定当前的生成器是否还在运行</ul><li>*prefix##_code<ul><li>代码对象引用，生成器用来执行的对象</ul><li>*prefix##_name<ul><li>生成器名称</ul><li>*prefix##_qualname<ul><li>“qualified” 的名称，多数情况下和_name相同；</ul></ul></ul><li>生成器和协程运行原理<ul><li>生成器通过对内置next python函数的调用来执行，当遇到yield python内置表达式时，生成器会发生阻塞；<li>生成器如何保存和获取执行状态，又是怎样在遇到特定的状态是对当前的执行进行状态的更新的<ul><li>如何保存执行状态<ul><li>生成器对象中保存着当前帧对象的引用，该引用中包含了所有生成器需要执行的上下文（代码对象），通过对帧对象的引用，生成器可以捕获执行过程中的所有状态；（状态可以指过程的python虚拟机指令及变量）</ul><li>yield 表达式<ul><li>生成器的执行过程中，在遇到yield语句时会发生主动放弃或让出当前执行时间片，然后Python虚拟机会对当前的生成器的状态进行保存，时间片发生轮转；</ul><li>生成器如何完成调度（这里的调度就是生成器的阻塞和就绪的状态切换，且生成器需要主动放弃当前执行的权限，或者说执行的时间片）<ul><li>next内置函数，当生成器调用next内置函数，next函数的主要作用是对已经发生阻塞的生成器恢复执行，该函数会完成两个作用<ol><li>对当前的指针 “tp_iternext” 解除引用，”tp_iternext” 可以理解为python虚拟机的程序计数器指针，每个运行的线程或者生成器对象在执行期间都会引用程序计数器，从而告诉虚拟机下一条要执行的指令；<li>随机调用 “tp_iternext” 程序计数器关联的任何其他函数，对于当前线程的其他生成器来说，会调用 gen_iternext -&gt; gen_send_ex，最终通过该函数的调用会重新执行之前被阻塞的生成器；</ol><li>通过以上两种方式生成器/协程实现了在Python虚拟机内部的时间片轮转；</ul><li>Python的生成器同样支持参数传递；</ul></ul></ul><h3 id="调度"> <a href="#调度" class="anchor-heading" aria-labelledby="调度"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 调度</h3><h2 id="iv-线程状态对象cil结构对象解释器对象"> <a href="#iv-线程状态对象cil结构对象解释器对象" class="anchor-heading" aria-labelledby="iv-线程状态对象cil结构对象解释器对象"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> IV. 线程状态对象&amp;CIL结构对象&amp;解释器对象</h2><h3 id="调度-1"> <a href="#调度-1" class="anchor-heading" aria-labelledby="调度-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 调度</h3><h2 id="v-对象对象管理"> <a href="#v-对象对象管理" class="anchor-heading" aria-labelledby="v-对象对象管理"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> V. 对象&amp;对象管理</h2><h2 id="vi-内置方法的高级用法"> <a href="#vi-内置方法的高级用法" class="anchor-heading" aria-labelledby="vi-内置方法的高级用法"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> VI. 内置方法的高级用法</h2><h3 id="数据模型"> <a href="#数据模型" class="anchor-heading" aria-labelledby="数据模型"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 数据模型</h3><ul><li><a href="https://docs.python.org/3/reference/datamodel.html">datamodel</a><li>元类 <code class="language-plaintext highlighter-rouge">__metaclass__</code><ul><li><a href="https://docs.python.org/3/reference/datamodel.html">datamodel</a><li>python中默认情况下，类型由type()函数构成，类的主体会创建一个新的namespace用于执行，类名会和type(name, bases, namespace)进行绑定；<li>python可以在类声明行中传递 <code class="language-plaintext highlighter-rouge">metaclass keyword argument</code> 实现元类，或者通过对传递了该参数的类进行继承，原来需要继承自type；<li>元类就是其父类继承自type的类型（子孙类都可以实现元类）；<li>类定义中指定的任何其他关键字参数都将传递到下面描述的所有元类操作；<li>当类定义被执行后，发生了以下的步骤：<ul><li>MRO 入口处理<li>确定该类型适当的元类<li>准备类型的命名空间<li>执行类型主体<li>类型对象呗创建并返回</ul></ul></ul><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Singleton</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="n">__instance</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">__int__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">Singleton</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cls</span><span class="p">.</span><span class="n">__instance</span><span class="p">:</span>
            <span class="n">cls</span><span class="p">.</span><span class="n">__instance</span><span class="p">[</span><span class="n">cls</span><span class="p">]</span> <span class="o">=</span> <span class="nf">super</span><span class="p">(</span><span class="n">Singleton</span><span class="p">,</span> <span class="n">cls</span><span class="p">).</span><span class="nf">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">.</span><span class="n">__instance</span><span class="p">[</span><span class="n">cls</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">Publisher</span><span class="p">():</span>

    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">Singleton</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">Meta</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">MySubclass</span><span class="p">(</span><span class="n">MyClass</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></div><ul><li>抽象基类 <code class="language-plaintext highlighter-rouge">ABC</code><li><code class="language-plaintext highlighter-rouge">__class__</code><ul><li>该方法可以访问当前实例的类，通过该函数可以修改一个实例对象对某个类的引用；</ul><li><code class="language-plaintext highlighter-rouge">__new__</code><ul><li>静态方法，在python的语法中，一切皆对象，<code class="language-plaintext highlighter-rouge">__new__</code> 方法用来创建新的类的实例，该方法的调用中，cls也就是类对象要作为第一个参数，其他参数用来传递给<code class="language-plaintext highlighter-rouge">__new__</code>来构造新的对象，新的对象可能是类的实例，也可能是一个新的类型；<li>在 <code class="language-plaintext highlighter-rouge">__new__</code> 实现中，如果需要实现对父类的调用，可以使用 <code class="language-plaintext highlighter-rouge">super().__new__(cls[, ...])</code> 并且需要传入父类所需要的基本参数，获得父类实例后再进行任何其他修改；<li>在 <code class="language-plaintext highlighter-rouge">__new__</code> 实现中，如果需要实现对父类的类对象调用，可以使用 <code class="language-plaintext highlighter-rouge">super(xxx, cls).__new__(cls[, ...])</code> ，可以获得新的类型，对于在对象构造期间调用 <code class="language-plaintext highlighter-rouge">__new __（）</code> 并返回cls的实例或子类，则将像 <code class="language-plaintext highlighter-rouge">__init __（self [，...]）</code> 一样调用新实例的 <code class="language-plaintext highlighter-rouge">__init __（）</code> 方法，其中self是新实例，而 其余参数与传递给对象构造函数的参数相同。<li>如果<code class="language-plaintext highlighter-rouge">__new__()</code>, 方法调用没有返回任何实例或者子类，那么新实例的<code class="language-plaintext highlighter-rouge">__init __（）</code>方法就不会被调用；<li><code class="language-plaintext highlighter-rouge">__new__</code> 核心作用<ul><li>主要是允许 <strong>不可变</strong> 类型的子类，自定义的创建实例；<li>也用来实现自定义的类和其属性的实现；<li>通常也被自定义元类覆盖。</ul></ul></ul><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">new_cls</span> <span class="o">=</span> <span class="nf">super</span><span class="p">(</span><span class="n">DataModel</span><span class="p">,</span> <span class="n">cls</span><span class="p">).</span><span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">.</span><span class="nf">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="nf">hasattr</span><span class="p">(</span><span class="n">DataModel</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                <span class="nf">setattr</span><span class="p">(</span><span class="n">new_cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_cls</span>
</code></pre></div></div><ul><li><code class="language-plaintext highlighter-rouge">__init__</code><ul><li>在实例创建完成后调用（通过<code class="language-plaintext highlighter-rouge">__new __（）</code>），但在实例返回给调用方之前被调用。 参数是传递给类构造函数表达式的参数。 如果基类具有<code class="language-plaintext highlighter-rouge">__init __（）</code>方法，则派生类的<code class="language-plaintext highlighter-rouge">__init __（）</code>方法（如果有）必须显式调用它，以确保实例的基类部分的正确初始化。 例如：<code class="language-plaintext highlighter-rouge">super（）.__ init __（[args ...]）。</code><li>子类中如果想要调用父类的<code class="language-plaintext highlighter-rouge">__init __（）</code>方法，必须在<code class="language-plaintext highlighter-rouge">__init __（）</code>中通过<code class="language-plaintext highlighter-rouge">super（）</code>显示的调用；<li>因为<code class="language-plaintext highlighter-rouge">__new __（）</code>和<code class="language-plaintext highlighter-rouge">__init __（）</code>在构造对象时一起工作（<code class="language-plaintext highlighter-rouge">__new __（）</code>来创建它，而<code class="language-plaintext highlighter-rouge">__init __（）</code>来对其进行自定义），所以<code class="language-plaintext highlighter-rouge">__init __（）</code>不能返回任何非<code class="language-plaintext highlighter-rouge">None</code>值； 这样做将导致在运行时引发<code class="language-plaintext highlighter-rouge">TypeError</code>。</ul><li><code class="language-plaintext highlighter-rouge">__call__</code><ul><li>该方法会在一个对象被当做函数调用的情况下，调用，<code class="language-plaintext highlighter-rouge">object.__call__(self[, args...]), object()</code><li>通过在类中定义__call __（）方法，可以使任意类的实例成为可调用的。<li>python的任何对象都可以使用<code class="language-plaintext highlighter-rouge">callable()</code>来判断是否可调用，对于不可调用的对象，只需要在对象中实现<code class="language-plaintext highlighter-rouge">__call__</code>方法，例如在元类中实现call方法，则继承元类的子类在生成实例时就会调用；</ul><li>总结<ul><li>单例的多种实现方式在类中重写<code class="language-plaintext highlighter-rouge">__new __（）</code>，类继承元类，并在元类中使用<code class="language-plaintext highlighter-rouge">__call__()</code> 方法实现，装饰器实现；<li>There is no fucking magic, all the implementation are from CPython pyobjectclass;</ul></ul><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Singleton</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="n">__instance</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">print</span> <span class="sh">"</span><span class="s">metaclass __call__</span><span class="sh">"</span>
        <span class="k">if</span> <span class="n">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cls</span><span class="p">.</span><span class="n">__instance</span><span class="p">:</span>
            <span class="n">cls</span><span class="p">.</span><span class="n">__instance</span><span class="p">[</span><span class="n">cls</span><span class="p">]</span> <span class="o">=</span> <span class="nf">super</span><span class="p">(</span><span class="n">Singleton</span><span class="p">,</span> <span class="n">cls</span><span class="p">).</span><span class="nf">__call__</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">.</span><span class="n">__instance</span><span class="p">[</span><span class="n">cls</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">BasicSub</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">Singleton</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="sh">"</span><span class="s">__init__</span><span class="sh">"</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">BasicSub</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">print</span> <span class="sh">"</span><span class="s">__new__</span><span class="sh">"</span>
        <span class="n">self</span> <span class="o">=</span> <span class="nf">super</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">BasicSub</span><span class="p">).</span><span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">self</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="sh">"</span><span class="s">__call__</span><span class="sh">"</span>

<span class="n">a</span> <span class="o">=</span> <span class="nc">BasicSub</span><span class="p">()</span>
<span class="nf">a</span><span class="p">()</span>
</code></pre></div></div><h2 id="vii-高级第三方库的实现"> <a href="#vii-高级第三方库的实现" class="anchor-heading" aria-labelledby="vii-高级第三方库的实现"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> VII. 高级第三方库的实现</h2><h3 id="web框架"> <a href="#web框架" class="anchor-heading" aria-labelledby="web框架"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Web框架</h3><h3 id="并发框架"> <a href="#并发框架" class="anchor-heading" aria-labelledby="并发框架"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 并发框架</h3><ul><li>futures<li>Gevent<ul><li>基于C的高性能事件循环模型库libev，实现的基于API和网络相关任务的并发模型；</ul><li>greenlet</ul><h3 id="c实现的第三方库"> <a href="#c实现的第三方库" class="anchor-heading" aria-labelledby="c实现的第三方库"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> C实现的第三方库</h3><p>https://github.com/python/cpython/blob/master/Python/ceval.c</p><p>https://www.cnblogs.com/qdhxhz/p/9757390.html</p><p>https://redis.io/commands</p><p>openstack https://blog.csdn.net/dylloveyou/article/details/80698420</p><p>socket fd https://www.cnblogs.com/DengGao/p/file_symbol.html</p><p>mmap https://www.cnblogs.com/huxiao-tee/p/4660352.html</p><h2 id="viii"> <a href="#viii" class="anchor-heading" aria-labelledby="viii"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> VIII.</h2><h1 id="python-runtime-services"> <a href="#python-runtime-services" class="anchor-heading" aria-labelledby="python-runtime-services"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Python Runtime Services</h1><p><a href="https://docs.python.org/3/library/python.html">Runtime Services</a></p></main><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0">Engineering & Philosophy & Life Experience - A Motorcycle rider and loving husband.</p><div class="d-flex mt-2"></div></footer></div></div><div class="search-overlay"></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.6/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script>
