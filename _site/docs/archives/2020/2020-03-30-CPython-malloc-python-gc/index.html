<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"><link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"><style id="jtd-nav-activation"> .site-nav > ul.nav-list:first-child > li > a, .site-nav > ul.nav-list:first-child > li > ul > li > a, .site-nav > ul.nav-list:first-child > li > ul > li > ul > li:not(:nth-child(26)) > a { background-image: none; } .site-nav > ul.nav-list:not(:first-child) a, .site-nav li.external a { background-image: none; } .site-nav > ul.nav-list:first-child > li:nth-child(2) > ul > li:nth-child(3) > ul > li:nth-child(26) > a { font-weight: 600; text-decoration: none; }.site-nav > ul.nav-list:first-child > li:nth-child(2) > button svg, .site-nav > ul.nav-list:first-child > li:nth-child(2) > ul > li:nth-child(3) > button svg { transform: rotate(-90deg); }.site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(2) > ul.nav-list, .site-nav > ul.nav-list:first-child > li.nav-list-item:nth-child(2) > ul.nav-list > li.nav-list-item:nth-child(3) > ul.nav-list { display: block; }</style><script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon"><title>Python进程内存分析&amp;大量内存占用的优化方案 | Adam Yan Na Docs</title><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Python进程内存分析&amp;大量内存占用的优化方案" /><meta property="og:locale" content="en_US" /><meta name="description" content="Engineering &amp; Philosophy &amp; Life Experience" /><meta property="og:description" content="Engineering &amp; Philosophy &amp; Life Experience" /><link rel="canonical" href="http://localhost:4000/docs/archives/2020/2020-03-30-CPython-malloc-python-gc/" /><meta property="og:url" content="http://localhost:4000/docs/archives/2020/2020-03-30-CPython-malloc-python-gc/" /><meta property="og:site_name" content="Adam Yan Na Docs" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Python进程内存分析&amp;大量内存占用的优化方案" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Engineering &amp; Philosophy &amp; Life Experience","headline":"Python进程内存分析&amp;大量内存占用的优化方案","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/icon-512x512.png"}},"url":"http://localhost:4000/docs/archives/2020/2020-03-30-CPython-malloc-python-gc/"}</script><body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewBox="0 0 16 16"><title>Copy</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"><title>Copied</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg><div class="side-bar"><div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"><div class="site-logo" role="img" aria-label="Adam Yan Na Docs"></div></a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button></div><nav aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Archives category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/archives/" class="nav-list-link">Archives</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2018 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2018/2018/" class="nav-list-link">2018</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/archives/2018/2018-10-26-Algorithm-matrix/" class="nav-list-link">Algorithm Matrix</a><li class="nav-list-item"> <a href="/docs/archives/2018/2018-10-25-PostgreSQL/" class="nav-list-link">PostgreSQL fundamental and operation</a><li class="nav-list-item"> <a href="/docs/archives/2018/2018-10-23-Postgresql-pgpool/" class="nav-list-link">Postgresql HA & Loadblance - pgpool II</a><li class="nav-list-item"> <a href="/docs/archives/2018/2018-12-05-V2ray-Websocket-Nginx/" class="nav-list-link">V2ray Nginx 配置</a><li class="nav-list-item"> <a href="/docs/archives/2018/2018-12-05-Linux-Ulimit/" class="nav-list-link">通过 ulimit 改善系统性能</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2019 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2019/2019/" class="nav-list-link">2019</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/archives/2019/2019-02-20-RabbitMQ-pub-sub/" class="nav-list-link">RabbitMQ & AMQP</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2020 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2020/2020/" class="nav-list-link">2020</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/archives/2020/2020-09-22-roles-of-agile-team/" class="nav-list-link">Agile</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-02-18-Algorithm-Everything/" class="nav-list-link">Algorithm Everything</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-31-algorithm-heap/" class="nav-list-link">Algorithm-heap 堆排序的实现</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-14-ansible-automation/" class="nav-list-link">Ansible自动化</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-01-08-%5BBeginning-of-2020--Algorithm%5D/" class="nav-list-link">BeginningOf2020 - Algorithm</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-16-c-programming-language-recap/" class="nav-list-link">C programming language recap</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-10-c-cpp-syntactic-sugar/" class="nav-list-link">C/C++ Syntactic sugar 语法糖</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-13-cpython-implementation/" class="nav-list-link">CPython源代码分析&虚拟机原理</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-07-26-cloud-qualification/" class="nav-list-link">Cloud Qualification</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-13-redis_data_sampling/" class="nav-list-link">Data Sampling [Redis]</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-07-12-git-advanced/" class="nav-list-link">Git进阶</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-05-golang-performance-flame-graph/" class="nav-list-link">Golang性能分析和监控</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-20-select-poll-epoll/" class="nav-list-link">I/O的多路复用算法</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-03-kubernetes-curve/" class="nav-list-link">Kubernetes & Docker</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-13-linux-command-tools/" class="nav-list-link">Linux常用工具&内置命令</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-18-linux-networking/" class="nav-list-link">Linux网络基础</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-08-05-macos-configuration/" class="nav-list-link">MacOS Configure</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-14-monitor_system_restructure/" class="nav-list-link">Monitor System</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-02-Algorithm-curve/" class="nav-list-link">My Algorithm Curve</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-06-Prometheus/" class="nav-list-link">Prometheus</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-26-python-core/" class="nav-list-link">Python&CPython核心</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-25-python-memory-management-implementation/" class="nav-list-link">Python内存管理的底层实现&程序内存分析</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-24-Python-dynamic-map/" class="nav-list-link">Python实现动态生成类的http接口-monitor动态监控项</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-05-python-performance-flame-graph/" class="nav-list-link">Python性能分析和火焰图</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-14-python-service-deployment/" class="nav-list-link">Python服务容器化部署</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-30-CPython-malloc-python-gc/" class="nav-list-link">Python进程内存分析&大量内存占用的优化方案</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-14-redhat-6.5-python-dependency/" class="nav-list-link">Red Hat Enterprise Linux Kernel Version 2.6.32 3.8.13 python依赖环境手动部署</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-31-Redis/" class="nav-list-link">Redis学习及源码分析</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-01-08-%5BSum-of-2019--DataInfluxPatrol-Golang%5D/" class="nav-list-link">SumOf2019 - DataInfluxPatrol</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-09-man-signal/" class="nav-list-link">linux signal</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-13-pg-dead-lock/" class="nav-list-link">pg数据库过程事务执行的锁竞争导致锁表</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-01-01-cs-communication-physical-architecture/" class="nav-list-link">体系结构-树</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-18-tech-stack-planning-2020/" class="nav-list-link">技术栈提升规划 [2020]</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-05-13-data-patrol/" class="nav-list-link">时序数据完整性的方法巡检工具</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-12-core-knowledge/" class="nav-list-link">核心知识库</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-01-iter-massive-data-programming/" class="nav-list-link">海量数据程序设计思路</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-27-csapp/" class="nav-list-link">深入理解计算机系统 [Computer-Systems-A-Programmer's-Perspective]</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-20-operating-system/" class="nav-list-link">现代操作系统</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-25-pointer-reference-understanding/" class="nav-list-link">理解C/C++中的指针和引用</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-16-tcp-network-analysis/" class="nav-list-link">生产环境TCP网络问题分析</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-07-capsule/" class="nav-list-link">知识碎片</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-04-02-b-tree-and-indexing-principle/" class="nav-list-link">红黑树&B树应用及索引原理</a><li class="nav-list-item"> <a href="/docs/archives/2020/2020-03-16-network-curve/" class="nav-list-link">计算机网络</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2021 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2021/2021/" class="nav-list-link">2021</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/archives/2021/2021-02-15-mac-reset-smc-nvram/" class="nav-list-link">Mac Reset Smc Nvram</a><li class="nav-list-item"> <a href="/docs/archives/2021/2021-02-15-research-of-ergonomics/" class="nav-list-link">Research of Ergonomics</a><li class="nav-list-item"> <a href="/docs/archives/2021/2021-02-15-work-efficiency/" class="nav-list-link">Work Efficiency</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2022 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2022/2022/" class="nav-list-link">2022</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/archives/2022/2022-11-19-Criticism-of-Hegelianism/" class="nav-list-link">Criticism of Hegelianism</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in 2023 category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/archives/2023/2023/" class="nav-list-link">2023</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/archives/2023/2023-01-02-live_migration_precopy/" class="nav-list-link">Live Migration Precopy Analyze</a></ul></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Engineering category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/engineering/engineering/" class="nav-list-link">Engineering</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in I. Foundament category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/engineering/foundament/foundament/" class="nav-list-link">I. Foundament</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/engineering/foundament/algorithm/algorithm/" class="nav-list-link">1.1 Algorithm</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in II. System Design category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/engineering/system_design/system_design/" class="nav-list-link">II. System Design</a><ul class="nav-list"></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in III. Experience category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/engineering/experience/experience/" class="nav-list-link">III. Experience</a><ul class="nav-list"></ul><li class="nav-list-item"><a href="/docs/engineering/kickstart_and_recap_231112205754/" class="nav-list-link">Kickstart & Recap</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Jq category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/jq/jq/" class="nav-list-link">Jq</a><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Cloud Native Automation category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/jq/cloud_native_automation/cloud_native_automation/" class="nav-list-link">Cloud Native Automation</a><ul class="nav-list"><li class="nav-list-item"> <a href="/docs/jq/cloud_native_automation/python_automation/" class="nav-list-link">Python automation</a></ul></ul></ul><ul class="nav-list"><li class="nav-list-item external"> <a href="https://github.com/adamyanna" class="nav-list-link external" > Adam Yan Na GitHub <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a><li class="nav-list-item external"> <a href="https://www.linkedin.com/in/adam-yan-na" class="nav-list-link external" > Adam Yan Na Linkedin <svg viewBox="0 0 24 24" aria-labelledby="svg-external-link-title"><use xlink:href="#svg-external-link"></use></svg> </a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search" role="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Adam Yan Na Docs" aria-label="Search Adam Yan Na Docs" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="https://github.com/adamyanna" class="site-button" > Adam Yan Na GitHub </a><li class="aux-nav-list-item"> <a href="https://www.linkedin.com/in/adam-yan-na" class="site-button" > Adam Yan Na Linkedin </a></ul></nav></div><div class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="/docs/archives/archives/">Archives</a><li class="breadcrumb-nav-list-item"><a href="/docs/archives/2020/2020/">2020</a><li class="breadcrumb-nav-list-item"><span>Python进程内存分析&大量内存占用的优化方案</span></ol></nav><div id="main-content" class="main-content"><main><p class="label label-blue"><strong>GDB-gcc-debug</strong></p><p class="label label-green"><strong>jemalloc</strong></p><p class="label label-purple"><strong>ptmalloc2</strong></p><p class="label label-red"><strong>TCMalloc</strong></p><p class="label label-yellow"><strong>2020-03-29 10:00:00 +0800</strong></p><h1 id="python进程内存分析大量内存占用的优化方案"> <a href="#python进程内存分析大量内存占用的优化方案" class="anchor-heading" aria-labelledby="python进程内存分析大量内存占用的优化方案"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Python进程内存分析&amp;大量内存占用的优化方案</h1><h2 id="cpython预编译运行库"> <a href="#cpython预编译运行库" class="anchor-heading" aria-labelledby="cpython预编译运行库"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> CPython预编译运行库</h2><blockquote><ul><li>python-debuginfo-2.7.5-86.el7.x86_64<li>glibc-debuginfo-common-2.17-292.el7.x86_64<li>python-debuginfo-2.7.5-86.el7.x86_64</ul></blockquote><h1 id="monitor-server-内存分析大量内存占用的优化方案"> <a href="#monitor-server-内存分析大量内存占用的优化方案" class="anchor-heading" aria-labelledby="monitor-server-内存分析大量内存占用的优化方案"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> monitor-server 内存分析，大量内存占用的优化方案</h1><h1 id="1-当前程序状态"> <a href="#1-当前程序状态" class="anchor-heading" aria-labelledby="1-当前程序状态"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. 当前程序状态</h1><ul><li>物理机<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>417593 root      20   0 4325700 1.946g   6724 S   8.9  0.8 891:53.36 python
641599 root      20   0 4322988 1.922g   6748 S   3.0  0.8   1219:54 python
641904 root      20   0 4328792 1.968g   6748 S   3.0  0.8   1359:53 python
641963 root      20   0 4327696 1.930g   6748 S   2.0  0.8   1263:28 python
</code></pre></div></div><li>虚拟机<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>609083 root      20   0 4123852   1.5g   1660 S   2.3  9.5 109:47.85 python
643875 root      20   0 4262180   1.7g   1284 S   1.3 11.0  89:58.01 python
643877 root      20   0 4192588   1.6g   1440 S   1.3 10.6  86:33.74 python
671562 root      20   0 4253364   1.7g   1704 S   1.0 10.8  69:23.61 python   
</code></pre></div></div><li>运行时间在1000小时左右的进程<li>在裸金属中占用物理内存比例为0.8%，主机内存总大小为256GB，每个python进程占用大小为2GB左右<li>在虚拟机中占用的物理内存大小9%~ 11%，主机内存总大小16GB，每个python进程占用内存大小为2GB左右<li>同一LISTEN端口，TCP服务保持的TCP长链接对应Socket数量<ul><li>虚拟机：80左右<li>物理机：120 - 140左右</ul><li>因为在LVS转发配置<ul><li>虚拟机 权重 20 单个进程的权重 20/10<li>物理机 权重 100 单个进程的权重 100/30</ul></ul><h1 id="2-server对交付报文的处理"> <a href="#2-server对交付报文的处理" class="anchor-heading" aria-labelledby="2-server对交付报文的处理"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. server对交付报文的处理</h1><ul><li><p>server处理HTTP报文的有效载荷数据大小为数bk到数百kb，服务器使用I/O多路复用，借助select(此处使用了linux的epoll)函数检查事件输入，进程通过监听描述符创建了80到140个连接描述符，并将数据交付给multiprocessing线程池中25个线程中空闲的线程，在文件的读写过程中，server的动态监控及接口监控等数据处理有一定复杂度的函数，会产生大量的数据拷贝和引用，并会创建很多对象（datamodel等）；</p><li>python的垃圾回收发生的条件<blockquote><p>https://docs.python.org/2/library/gc.html 官方文档：The GC classifies objects into three generations depending on how many collection sweeps they have survived. New objects are placed in the youngest generation (generation 0). If an object survives a collection it is moved into the next older generation. Since generation 2 is the oldest generation, objects in that generation remain there after a collection. In order to decide when to run, the collector keeps track of the number object allocations and deallocations since the last collection. When the number of allocations minus the number of deallocations exceeds threshold0, collection starts. Initially only generation 0 is examined. If generation 0 has been examined more than threshold1 times since generation 1 has been examined, then generation 1 is examined as well. Similarly, threshold2 controls the number of collections of generation 1 before collecting generation 2.</p></blockquote><li>python内存管理的三层结构<ul><li>generation 0：新建的对象<li>generation 1：垃圾回收后，任然存在引用，则归入1<li>generation 2：最老的无法被collection函数回收的对象</ul><li>回收机制会在内存分配数量和取消分配数量的差值超过 一个特定的阈值 才会触发<li>通过gc模块，可以查看默认的阈值，且可以通过调用set_threshold函数，配置定制的阈值<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">gc</span>
<span class="n">gc</span><span class="p">.</span><span class="nf">get_threshold</span><span class="p">()</span><span class="err">　　</span><span class="c1">#gc模块中查看阈值的方法
</span><span class="p">(</span><span class="mi">700</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</code></pre></div></div><li>这里的解释是：阈值超过700时才会对g0的对象进行回收，每10次回收g0会发生1次回收g1，每10次回收g1会发生1次回收g2；<li>gc模块提供主动触发垃圾回收的函数<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="n">generation</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="nf">collect</span><span class="p">([</span><span class="n">generation</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">n</span>
</code></pre></div></div></ul><blockquote><p>With no arguments, run a full collection. The optional argument may be an integer specifying which generation to collect. A ValueError is raised if the generation number is invalid.</p></blockquote><ul><li>对于不传入参数的调用来说，会发起g0 g1 g2三代的全部的回收；<li>CPython对C运行库提供的free函数的调用，也存在一定的条件<ul><li>第3层：最上层，用户对Python对象的直接操作<li>第1层和第2层：内存池，有Python的接口函数PyMem_Malloc实现-----若请求分配的内存在1~256字节之间就使用内存池管理系统进行分配，调用malloc函数分配内存，但是每次只会分配一块大小为256K的大块内存，不会调用free函数释放内存，将该内存块留在内存池中以便下次使用。<li>第0层：大内存-----若请求分配的内存大于256K，malloc函数分配内存，free函数释放内存；</ul></ul><h1 id="3-动手操作问题定位"> <a href="#3-动手操作问题定位" class="anchor-heading" aria-labelledby="3-动手操作问题定位"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. 动手操作，问题定位</h1><h2 id="中断运行的程序输出无法回收的对象"> <a href="#中断运行的程序输出无法回收的对象" class="anchor-heading" aria-labelledby="中断运行的程序输出无法回收的对象"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 中断运行的程序，输出无法回收的对象</h2><blockquote><p>A list of objects which the collector found to be unreachable but could not be freed (uncollectable objects). By default, this list contains only objects with <strong>del</strong>() methods. 1 Objects that have <strong>del</strong>() methods and are part of a reference cycle cause the entire reference cycle to be uncollectable, including objects not necessarily in the cycle but reachable only from it. Python doesn’t collect such cycles automatically because, in general, it isn’t possible for Python to guess a safe order in which to run the <strong>del</strong>() methods. If you know a safe order, you can force the issue by examining the garbage list, and explicitly breaking cycles due to your objects within the list. Note that these objects are kept alive even so by virtue of being in the garbage list, so they should be removed from garbage too. For example, after breaking cycles, do del gc.garbage[:] to empty the list. It’s generally better to avoid the issue by not creating cycles containing objects with <strong>del</strong>() methods, and garbage can be examined in that case to verify that no such cycles are being created.</p></blockquote><ul><li>pip install pyrasite<li>pip show pyrasite</ul><blockquote><p>Name: pyrasite Version: 2.0 Summary: Inject code into a running Python process Home-page: http://pyrasite.com Author: Luke Macken</p></blockquote><ul><li>安装pyrasite工具，该工具可以中断正在运行的进程，并对进程进行注入和检查<li><p>pyrasite-shell<pid>， 接下来就可以在<pid>的进程里调用任意的python代码, 来查看进程的状态.</pid></pid></p><li>guppy 取得内存使用的各种对象占用情况，guppy 可以用来打印出各种对象各占用多少空间, 如果python进程中有没有释放的对象, 造成内存占用升高, 通过guppy可以查看出来:<li>pip install guppy<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pyrasite</span><span class="o">-</span><span class="n">shell</span> <span class="o">&lt;</span><span class="n">pid</span><span class="o">&gt;</span>
<span class="kn">from</span> <span class="n">guppy</span> <span class="kn">import</span> <span class="n">hpy</span>
<span class="n">h</span> <span class="o">=</span> <span class="nf">hpy</span><span class="p">()</span>
<span class="n">h</span><span class="p">.</span><span class="nf">heap</span><span class="p">()</span>
</code></pre></div></div><li>运行此命令报错，暂时未定位原因，h.heap可以查看当前进程堆的内存分配情况，例如各种类型的对象占用的内存长度；<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Partition of a set of 48477 objects. Total size = 3265516 bytes.
#  Index  Count   %     Size   % Cumulative  % Kind (class / dict of class)
#      0  25773  53  1612820  49   1612820  49 str
#      1  11699  24   483960  15   2096780  64 tuple
#      2    174   0   241584   7   2338364  72 dict of module
#      3   3478   7   222592   7   2560956  78 types.CodeType
#      4   3296   7   184576   6   2745532  84 function
#      5    401   1   175112   5   2920644  89 dict of class
#      6    108   0    81888   3   3002532  92 dict (no owner)
#      7    114   0    79632   2   3082164  94 dict of type
#      8    117   0    51336   2   3133500  96 type
#      9    667   1    24012   1   3157512  97 __builtin__.wrapper_descriptor
# &lt;76 more rows. Type e.g. '_.more' to view.&gt;
h.iso(1,[],{})
# Partition of a set of 3 objects. Total size = 176 bytes.
#  Index  Count   %     Size   % Cumulative  % Kind (class / dict of class)
#      0      1  33      136  77       136  77 dict (no owner)
#      1      1  33       28  16       164  93 list
#      2      1  33       12   7       176 100 int
</code></pre></div></div><li>无法回收的对象<li>python垃圾回收, 对象无法被垃圾回收(uncollectable object), 满足2个条件:<ol><li>循环引用<li>循环引用的链上某个对象定义了__del__方法, 循环引用的一组对象被gc模块识别为可回收的, 但需要先调用每个对象上的__del__方法, 才能回收. 但用户自定义了__del__的对象, gc系统不知道应该先调用环上的哪个__del__. 因此无法回收这类对象.</ol><li>不能回收的python对象会持续占据内存<li>查找uncollectable的对象:<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pyrasite</span><span class="o">-</span><span class="n">shell</span> <span class="p">{</span><span class="n">PID</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="n">gc</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">gc</span><span class="p">.</span><span class="nf">collect</span><span class="p">()</span> <span class="c1"># first run gc, find out uncollectable object and put them in gc.garbage
</span>           <span class="c1"># output number of object collected
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">gc</span><span class="p">.</span><span class="n">garbage</span>   <span class="c1"># print all uncollectable objects
</span><span class="o">&gt;&gt;&gt;</span> <span class="p">[]</span>               <span class="c1"># empty
</span></code></pre></div></div><blockquote><p>如果在上面最后一步打印出了任何不能回收的对象, 则需要进一步查找循环引用链上在哪个对象上包含__del__方法.</p></blockquote><li><p>gdb查看python线程执行上下文及调用栈</p><li>安装python的debuginfo及gcc的debuginfo<li>gdb python {PID}<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>gdb<span class="o">)</span> info threads
Id   Target Id         Frame 
 36   Thread 0x7f4b2bbad740 <span class="o">(</span>LWP 404510<span class="o">)</span> 0x00007f4b2a9e1e63 <span class="k">in </span>epoll_wait <span class="o">()</span> at ../sysdeps/unix/syscall-template.S:81
 35   Thread 0x7f4a7bb7a700 <span class="o">(</span>LWP 412337<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a58000910<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 34   Thread 0x7f4a7c37b700 <span class="o">(</span>LWP 412248<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a54000b30<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 33   Thread 0x7f4a7cb7c700 <span class="o">(</span>LWP 410227<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a5c000b30<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 32   Thread 0x7f4a7d37d700 <span class="o">(</span>LWP 409187<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a6826fa50<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 31   Thread 0x7f4a7dc3e700 <span class="o">(</span>LWP 408137<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a70003470<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 30   Thread 0x7f4a7e43f700 <span class="o">(</span>LWP 406936<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a6c33ccc0<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 29   Thread 0x7f4a8effd700 <span class="o">(</span>LWP 405827<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a74811da0<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 28   Thread 0x7f4a8f7fe700 <span class="o">(</span>LWP 404586<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a80001b90<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
 27   Thread 0x7f4a8ffff700 <span class="o">(</span>LWP 404585<span class="o">)</span> 0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a88002620<span class="o">)</span>
 ...
<span class="o">(</span>gdb<span class="o">)</span> thread 24
<span class="o">[</span>Switching to thread 24 <span class="o">(</span>Thread 0x7f4aadffb700 <span class="o">(</span>LWP 404582<span class="o">))]</span>
<span class="c">#0  0x00007f4b2b3c7afb in futex_abstimed_wait (cancel=true, private=&lt;optimized out&gt;, abstime=0x0, expected=0, futex=0x7f4a9c002050)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
43            err <span class="o">=</span> lll_futex_wait <span class="o">(</span>futex, expected, private<span class="o">)</span><span class="p">;</span>
<span class="o">(</span>gdb<span class="o">)</span> py-list
334            waiter.acquire<span class="o">()</span>
335            self.__waiters.append<span class="o">(</span>waiter<span class="o">)</span>
336            saved_state <span class="o">=</span> self._release_save<span class="o">()</span>
337            try:    <span class="c"># restore state no matter what (e.g., KeyboardInterrupt)</span>
338                <span class="k">if </span><span class="nb">timeout </span>is None:
<span class="o">&gt;</span>339                    waiter.acquire<span class="o">()</span>
340                    <span class="k">if </span>__debug__:
341                        self._note<span class="o">(</span><span class="s2">"%s.wait(): got it"</span>, self<span class="o">)</span>
342                <span class="k">else</span>:
343                    <span class="c"># Balancing act:  We can't afford a pure busy loop, so we</span>
344                    <span class="c"># have to sleep; but if we sleep the whole timeout time,</span>
<span class="o">(</span>gdb<span class="o">)</span> 
</code></pre></div></div><li><p>看到大量的线程处于 futex_abstimed_wait 状态，使用py-list查看代码后，发现当前该线程的ioloop处于等待状态，结合htop或者top命令，可以看到当前进程的25个线程大多数线程处于等待调度状态（饥饿状态），分析为server扩容后，单个进程的负载很大程度下降，导致对80~140个范围内的已连接FD不需要频繁的线程上下文切换即可完成处理；</p><li>使用gcc debug 可以查看当前CPython的调用栈<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x00007f4b2b3c7afb <span class="k">in </span>futex_abstimed_wait <span class="o">(</span><span class="nv">cancel</span><span class="o">=</span><span class="nb">true</span>, <span class="nv">private</span><span class="o">=</span>&lt;optimized out&gt;, <span class="nv">abstime</span><span class="o">=</span>0x0, <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">futex</span><span class="o">=</span>0x7f4a9c002050<span class="o">)</span>
 at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:43
<span class="c">#1  do_futex_wait (sem=sem@entry=0x7f4a9c002050, abstime=0x0) at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:223</span>
<span class="c">#2  0x00007f4b2b3c7b8f in __new_sem_wait_slow (sem=0x7f4a9c002050, abstime=0x0) at ../nptl/sysdeps/unix/sysv/linux/sem_waitcommon.c:292</span>
<span class="c">#3  0x00007f4b2b3c7c2b in __new_sem_wait (sem=&lt;optimized out&gt;) at ../nptl/sysdeps/unix/sysv/linux/sem_wait.c:28</span>
<span class="c">#4  0x00007f4b2b6e7795 in PyThread_acquire_lock (lock=0x7f4a9c002050, waitflag=1) at /usr/src/debug/Python-2.7.5/Python/thread_pthread.h:323</span>
<span class="c">#5  0x00007f4b2b6eb482 in lock_PyThread_acquire_lock (self=0x7f4b1862a930, args=&lt;optimized out&gt;) at /usr/src/debug/Python-2.7.5/Modules/threadmodule.c:52</span>
<span class="c">#6  0x00007f4b2b6bad40 in call_function (oparg=&lt;optimized out&gt;, pp_stack=0x7f4aadffa060) at /usr/src/debug/Python-2.7.5/Python/ceval.c:4408</span>
<span class="c">#7  PyEval_EvalFrameEx (</span>
 <span class="nv">f</span><span class="o">=</span>f@entry<span class="o">=</span>Frame 0x7f4af4026420, <span class="k">for </span>file /usr/lib64/python2.7/threading.py, line 339, <span class="k">in </span><span class="nb">wait</span> <span class="o">(</span><span class="nv">self</span><span class="o">=</span>&lt;_Condition<span class="o">(</span><span class="nv">_Verbose__verbose</span><span class="o">=</span>False, <span class="nv">_Condition__lock</span><span class="o">=</span>&lt;thread.lock at remote 0x7f4b18756f30&gt;, <span class="nv">acquire</span><span class="o">=</span>&lt;built-in method acquire of thread.lock object at remote 0x7f4b18756f30&gt;, <span class="nv">_Condition__waiters</span><span class="o">=[</span>&lt;thread.lock at remote 0x7f4b1862a3f0&gt;, &lt;thread.lock at remote 0x7f4b10aab750&gt;, &lt;thread.lock at remote 0x7f4b1862adb0&gt;, &lt;thread.lock at remote 0x7f4b1862ab10&gt;, &lt;thread.lock at remote 0x7f4b1862ae50&gt;, &lt;thread.lock at remote 0x7f4b1862abd0&gt;, &lt;thread.lock at remote 0x7f4b1862a4d0&gt;, &lt;thread.lock at remote 0x7f4b1862a930&gt;, &lt;thread.lock at remote 0x7f4b1862a8b0&gt;, &lt;thread.lock at remote 0x7f4b1862ae70&gt;, &lt;thread.lock at remote 0x7f4b1862a530&gt;, &lt;thread.lock at remote 0x7f4b1862ab90&gt;, &lt;thread.lock at remote 0x7f4b1862a8d0&gt;, &lt;thread.lock at remote 0x7f4b1862a9d0&gt;, &lt;thread.lock at remote 0x7f4b1862a150&gt;, &lt;thread.lock at remote 0x7f4b1862a290&gt;, &lt;thread.lock at remote 0x7f4b1862aad0&gt;, &lt;thread.lock at remote 0x7f4b1862ad30&gt;, &lt;thread.lock at r...<span class="o">(</span>truncated<span class="o">)</span>, <span class="nv">throwflag</span><span class="o">=</span>throwflag@entry<span class="o">=</span>0<span class="o">)</span>
 at /usr/src/debug/Python-2.7.5/Python/ceval.c:3040
<span class="c">#8  0x00007f4b2b6bd08d in PyEval_EvalCodeEx (co=&lt;optimized out&gt;, globals=&lt;optimized out&gt;, locals=locals@entry=0x0, args=&lt;optimized out&gt;, argcount=1, kws=0x7f4aa800cd30, kwcount=0, </span>
 <span class="nv">defs</span><span class="o">=</span>0x7f4b1fe30188, <span class="nv">defcount</span><span class="o">=</span>2, <span class="nv">closure</span><span class="o">=</span>closure@entry<span class="o">=</span>0x0<span class="o">)</span> at /usr/src/debug/Python-2.7.5/Python/ceval.c:3640
<span class="c">#9  0x00007f4b2b6ba58c in fast_function (nk=&lt;optimized out&gt;, na=&lt;optimized out&gt;, n=&lt;optimized out&gt;, pp_stack=0x7f4aadffa270, func=&lt;optimized out&gt;)</span>
 at /usr/src/debug/Python-2.7.5/Python/ceval.c:4504
<span class="c">#10 call_function (oparg=&lt;optimized out&gt;, pp_stack=0x7f4aadffa270) at /usr/src/debug/Python-2.7.5/Python/ceval.c:4429</span>
<span class="c">#11 PyEval_EvalFrameEx (</span>
 <span class="nv">f</span><span class="o">=</span>f@entry<span class="o">=</span>Frame 0x7f4aa800cb80, <span class="k">for </span>file /usr/lib64/python2.7/Queue.py, line 168, <span class="k">in </span>get <span class="o">(</span><span class="nv">self</span><span class="o">=</span>&lt;Queue<span class="o">(</span><span class="nv">unfinished_tasks</span><span class="o">=</span>47882, <span class="nv">queue</span><span class="o">=</span>&lt;collections.deque at remote 0x7f4b0fed62f0&gt;, <span class="nv">maxsize</span><span class="o">=</span>0, <span class="nv">all_tasks_done</span><span class="o">=</span>&lt;_Condition<span class="o">(</span><span class="nv">_Verbose__verbose</span><span class="o">=</span>False, <span class="nv">_Condition__lock</span><span class="o">=</span>&lt;thread.lock at remote 0x7f4b18756f30&gt;, <span class="nv">acquire</span><span class="o">=</span>&lt;built-in method acquire of thread.lock object at remote 0x7f4b18756f30&gt;, <span class="nv">_Condition__waiters</span><span class="o">=[]</span>, <span class="nv">release</span><span class="o">=</span>&lt;built-in method release of thread.lock object at remote 0x7f4b18756f30&gt;<span class="o">)</span> at remote 0x7f4b177ab710&gt;, <span class="nv">mutex</span><span class="o">=</span>&lt;thread.lock at remote 0x7f4b18756f30&gt;, <span class="nv">not_full</span><span class="o">=</span>&lt;_Condition<span class="o">(</span><span class="nv">_Verbose__verbose</span><span class="o">=</span>False, <span class="nv">_Condition__lock</span><span class="o">=</span>&lt;thread.lock at remote 0x7f4b18756f30&gt;, <span class="nv">acquire</span><span class="o">=</span>&lt;built-in method acquire of thread.lock object at remote 0x7f4b18756f30&gt;, <span class="nv">_Condition__waiters</span><span class="o">=[]</span>, <span class="nv">release</span><span class="o">=</span>&lt;built-in method release of thread.lock object at remote 0x7f4b18756f30&gt;<span class="o">)</span> at remote 0x7f4b177ab790&gt;, <span class="nv">not_empty</span><span class="o">=</span>&lt;_Condition<span class="o">(</span><span class="nv">_Verbose__verbose</span><span class="o">=</span>False, <span class="nv">_Condition__lock</span><span class="o">=</span>&lt;thread.lock at remote 0x7f4b18756f30&gt;, <span class="nv">acquire</span><span class="o">=</span>&lt;built-in method acquire of thread.lock objec...<span class="o">(</span>truncated<span class="o">)</span>, <span class="nv">throwflag</span><span class="o">=</span>throwflag@entry<span class="o">=</span>0<span class="o">)</span>
 at /usr/src/debug/Python-2.7.5/Python/ceval.c:3040
<span class="c">#12 0x00007f4b2b6bd08d in PyEval_EvalCodeEx (co=&lt;optimized out&gt;, globals=&lt;optimized out&gt;, locals=locals@entry=0x0, args=&lt;optimized out&gt;, argcount=1, kws=0x7f4a9c000d58, kwcount=0, </span>
 <span class="nv">defs</span><span class="o">=</span>0x7f4b1f725800, <span class="nv">defcount</span><span class="o">=</span>2, <span class="nv">closure</span><span class="o">=</span>closure@entry<span class="o">=</span>0x0<span class="o">)</span> at /usr/src/debug/Python-2.7.5/Python/ceval.c:3640
<span class="c">#13 0x00007f4b2b6ba58c in fast_function (nk=&lt;optimized out&gt;, na=&lt;optimized out&gt;, n=&lt;optimized out&gt;, pp_stack=0x7f4aadffa480, func=&lt;optimized out&gt;)</span>
 at /usr/src/debug/Python-2.7.5/Python/ceval.c:4504
<span class="c">#14 call_function (oparg=&lt;optimized out&gt;, pp_stack=0x7f4aadffa480) at /usr/src/debug/Python-2.7.5/Python/ceval.c:4429</span>
</code></pre></div></div><li>通过调用栈可以看到，频繁出现的线程等待的信号量<code class="language-plaintext highlighter-rouge">/linux/sem_waitcommon.c</code><li>如果发现某个线程有问题, 切换到那个线程上, 查看调用栈确定具体的执行步骤, 使用bt 命令:<li>py-bt显示出python源码的调用栈, 调用参数, 以及所在行的代码.<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#4 Waiting for a lock (e.g. GIL)</span>
<span class="c">#5 Waiting for a lock (e.g. GIL)</span>
<span class="c">#7 Frame 0x7f4af4026420, for file /usr/lib64/python2.7/threading.py, line 339, in wait (self=&lt;_Condition(_Verbose__verbose=False, _Condition__lock=&lt;thread.lock at remote 0x7f4b18756f30&gt;, acquire=&lt;built-in method acquire of thread.lock object at remote 0x7f4b18756f30&gt;, _Condition__waiters=[&lt;thread.lock at remote 0x7f4b1862a3f0&gt;, &lt;thread.lock at remote 0x7f4b10aab750&gt;, &lt;thread.lock at remote 0x7f4b1862adb0&gt;, &lt;thread.lock at remote 0x7f4b1862ab10&gt;, &lt;thread.lock at remote 0x7f4b1862ae50&gt;, &lt;thread.lock at remote 0x7f4b1862abd0&gt;, &lt;thread.lock at remote 0x7f4b1862a4d0&gt;, &lt;thread.lock at remote 0x7f4b1862a930&gt;, &lt;thread.lock at remote 0x7f4b1862a8b0&gt;, &lt;thread.lock at remote 0x7f4b1862ae70&gt;, &lt;thread.lock at remote 0x7f4b1862a530&gt;, &lt;thread.lock at remote 0x7f4b1862ab90&gt;, &lt;thread.lock at remote 0x7f4b1862a8d0&gt;, &lt;thread.lock at remote 0x7f4b1862a9d0&gt;, &lt;thread.lock at remote 0x7f4b1862a150&gt;, &lt;thread.lock at remote 0x7f4b1862a290&gt;, &lt;thread.lock at remote 0x7f4b1862aad0&gt;, &lt;thread.lock at remote 0x7f4b1862ad30&gt;, &lt;thread.lock at r...(truncated)</span>
</code></pre></div></div></ul><blockquote><p>coredump 如果要进行比较长时间的跟踪, 最好将python程序的进程信息全部coredump出来, 之后对core文件进行分析, 避免影响正在运行的程序. (gdb) generate-core-file 这条命令将当前gdb attach的程序dump到它的运行目录, 名字为core.<pid>, 然后再用gdb 加载这个core文件, 进行打印堆栈, 查看变量等分析, 无需attach到正在运行的程序:</pid></p><p>gdb python core.<pid></pid></p></blockquote><blockquote><p>其他命令 其他命令可以在gdb输入py<TAB><TAB> 看到, 和gdb的命令对应, 例如: (gdb) py py-bt py-list py-print python py-down py-locals py-up python-interactive py-up, py-down 可以用来移动到python调用站的上一个或下一个frame. py-locals 用来打印局部变量 等等等等. gdb里也可以用help命令查看帮助:</TAB></TAB></p></blockquote><blockquote><p>(gdb) help py-print Look up the given python variable name, and print it 在这次追踪过程中, 用gdb-python排除了程序逻辑问题. 然后继续追踪内存泄漏问题:</p></blockquote><ul><li>可以结合mmap，及x\命令查看内存地址和程序计数器寄存器的情况</ul><blockquote><p>参考文档 https://github.com/lmacken/pyrasite https://docs.python.org/2/library/gc.html https://www.cnblogs.com/geaozhang/p/7111961.html http://man7.org/linux/man-pages/man7/epoll.7.html https://linux.die.net/man/4/epoll https://blog.csdn.net/ljx0305/article/details/4065058 https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html#不可回收对象的例子- https://blog.csdn.net/evsqiezi/article/details/8061176 https://github.com/torvalds/linux/blob/master/net/ipv4/tcp.c https://juejin.im/post/5cfdd44a6fb9a07eb67d83e9 https://blog.csdn.net/haoel/article/details/1602108 https://mg.pov.lt/objgraph/ http://guppy-pe.sourceforge.net/ http://guppy-pe.sourceforge.net/heapy_tutorial.html https://www.cnblogs.com/chengliangsheng/p/3597010.html https://blog.csdn.net/gogoytgo/article/details/64130179</p></blockquote><blockquote><p>https://github.com/google/tcmalloc https://github.com/jemalloc/jemalloc https://blog.csdn.net/junlon2006/article/details/77854898</p></blockquote><h1 id="4-内存占用分析"> <a href="#4-内存占用分析" class="anchor-heading" aria-labelledby="4-内存占用分析"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4. 内存占用分析</h1><ul><li>针对monitor-server的情况<ol><li>进程启动后，创建到权重占比的已连接描述符后（例如2的权重占总连接的80个左右，3.3占130左右），物理内存占用值会稳定到一个确定值，不会一直上涨，所有初步判断并没有循环引用或者内存泄漏；<li>在测试环境中，给动态监控的逻辑部分在请求处理完成返回前，做一次全generation的主动垃圾回收，程序启动后，物理内存的占用会有一定的下降，表现为在几个小时呢从700MB到1.5GB之间；</ol><li><p>初步结论，内存无泄漏且无对象的循环引用，主动的gc回收或者降低阈值并增加垃圾回收的频率，会一定程度的降低进程的物理内存的占用，大概可以下降测试前的20%~30%;</p><li>考虑C底层预编译的运行库的内存管理算法<li>生产环境的CentOS7.x 64默认提供的C运行库glibc的版本为2.17，其中malloc库的为ptmalloc2<li>Google提供的替代品：<li>TCMalloc is Google’s customized implementation of C’s malloc() and C++’s operator new used for memory allocation within our C and C++ code. TCMalloc is a fast, multi-threaded malloc implementation.<li>https://github.com/google/tcmalloc<li>FaceBook提供的替代品：<li>jemalloc is a general purpose malloc(3) implementation that emphasizes fragmentation avoidance and scalable concurrency support.<li>https://github.com/jemalloc/jemalloc<li><p>https://www.facebook.com/jemalloc</p><li>生产环境网络进过yum search后，找到了jemalloc X86_64的版本，而且可以直接yum安装，无需再次下载和编译；</ul><h1 id="5-最终方案测试"> <a href="#5-最终方案测试" class="anchor-heading" aria-labelledby="5-最终方案测试"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 5. 最终方案测试</h1><ul><li><p>在测试环境中，给动态监控的逻辑部分在请求处理完成返回前，做一次全generation的主动垃圾回收；</p><li>使用LD_PRELOAD，可以直接用jemalloc代替ptmalloc2，对python代码进行链接执行<li>测试方式<li>LD_PRELOAD=”/usr/lib64/libjemalloc.so” /home/monitor_server/bin/python /opt/netmon/service/monitor-server/monitor/run_server.py –config-file /opt/netmon/service/monitor-server/monitor/conf/conf.ini –port 51035 » /var/log/monitor-server/server_debug.log 2&gt;&amp;1 &amp;<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> root      76913  76489 20 15:36 pts/1    01:17:10 /home/monitor_server/bin/python /opt/netmon/debug/monitor-server/monitor/run_server.py <span class="nt">--config-file</span> /opt/netmon/debug/monitor-server/monitor/conf/conf.ini <span class="nt">--port</span> 51035
 VmRSS:    522232 kB
  76913 root       20   0 1991M  518M  6736 R 113.  0.2  1h17:15 │        └─ python /opt/netmon/debug/monitor-server/monitor/run_server.py <span class="nt">--config-file</span> /opt/netmon/debug/monitor-serve
</code></pre></div></div><li><p>最终表现</p><li>稳定运行15小时的server进行内存占用率维持在0.2%，物理内存的占用为500MB（上下不超过50MB），且添加了主动GC回收后，对单个逻辑核心的5分钟平均占用在50%（估计值）</ul><h1 id="6-文档"> <a href="#6-文档" class="anchor-heading" aria-labelledby="6-文档"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 6. 文档</h1><p><a href="http://ithare.com/testing-memory-allocators-ptmalloc2-tcmalloc-hoard-jemalloc-while-trying-to-simulate-real-world-loads/">第三方模拟真实应用的算法测试-ptmalloc2-tcmalloc-hoard-jemalloc</a> <a href="https://segmentfault.com/a/1190000003063859">I/O多路复用技术的简单介绍</a> <a href=""></a> <a href=""></a> <a href=""></a></p></main><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0">Engineering & Philosophy & Life Experience - A Motorcycle rider and loving husband.</p><div class="d-flex mt-2"></div></footer></div></div><div class="search-overlay"></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.6/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script>
